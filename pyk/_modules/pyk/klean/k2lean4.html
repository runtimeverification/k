

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pyk.klean.k2lean4 &mdash; pyk 7.1.301 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=6b5438ee"></script>
      <script src="../../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            pyk
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/modules.html">pyk</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">pyk</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pyk.klean.k2lean4</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pyk.klean.k2lean4</h1><div class="highlight"><pre>
<span></span><span class="linenos">   1</span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
<span class="linenos">   2</span>
<span class="linenos">   3</span><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="linenos">   4</span><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="linenos">   5</span><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="linenos">   6</span><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">cached_property</span>
<span class="linenos">   7</span><span class="kn">from</span><span class="w"> </span><span class="nn">graphlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">TopologicalSorter</span>
<span class="linenos">   8</span><span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">count</span>
<span class="linenos">   9</span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">NamedTuple</span><span class="p">,</span> <span class="n">TypedDict</span>
<span class="linenos">  10</span>
<span class="linenos">  11</span><span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
<span class="linenos">  12</span>
<span class="linenos">  13</span><span class="kn">from</span><span class="w"> </span><span class="nn">..dequote</span><span class="w"> </span><span class="kn">import</span> <span class="n">bytes_encode</span>
<span class="linenos">  14</span><span class="kn">from</span><span class="w"> </span><span class="nn">..konvert</span><span class="w"> </span><span class="kn">import</span> <span class="n">unmunge</span>
<span class="linenos">  15</span><span class="kn">from</span><span class="w"> </span><span class="nn">..kore.internal</span><span class="w"> </span><span class="kn">import</span> <span class="n">CollectionKind</span>
<span class="linenos">  16</span><span class="kn">from</span><span class="w"> </span><span class="nn">..kore.kompiled</span><span class="w"> </span><span class="kn">import</span> <span class="n">KoreSymbolTable</span>
<span class="linenos">  17</span><span class="kn">from</span><span class="w"> </span><span class="nn">..kore.manip</span><span class="w"> </span><span class="kn">import</span> <span class="n">collect_symbols</span><span class="p">,</span> <span class="n">elim_aliases</span><span class="p">,</span> <span class="n">free_occs</span>
<span class="linenos">  18</span><span class="kn">from</span><span class="w"> </span><span class="nn">..kore.syntax</span><span class="w"> </span><span class="kn">import</span> <span class="n">DV</span><span class="p">,</span> <span class="n">And</span><span class="p">,</span> <span class="n">App</span><span class="p">,</span> <span class="n">EVar</span><span class="p">,</span> <span class="n">SortApp</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Top</span>
<span class="linenos">  19</span><span class="kn">from</span><span class="w"> </span><span class="nn">..utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">FrozenDict</span><span class="p">,</span> <span class="n">POSet</span>
<span class="linenos">  20</span><span class="kn">from</span><span class="w"> </span><span class="nn">.model</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<span class="linenos">  21</span>    <span class="n">Alt</span><span class="p">,</span>
<span class="linenos">  22</span>    <span class="n">AltsFieldVal</span><span class="p">,</span>
<span class="linenos">  23</span>    <span class="n">AltsVal</span><span class="p">,</span>
<span class="linenos">  24</span>    <span class="n">Axiom</span><span class="p">,</span>
<span class="linenos">  25</span>    <span class="n">Ctor</span><span class="p">,</span>
<span class="linenos">  26</span>    <span class="n">Definition</span><span class="p">,</span>
<span class="linenos">  27</span>    <span class="n">ExplBinder</span><span class="p">,</span>
<span class="linenos">  28</span>    <span class="n">ImplBinder</span><span class="p">,</span>
<span class="linenos">  29</span>    <span class="n">Inductive</span><span class="p">,</span>
<span class="linenos">  30</span>    <span class="n">Instance</span><span class="p">,</span>
<span class="linenos">  31</span>    <span class="n">InstField</span><span class="p">,</span>
<span class="linenos">  32</span>    <span class="n">Modifiers</span><span class="p">,</span>
<span class="linenos">  33</span>    <span class="n">Module</span><span class="p">,</span>
<span class="linenos">  34</span>    <span class="n">Mutual</span><span class="p">,</span>
<span class="linenos">  35</span>    <span class="n">Signature</span><span class="p">,</span>
<span class="linenos">  36</span>    <span class="n">SimpleFieldVal</span><span class="p">,</span>
<span class="linenos">  37</span>    <span class="n">SimpleVal</span><span class="p">,</span>
<span class="linenos">  38</span>    <span class="n">StructCtor</span><span class="p">,</span>
<span class="linenos">  39</span>    <span class="n">Structure</span><span class="p">,</span>
<span class="linenos">  40</span>    <span class="n">StructVal</span><span class="p">,</span>
<span class="linenos">  41</span>    <span class="n">Term</span><span class="p">,</span>
<span class="linenos">  42</span><span class="p">)</span>
<span class="linenos">  43</span>
<span class="linenos">  44</span><span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
<span class="linenos">  45</span>    <span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Collection</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">Mapping</span>
<span class="linenos">  46</span>    <span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Final</span>
<span class="linenos">  47</span>
<span class="linenos">  48</span>    <span class="kn">from</span><span class="w"> </span><span class="nn">..kore.internal</span><span class="w"> </span><span class="kn">import</span> <span class="n">KoreDefn</span>
<span class="linenos">  49</span>    <span class="kn">from</span><span class="w"> </span><span class="nn">..kore.rule</span><span class="w"> </span><span class="kn">import</span> <span class="n">FunctionRule</span><span class="p">,</span> <span class="n">RewriteRule</span><span class="p">,</span> <span class="n">Rule</span>
<span class="linenos">  50</span>    <span class="kn">from</span><span class="w"> </span><span class="nn">..kore.syntax</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pattern</span><span class="p">,</span> <span class="n">Sort</span><span class="p">,</span> <span class="n">SymbolDecl</span>
<span class="linenos">  51</span>    <span class="kn">from</span><span class="w"> </span><span class="nn">.model</span><span class="w"> </span><span class="kn">import</span> <span class="n">Binder</span><span class="p">,</span> <span class="n">Command</span><span class="p">,</span> <span class="n">Declaration</span><span class="p">,</span> <span class="n">DeclVal</span><span class="p">,</span> <span class="n">FieldVal</span>
<span class="linenos">  52</span>
<span class="linenos">  53</span>
<span class="linenos">  54</span><span class="n">_PRELUDE_SORTS</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">  55</span>    <span class="s1">&#39;SortBool&#39;</span><span class="p">,</span>
<span class="linenos">  56</span>    <span class="s1">&#39;SortBytes&#39;</span><span class="p">,</span>
<span class="linenos">  57</span>    <span class="s1">&#39;SortId&#39;</span><span class="p">,</span>
<span class="linenos">  58</span>    <span class="s1">&#39;SortInt&#39;</span><span class="p">,</span>
<span class="linenos">  59</span>    <span class="s1">&#39;SortString&#39;</span><span class="p">,</span>
<span class="linenos">  60</span>    <span class="s1">&#39;SortStringBuffer&#39;</span><span class="p">,</span>
<span class="linenos">  61</span>    <span class="s1">&#39;SortEndianness&#39;</span><span class="p">,</span>
<span class="linenos">  62</span>    <span class="s1">&#39;SortSignedness&#39;</span><span class="p">,</span>
<span class="linenos">  63</span><span class="p">}</span>
<span class="linenos">  64</span><span class="n">_PRELUDE_FUNCS</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">  65</span>    <span class="s2">&quot;Lbl&#39;UndsPlus&#39;Int&#39;Unds&#39;&quot;</span><span class="p">,</span>  <span class="c1"># +Int</span>
<span class="linenos">  66</span>    <span class="s2">&quot;Lbl&#39;Unds&#39;-Int&#39;Unds&#39;&quot;</span><span class="p">,</span>  <span class="c1"># -Int</span>
<span class="linenos">  67</span>    <span class="s2">&quot;Lbl&#39;UndsStar&#39;Int&#39;Unds&#39;&quot;</span><span class="p">,</span>  <span class="c1"># *Int</span>
<span class="linenos">  68</span>    <span class="s2">&quot;Lbl&#39;UndsSlsh&#39;Int&#39;Unds&#39;&quot;</span><span class="p">,</span>  <span class="c1"># /Int</span>
<span class="linenos">  69</span>    <span class="s2">&quot;Lbl&#39;Unds&#39;modInt&#39;Unds&#39;&quot;</span><span class="p">,</span>  <span class="c1"># modInt</span>
<span class="linenos">  70</span>    <span class="s2">&quot;Lbl&#39;UndsXor-Perc&#39;Int&#39;UndsUnds&#39;&quot;</span><span class="p">,</span>  <span class="c1"># ^%Int</span>
<span class="linenos">  71</span>    <span class="s2">&quot;LblmaxInt&#39;LParUndsCommUndsRParUnds&#39;INT-COMMON&#39;Unds&#39;Int&#39;Unds&#39;Int&#39;Unds&#39;Int&quot;</span><span class="p">,</span>  <span class="c1"># maxInt</span>
<span class="linenos">  72</span>    <span class="s2">&quot;Lbl&#39;Tild&#39;Int&#39;Unds&#39;&quot;</span><span class="p">,</span>  <span class="c1"># ~Int</span>
<span class="linenos">  73</span>    <span class="s2">&quot;Lbl&#39;Unds-LT-Eqls&#39;Int&#39;Unds&#39;&quot;</span><span class="p">,</span>  <span class="c1"># &lt;=Int</span>
<span class="linenos">  74</span>    <span class="s2">&quot;Lbl&#39;Unds-GT-Eqls&#39;Int&#39;Unds&#39;&quot;</span><span class="p">,</span>  <span class="c1"># &gt;=Int</span>
<span class="linenos">  75</span>    <span class="s2">&quot;Lbl&#39;Unds-LT-&#39;Int&#39;Unds&#39;&quot;</span><span class="p">,</span>  <span class="c1"># &lt;Int</span>
<span class="linenos">  76</span>    <span class="s2">&quot;Lbl&#39;Unds-GT-&#39;Int&#39;Unds&#39;&quot;</span><span class="p">,</span>  <span class="c1"># &gt;Int</span>
<span class="linenos">  77</span>    <span class="s2">&quot;Lbl&#39;UndsEqlsEqls&#39;Int&#39;Unds&#39;&quot;</span><span class="p">,</span>  <span class="c1"># ==Int</span>
<span class="linenos">  78</span>    <span class="s2">&quot;Lbl&#39;Stop&#39;Bytes&#39;Unds&#39;BYTES-HOOKED&#39;Unds&#39;Bytes&quot;</span><span class="p">,</span>  <span class="c1"># Bytes.empty</span>
<span class="linenos">  79</span>    <span class="s2">&quot;Lbllog2Int&#39;LParUndsRParUnds&#39;INT-COMMON&#39;Unds&#39;Int&#39;Unds&#39;Int&quot;</span><span class="p">,</span>  <span class="c1"># Int.log2</span>
<span class="linenos">  80</span>    <span class="s2">&quot;LblInt2Bytes&#39;LParUndsCommUndsCommUndsRParUnds&#39;BYTES-HOOKED&#39;Unds&#39;Bytes&#39;Unds&#39;Int&#39;Unds&#39;Int&#39;Unds&#39;Endianness&quot;</span><span class="p">,</span>  <span class="c1"># Int2Bytes</span>
<span class="linenos">  81</span>    <span class="s2">&quot;LblBytes2Int&#39;LParUndsCommUndsCommUndsRParUnds&#39;BYTES-HOOKED&#39;Unds&#39;Int&#39;Unds&#39;Bytes&#39;Unds&#39;Endianness&#39;Unds&#39;Signedness&quot;</span><span class="p">,</span>  <span class="c1"># Bytes2Int</span>
<span class="linenos">  82</span>    <span class="s2">&quot;LblpadRightBytes&#39;LParUndsCommUndsCommUndsRParUnds&#39;BYTES-HOOKED&#39;Unds&#39;Bytes&#39;Unds&#39;Bytes&#39;Unds&#39;Int&#39;Unds&#39;Int&quot;</span><span class="p">,</span>  <span class="c1"># padRight</span>
<span class="linenos">  83</span>    <span class="s2">&quot;LblpadLeftBytes&#39;LParUndsCommUndsCommUndsRParUnds&#39;BYTES-HOOKED&#39;Unds&#39;Bytes&#39;Unds&#39;Bytes&#39;Unds&#39;Int&#39;Unds&#39;Int&quot;</span><span class="p">,</span>  <span class="c1"># padLeft</span>
<span class="linenos">  84</span>    <span class="s2">&quot;LbllengthBytes&#39;LParUndsRParUnds&#39;BYTES-HOOKED&#39;Unds&#39;Int&#39;Unds&#39;Bytes&quot;</span><span class="p">,</span>  <span class="c1"># Bytes.length</span>
<span class="linenos">  85</span>    <span class="s2">&quot;LblreplaceAtBytes&#39;LParUndsCommUndsCommUndsRParUnds&#39;BYTES-HOOKED&#39;Unds&#39;Bytes&#39;Unds&#39;Bytes&#39;Unds&#39;Int&#39;Unds&#39;Bytes&quot;</span><span class="p">,</span>  <span class="c1"># Bytes.replaceAt</span>
<span class="linenos">  86</span>    <span class="s2">&quot;LblsubstrBytes&#39;LParUndsCommUndsCommUndsRParUnds&#39;BYTES-HOOKED&#39;Unds&#39;Bytes&#39;Unds&#39;Bytes&#39;Unds&#39;Int&#39;Unds&#39;Int&quot;</span><span class="p">,</span>  <span class="c1"># Bytes.substr</span>
<span class="linenos">  87</span><span class="p">}</span>
<span class="linenos">  88</span>
<span class="linenos">  89</span><span class="n">_SYMBOL_OVERRIDES</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">  90</span>    <span class="s1">&#39;Lblite&#39;</span><span class="p">:</span> <span class="s1">&#39;kite&#39;</span><span class="p">,</span>
<span class="linenos">  91</span>    <span class="s1">&#39;Lblabs&#39;</span><span class="p">:</span> <span class="s1">&#39;kabs&#39;</span><span class="p">,</span>
<span class="linenos">  92</span><span class="p">}</span>
<span class="linenos">  93</span>
<span class="linenos">  94</span>
<div class="viewcode-block" id="Field">
<a class="viewcode-back" href="../../../api/pyk.klean.k2lean4.html#pyk.klean.k2lean4.Field">[docs]</a>
<span class="linenos">  95</span><span class="k">class</span><span class="w"> </span><span class="nc">Field</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="linenos">  96</span>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<span class="linenos">  97</span>    <span class="n">ty</span><span class="p">:</span> <span class="n">Term</span></div>

<span class="linenos">  98</span>
<span class="linenos">  99</span>
<div class="viewcode-block" id="Matcher">
<a class="viewcode-back" href="../../../api/pyk.klean.k2lean4.html#pyk.klean.k2lean4.Matcher">[docs]</a>
<span class="linenos"> 100</span><span class="k">class</span><span class="w"> </span><span class="nc">Matcher</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="linenos"> 101</span>    <span class="nd">@cached_property</span>
<span class="linenos"> 102</span>    <span class="k">def</span><span class="w"> </span><span class="nf">inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">frozenset</span><span class="p">[</span><span class="n">EVar</span><span class="p">]:</span>
<span class="linenos"> 103</span>        <span class="k">return</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_patterns</span><span class="p">()</span> <span class="k">for</span> <span class="n">vs</span> <span class="ow">in</span> <span class="n">free_occs</span><span class="p">(</span><span class="n">pat</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vs</span><span class="p">)</span>
<span class="linenos"> 104</span>
<span class="linenos"> 105</span>    <span class="nd">@cached_property</span>
<span class="linenos"> 106</span>    <span class="k">def</span><span class="w"> </span><span class="nf">outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">frozenset</span><span class="p">[</span><span class="n">EVar</span><span class="p">]:</span>
<span class="linenos"> 107</span>        <span class="k">return</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_patterns</span><span class="p">()</span> <span class="k">for</span> <span class="n">vs</span> <span class="ow">in</span> <span class="n">free_occs</span><span class="p">(</span><span class="n">pat</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vs</span><span class="p">)</span>
<span class="linenos"> 108</span>
<span class="linenos"> 109</span>    <span class="nd">@abstractmethod</span>
<span class="linenos"> 110</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_input_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Pattern</span><span class="p">]:</span> <span class="o">...</span>
<span class="linenos"> 111</span>
<span class="linenos"> 112</span>    <span class="nd">@abstractmethod</span>
<span class="linenos"> 113</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_output_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Pattern</span><span class="p">]:</span> <span class="o">...</span></div>

<span class="linenos"> 114</span>
<span class="linenos"> 115</span>
<div class="viewcode-block" id="EqMatcher">
<a class="viewcode-back" href="../../../api/pyk.klean.k2lean4.html#pyk.klean.k2lean4.EqMatcher">[docs]</a>
<span class="linenos"> 116</span><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 117</span><span class="k">class</span><span class="w"> </span><span class="nc">EqMatcher</span><span class="p">(</span><span class="n">Matcher</span><span class="p">):</span>
<span class="linenos"> 118</span>    <span class="n">var1</span><span class="p">:</span> <span class="n">EVar</span>
<span class="linenos"> 119</span>    <span class="n">var2</span><span class="p">:</span> <span class="n">EVar</span>
<span class="linenos"> 120</span>
<span class="linenos"> 121</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_input_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Pattern</span><span class="p">]:</span>
<span class="linenos"> 122</span>        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var2</span><span class="p">]</span>
<span class="linenos"> 123</span>
<span class="linenos"> 124</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_output_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Pattern</span><span class="p">]:</span>
<span class="linenos"> 125</span>        <span class="k">return</span> <span class="p">[]</span></div>

<span class="linenos"> 126</span>
<span class="linenos"> 127</span>
<div class="viewcode-block" id="BaseMatcher">
<a class="viewcode-back" href="../../../api/pyk.klean.k2lean4.html#pyk.klean.k2lean4.BaseMatcher">[docs]</a>
<span class="linenos"> 128</span><span class="k">class</span><span class="w"> </span><span class="nc">BaseMatcher</span><span class="p">(</span><span class="n">Matcher</span><span class="p">,</span> <span class="n">ABC</span><span class="p">):</span>
<span class="linenos"> 129</span>    <span class="n">var</span><span class="p">:</span> <span class="n">EVar</span>
<span class="linenos"> 130</span>
<span class="linenos"> 131</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_input_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Pattern</span><span class="p">]:</span>
<span class="linenos"> 132</span>        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="p">]</span>
<span class="linenos"> 133</span>
<span class="linenos"> 134</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_output_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Pattern</span><span class="p">]:</span>
<span class="linenos"> 135</span>        <span class="k">return</span> <span class="p">[]</span></div>

<span class="linenos"> 136</span>
<span class="linenos"> 137</span>
<div class="viewcode-block" id="SubsortMatcher">
<a class="viewcode-back" href="../../../api/pyk.klean.k2lean4.html#pyk.klean.k2lean4.SubsortMatcher">[docs]</a>
<span class="linenos"> 138</span><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 139</span><span class="k">class</span><span class="w"> </span><span class="nc">SubsortMatcher</span><span class="p">(</span><span class="n">BaseMatcher</span><span class="p">):</span>
<span class="linenos"> 140</span>    <span class="n">var</span><span class="p">:</span> <span class="n">EVar</span>
<span class="linenos"> 141</span>    <span class="n">subsort</span><span class="p">:</span> <span class="nb">str</span>
<span class="linenos"> 142</span>    <span class="n">supersort</span><span class="p">:</span> <span class="nb">str</span>
<span class="linenos"> 143</span>    <span class="n">pattern</span><span class="p">:</span> <span class="n">Pattern</span>
<span class="linenos"> 144</span>
<span class="linenos"> 145</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_output_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Pattern</span><span class="p">]:</span>
<span class="linenos"> 146</span>        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pattern</span><span class="p">]</span></div>

<span class="linenos"> 147</span>
<span class="linenos"> 148</span>
<div class="viewcode-block" id="ListMatcher">
<a class="viewcode-back" href="../../../api/pyk.klean.k2lean4.html#pyk.klean.k2lean4.ListMatcher">[docs]</a>
<span class="linenos"> 149</span><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 150</span><span class="k">class</span><span class="w"> </span><span class="nc">ListMatcher</span><span class="p">(</span><span class="n">BaseMatcher</span><span class="p">):</span>
<span class="linenos"> 151</span>    <span class="n">var</span><span class="p">:</span> <span class="n">EVar</span>
<span class="linenos"> 152</span>    <span class="n">prefix</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Pattern</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
<span class="linenos"> 153</span>    <span class="n">middle</span><span class="p">:</span> <span class="n">Pattern</span>
<span class="linenos"> 154</span>    <span class="n">suffix</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Pattern</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
<span class="linenos"> 155</span>
<span class="linenos"> 156</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_output_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Pattern</span><span class="p">]:</span>
<span class="linenos"> 157</span>        <span class="n">res</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Pattern</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 158</span>        <span class="n">res</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
<span class="linenos"> 159</span>        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">middle</span><span class="p">)</span>
<span class="linenos"> 160</span>        <span class="n">res</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span>
<span class="linenos"> 161</span>        <span class="k">return</span> <span class="n">res</span></div>

<span class="linenos"> 162</span>
<span class="linenos"> 163</span>
<div class="viewcode-block" id="EmptyListMatcher">
<a class="viewcode-back" href="../../../api/pyk.klean.k2lean4.html#pyk.klean.k2lean4.EmptyListMatcher">[docs]</a>
<span class="linenos"> 164</span><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 165</span><span class="k">class</span><span class="w"> </span><span class="nc">EmptyListMatcher</span><span class="p">(</span><span class="n">BaseMatcher</span><span class="p">):</span>
<span class="linenos"> 166</span>    <span class="n">var</span><span class="p">:</span> <span class="n">EVar</span></div>

<span class="linenos"> 167</span>
<span class="linenos"> 168</span>
<div class="viewcode-block" id="SetMatcher">
<a class="viewcode-back" href="../../../api/pyk.klean.k2lean4.html#pyk.klean.k2lean4.SetMatcher">[docs]</a>
<span class="linenos"> 169</span><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 170</span><span class="k">class</span><span class="w"> </span><span class="nc">SetMatcher</span><span class="p">(</span><span class="n">BaseMatcher</span><span class="p">):</span>
<span class="linenos"> 171</span>    <span class="n">var</span><span class="p">:</span> <span class="n">EVar</span>
<span class="linenos"> 172</span>    <span class="n">elems</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Pattern</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
<span class="linenos"> 173</span>    <span class="n">rest</span><span class="p">:</span> <span class="n">Pattern</span>
<span class="linenos"> 174</span>
<span class="linenos"> 175</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_input_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Pattern</span><span class="p">]:</span>
<span class="linenos"> 176</span>        <span class="n">res</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Pattern</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 177</span>        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="p">)</span>
<span class="linenos"> 178</span>        <span class="n">res</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elems</span><span class="p">)</span>
<span class="linenos"> 179</span>        <span class="k">return</span> <span class="n">res</span>
<span class="linenos"> 180</span>
<span class="linenos"> 181</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_output_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Pattern</span><span class="p">]:</span>
<span class="linenos"> 182</span>        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="p">]</span></div>

<span class="linenos"> 183</span>
<span class="linenos"> 184</span>
<div class="viewcode-block" id="EmptySetMatcher">
<a class="viewcode-back" href="../../../api/pyk.klean.k2lean4.html#pyk.klean.k2lean4.EmptySetMatcher">[docs]</a>
<span class="linenos"> 185</span><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 186</span><span class="k">class</span><span class="w"> </span><span class="nc">EmptySetMatcher</span><span class="p">(</span><span class="n">BaseMatcher</span><span class="p">):</span>
<span class="linenos"> 187</span>    <span class="n">var</span><span class="p">:</span> <span class="n">EVar</span></div>

<span class="linenos"> 188</span>
<span class="linenos"> 189</span>
<div class="viewcode-block" id="MapMatcher">
<a class="viewcode-back" href="../../../api/pyk.klean.k2lean4.html#pyk.klean.k2lean4.MapMatcher">[docs]</a>
<span class="linenos"> 190</span><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 191</span><span class="k">class</span><span class="w"> </span><span class="nc">MapMatcher</span><span class="p">(</span><span class="n">BaseMatcher</span><span class="p">):</span>
<span class="linenos"> 192</span>    <span class="n">var</span><span class="p">:</span> <span class="n">EVar</span>
<span class="linenos"> 193</span>    <span class="n">key_sort</span><span class="p">:</span> <span class="nb">str</span>
<span class="linenos"> 194</span>    <span class="n">value_sort</span><span class="p">:</span> <span class="nb">str</span>
<span class="linenos"> 195</span>    <span class="n">keys</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Pattern</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
<span class="linenos"> 196</span>    <span class="n">values</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Pattern</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
<span class="linenos"> 197</span>    <span class="n">rest</span><span class="p">:</span> <span class="n">Pattern</span>
<span class="linenos"> 198</span>
<span class="linenos"> 199</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_input_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Pattern</span><span class="p">]:</span>
<span class="linenos"> 200</span>        <span class="n">res</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Pattern</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 201</span>        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="p">)</span>
<span class="linenos"> 202</span>        <span class="n">res</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">)</span>
<span class="linenos"> 203</span>        <span class="k">return</span> <span class="n">res</span>
<span class="linenos"> 204</span>
<span class="linenos"> 205</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_output_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Pattern</span><span class="p">]:</span>
<span class="linenos"> 206</span>        <span class="n">res</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Pattern</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 207</span>        <span class="n">res</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="linenos"> 208</span>        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="p">)</span>
<span class="linenos"> 209</span>        <span class="k">return</span> <span class="n">res</span></div>

<span class="linenos"> 210</span>
<span class="linenos"> 211</span>
<div class="viewcode-block" id="EmptyMapMatcher">
<a class="viewcode-back" href="../../../api/pyk.klean.k2lean4.html#pyk.klean.k2lean4.EmptyMapMatcher">[docs]</a>
<span class="linenos"> 212</span><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 213</span><span class="k">class</span><span class="w"> </span><span class="nc">EmptyMapMatcher</span><span class="p">(</span><span class="n">BaseMatcher</span><span class="p">):</span>
<span class="linenos"> 214</span>    <span class="n">var</span><span class="p">:</span> <span class="n">EVar</span>
<span class="linenos"> 215</span>    <span class="n">key_sort</span><span class="p">:</span> <span class="nb">str</span>
<span class="linenos"> 216</span>    <span class="n">value_sort</span><span class="p">:</span> <span class="nb">str</span></div>

<span class="linenos"> 217</span>
<span class="linenos"> 218</span>
<div class="viewcode-block" id="Config">
<a class="viewcode-back" href="../../../api/pyk.klean.k2lean4.html#pyk.klean.k2lean4.Config">[docs]</a>
<span class="linenos"> 219</span><span class="k">class</span><span class="w"> </span><span class="nc">Config</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos"> 220</span>    <span class="n">derive_beq</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span>
<span class="linenos"> 221</span>    <span class="n">derive_decidableeq</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span></div>

<span class="linenos"> 222</span>
<span class="linenos"> 223</span>
<div class="viewcode-block" id="K2Lean4">
<a class="viewcode-back" href="../../../api/pyk.klean.k2lean4.html#pyk.klean.k2lean4.K2Lean4">[docs]</a>
<span class="linenos"> 224</span><span class="nd">@dataclass</span>
<span class="linenos"> 225</span><span class="k">class</span><span class="w"> </span><span class="nc">K2Lean4</span><span class="p">:</span>
<span class="linenos"> 226</span>    <span class="n">defn</span><span class="p">:</span> <span class="n">KoreDefn</span>
<span class="linenos"> 227</span>    <span class="n">derive_beq</span><span class="p">:</span> <span class="nb">bool</span>
<span class="linenos"> 228</span>    <span class="n">derive_decidableeq</span><span class="p">:</span> <span class="nb">bool</span>
<span class="linenos"> 229</span>
<span class="linenos"> 230</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">defn</span><span class="p">:</span> <span class="n">KoreDefn</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 231</span>        <span class="n">config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="p">{}</span>
<span class="linenos"> 232</span>        <span class="bp">self</span><span class="o">.</span><span class="n">defn</span> <span class="o">=</span> <span class="n">defn</span>
<span class="linenos"> 233</span>        <span class="bp">self</span><span class="o">.</span><span class="n">derive_beq</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;derive_beq&#39;</span><span class="p">))</span>
<span class="linenos"> 234</span>        <span class="bp">self</span><span class="o">.</span><span class="n">derive_decidableeq</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;derive_decidableeq&#39;</span><span class="p">))</span>
<span class="linenos"> 235</span>
<span class="linenos"> 236</span>    <span class="nd">@cached_property</span>
<span class="linenos"> 237</span>    <span class="k">def</span><span class="w"> </span><span class="nf">symbol_table</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KoreSymbolTable</span><span class="p">:</span>
<span class="linenos"> 238</span>        <span class="k">return</span> <span class="n">KoreSymbolTable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<span class="linenos"> 239</span>
<span class="linenos"> 240</span>    <span class="nd">@cached_property</span>
<span class="linenos"> 241</span>    <span class="k">def</span><span class="w"> </span><span class="nf">structure_symbols</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FrozenDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="linenos"> 242</span>        <span class="k">def</span><span class="w"> </span><span class="nf">constructed_by</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 243</span>            <span class="n">decl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
<span class="linenos"> 244</span>            <span class="n">_sort</span> <span class="o">=</span> <span class="n">decl</span><span class="o">.</span><span class="n">sort</span>
<span class="linenos"> 245</span>
<span class="linenos"> 246</span>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_sort</span><span class="p">,</span> <span class="n">SortApp</span><span class="p">):</span>
<span class="linenos"> 247</span>                <span class="k">return</span> <span class="kc">None</span>
<span class="linenos"> 248</span>
<span class="linenos"> 249</span>            <span class="n">sort</span> <span class="o">=</span> <span class="n">_sort</span><span class="o">.</span><span class="n">name</span>
<span class="linenos"> 250</span>
<span class="linenos"> 251</span>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_cell</span><span class="p">(</span><span class="n">sort</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_collection</span><span class="p">(</span><span class="n">sort</span><span class="p">):</span>
<span class="linenos"> 252</span>                <span class="k">return</span> <span class="kc">None</span>
<span class="linenos"> 253</span>
<span class="linenos"> 254</span>            <span class="k">if</span> <span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">constructors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sort</span><span class="p">,</span> <span class="p">()):</span>
<span class="linenos"> 255</span>                <span class="k">return</span> <span class="kc">None</span>
<span class="linenos"> 256</span>
<span class="linenos"> 257</span>            <span class="k">return</span> <span class="n">sort</span>
<span class="linenos"> 258</span>
<span class="linenos"> 259</span>        <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">(</span>
<span class="linenos"> 260</span>            <span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">sort</span><span class="p">)</span> <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">symbols</span> <span class="k">if</span> <span class="p">(</span><span class="n">sort</span> <span class="o">:=</span> <span class="n">constructed_by</span><span class="p">(</span><span class="n">symbol</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="linenos"> 261</span>        <span class="p">)</span>
<span class="linenos"> 262</span>
<span class="linenos"> 263</span>    <span class="nd">@cached_property</span>
<span class="linenos"> 264</span>    <span class="k">def</span><span class="w"> </span><span class="nf">structures</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FrozenDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Field</span><span class="p">,</span> <span class="o">...</span><span class="p">]]:</span>
<span class="linenos"> 265</span>        <span class="k">def</span><span class="w"> </span><span class="nf">fields_of</span><span class="p">(</span><span class="n">sort</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Field</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 266</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_cell</span><span class="p">(</span><span class="n">sort</span><span class="p">):</span>
<span class="linenos"> 267</span>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cell_fields</span><span class="p">(</span><span class="n">sort</span><span class="p">)</span>
<span class="linenos"> 268</span>
<span class="linenos"> 269</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_collection</span><span class="p">(</span><span class="n">sort</span><span class="p">):</span>
<span class="linenos"> 270</span>                <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_collection_field</span><span class="p">(</span><span class="n">sort</span><span class="p">),)</span>
<span class="linenos"> 271</span>
<span class="linenos"> 272</span>            <span class="k">return</span> <span class="kc">None</span>
<span class="linenos"> 273</span>
<span class="linenos"> 274</span>        <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">((</span><span class="n">sort</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span> <span class="k">for</span> <span class="n">sort</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">sorts</span> <span class="k">if</span> <span class="p">(</span><span class="n">fields</span> <span class="o">:=</span> <span class="n">fields_of</span><span class="p">(</span><span class="n">sort</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos"> 275</span>
<span class="linenos"> 276</span>    <span class="nd">@cached_property</span>
<span class="linenos"> 277</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_sort_deps</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FrozenDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="linenos"> 278</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Transitively closed sort dependency graph.&quot;&quot;&quot;</span>
<span class="linenos"> 279</span>        <span class="n">sorts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">sorts</span>
<span class="linenos"> 280</span>        <span class="n">deps</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 281</span>        <span class="k">for</span> <span class="n">sort</span> <span class="ow">in</span> <span class="n">sorts</span><span class="p">:</span>
<span class="linenos"> 282</span>            <span class="c1"># A sort depends on its subsorts (due to inj_{subsort} constructors)</span>
<span class="linenos"> 283</span>            <span class="n">deps</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">sort</span><span class="p">,</span> <span class="n">subsort</span><span class="p">)</span> <span class="k">for</span> <span class="n">subsort</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">subsorts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sort</span><span class="p">,</span> <span class="p">[]))</span>
<span class="linenos"> 284</span>            <span class="c1"># A sort depends on the parameter sorts of all its constructors</span>
<span class="linenos"> 285</span>            <span class="n">deps</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
<span class="linenos"> 286</span>                <span class="p">(</span><span class="n">sort</span><span class="p">,</span> <span class="n">param_sort</span><span class="p">)</span>
<span class="linenos"> 287</span>                <span class="k">for</span> <span class="n">ctor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">constructors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sort</span><span class="p">,</span> <span class="p">[])</span>
<span class="linenos"> 288</span>                <span class="k">for</span> <span class="n">param_sort</span> <span class="ow">in</span> <span class="n">_param_sorts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">ctor</span><span class="p">])</span>
<span class="linenos"> 289</span>            <span class="p">)</span>
<span class="linenos"> 290</span>            <span class="c1"># If the sort is a collection, the element function parameters are dependencies</span>
<span class="linenos"> 291</span>            <span class="k">if</span> <span class="n">sort</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">collections</span><span class="p">:</span>
<span class="linenos"> 292</span>                <span class="n">coll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="n">sort</span><span class="p">]</span>
<span class="linenos"> 293</span>                <span class="n">elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">coll</span><span class="o">.</span><span class="n">element</span><span class="p">]</span>
<span class="linenos"> 294</span>                <span class="n">deps</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">sort</span><span class="p">,</span> <span class="n">param_sort</span><span class="p">)</span> <span class="k">for</span> <span class="n">param_sort</span> <span class="ow">in</span> <span class="n">_param_sorts</span><span class="p">(</span><span class="n">elem</span><span class="p">))</span>
<span class="linenos"> 295</span>
<span class="linenos"> 296</span>        <span class="n">closed</span> <span class="o">=</span> <span class="n">POSet</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span><span class="o">.</span><span class="n">image</span>  <span class="c1"># TODO POSet should be called &quot;transitively closed relation&quot; or similar</span>
<span class="linenos"> 297</span>        <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">(</span>
<span class="linenos"> 298</span>            <span class="p">(</span><span class="n">sort</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">closed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sort</span><span class="p">,</span> <span class="p">[])))</span> <span class="k">for</span> <span class="n">sort</span> <span class="ow">in</span> <span class="n">sorts</span>
<span class="linenos"> 299</span>        <span class="p">)</span>  <span class="c1"># Ensure that sorts without dependencies are also represented</span>
<span class="linenos"> 300</span>
<span class="linenos"> 301</span>    <span class="nd">@cached_property</span>
<span class="linenos"> 302</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_sort_sccs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="o">...</span><span class="p">]:</span>
<span class="linenos"> 303</span>        <span class="n">sccs</span> <span class="o">=</span> <span class="n">_ordered_sccs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sort_deps</span><span class="p">)</span>
<span class="linenos"> 304</span>        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">scc</span><span class="p">)</span> <span class="k">for</span> <span class="n">scc</span> <span class="ow">in</span> <span class="n">sccs</span><span class="p">)</span>
<span class="linenos"> 305</span>
<span class="linenos"> 306</span>    <span class="nd">@cached_property</span>
<span class="linenos"> 307</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_func_rules_by_uid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FrozenDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">FunctionRule</span><span class="p">]:</span>
<span class="linenos"> 308</span>        <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">((</span><span class="n">rule</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">rule</span><span class="p">)</span> <span class="k">for</span> <span class="n">rules</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">)</span>
<span class="linenos"> 309</span>
<span class="linenos"> 310</span>    <span class="nd">@cached_property</span>
<span class="linenos"> 311</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_func_deps</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FrozenDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="linenos"> 312</span>        <span class="n">deps</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 313</span>        <span class="n">elems</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="linenos"> 314</span>        <span class="k">for</span> <span class="n">func</span><span class="p">,</span> <span class="n">rules</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos"> 315</span>            <span class="n">elems</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
<span class="linenos"> 316</span>            <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
<span class="linenos"> 317</span>                <span class="n">elems</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span>
<span class="linenos"> 318</span>                <span class="c1"># A function depends on the rules that define it</span>
<span class="linenos"> 319</span>                <span class="n">deps</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">func</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">uid</span><span class="p">))</span>
<span class="linenos"> 320</span>                <span class="c1"># A rule depends on all the functions that it applies</span>
<span class="linenos"> 321</span>                <span class="n">symbols</span> <span class="o">=</span> <span class="n">collect_symbols</span><span class="p">(</span>
<span class="linenos"> 322</span>                    <span class="n">And</span><span class="p">(</span><span class="n">SortApp</span><span class="p">(</span><span class="s1">&#39;SortFoo&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">req</span> <span class="ow">or</span> <span class="n">Top</span><span class="p">(</span><span class="n">SortApp</span><span class="p">(</span><span class="s1">&#39;SortFoo&#39;</span><span class="p">)),</span> <span class="o">*</span><span class="n">rule</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">rhs</span><span class="p">))</span>
<span class="linenos"> 323</span>                <span class="p">)</span>  <span class="c1"># Collection functions like `_List_` can occur on the LHS</span>
<span class="linenos"> 324</span>                <span class="n">deps</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">rule</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span> <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols</span> <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">functions</span><span class="p">)</span>
<span class="linenos"> 325</span>
<span class="linenos"> 326</span>        <span class="n">closed</span> <span class="o">=</span> <span class="n">POSet</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span><span class="o">.</span><span class="n">image</span>
<span class="linenos"> 327</span>        <span class="k">return</span> <span class="n">FrozenDict</span><span class="p">((</span><span class="n">elem</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">closed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="p">[])))</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">elems</span><span class="p">)</span>
<span class="linenos"> 328</span>
<span class="linenos"> 329</span>    <span class="nd">@cached_property</span>
<span class="linenos"> 330</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_func_sccs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="o">...</span><span class="p">]:</span>
<span class="linenos"> 331</span>        <span class="n">sccs</span> <span class="o">=</span> <span class="n">_ordered_sccs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_func_deps</span><span class="p">)</span>
<span class="linenos"> 332</span>        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">scc</span><span class="p">)</span> <span class="k">for</span> <span class="n">scc</span> <span class="ow">in</span> <span class="n">sccs</span><span class="p">)</span>
<span class="linenos"> 333</span>
<span class="linenos"> 334</span>    <span class="nd">@cached_property</span>
<span class="linenos"> 335</span>    <span class="k">def</span><span class="w"> </span><span class="nf">noncomputable</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">frozenset</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="linenos"> 336</span>        <span class="n">res</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="linenos"> 337</span>
<span class="linenos"> 338</span>        <span class="k">for</span> <span class="n">scc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func_sccs</span><span class="p">:</span>
<span class="linenos"> 339</span>            <span class="k">assert</span> <span class="n">scc</span>
<span class="linenos"> 340</span>            <span class="n">elem</span> <span class="o">=</span> <span class="n">scc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 341</span>
<span class="linenos"> 342</span>            <span class="k">if</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">functions</span> <span class="ow">and</span> <span class="n">elem</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_PRELUDE_FUNCS</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">functions</span><span class="p">[</span><span class="n">elem</span><span class="p">]:</span>
<span class="linenos"> 343</span>                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">scc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
<span class="linenos"> 344</span>                <span class="n">res</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
<span class="linenos"> 345</span>
<span class="linenos"> 346</span>            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">dep</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func_deps</span><span class="p">[</span><span class="n">elem</span><span class="p">]):</span>
<span class="linenos"> 347</span>                <span class="n">res</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">scc</span><span class="p">)</span>
<span class="linenos"> 348</span>
<span class="linenos"> 349</span>        <span class="k">return</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<span class="linenos"> 350</span>
<span class="linenos"> 351</span>    <span class="nd">@staticmethod</span>
<span class="linenos"> 352</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_is_cell</span><span class="p">(</span><span class="n">sort</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="linenos"> 353</span>        <span class="k">return</span> <span class="n">sort</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;Cell&#39;</span><span class="p">)</span>
<span class="linenos"> 354</span>
<span class="linenos"> 355</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_cell_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Field</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="linenos"> 356</span>        <span class="p">(</span><span class="n">ctor</span><span class="p">,)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">constructors</span><span class="p">[</span><span class="n">sort</span><span class="p">]</span>
<span class="linenos"> 357</span>        <span class="n">decl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">ctor</span><span class="p">]</span>
<span class="linenos"> 358</span>        <span class="n">sorts</span> <span class="o">=</span> <span class="n">_param_sorts</span><span class="p">(</span><span class="n">decl</span><span class="p">)</span>
<span class="linenos"> 359</span>
<span class="linenos"> 360</span>        <span class="n">names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="linenos"> 361</span>        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_cell</span><span class="p">(</span><span class="n">sort</span><span class="p">)</span> <span class="k">for</span> <span class="n">sort</span> <span class="ow">in</span> <span class="n">sorts</span><span class="p">):</span>
<span class="linenos"> 362</span>            <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 363</span>            <span class="k">for</span> <span class="n">sort</span> <span class="ow">in</span> <span class="n">sorts</span><span class="p">:</span>
<span class="linenos"> 364</span>                <span class="k">assert</span> <span class="n">sort</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Sort&#39;</span><span class="p">)</span>
<span class="linenos"> 365</span>                <span class="k">assert</span> <span class="n">sort</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;Cell&#39;</span><span class="p">)</span>
<span class="linenos"> 366</span>                <span class="n">name</span> <span class="o">=</span> <span class="n">sort</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
<span class="linenos"> 367</span>                <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="linenos"> 368</span>                <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="linenos"> 369</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 370</span>            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
<span class="linenos"> 371</span>            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]</span>
<span class="linenos"> 372</span>
<span class="linenos"> 373</span>        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">Field</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">Term</span><span class="p">(</span><span class="n">sort</span><span class="p">))</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">sort</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">sorts</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="linenos"> 374</span>
<span class="linenos"> 375</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_is_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="linenos"> 376</span>        <span class="k">return</span> <span class="n">sort</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">collections</span>
<span class="linenos"> 377</span>
<span class="linenos"> 378</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_collection_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Field</span><span class="p">:</span>
<span class="linenos"> 379</span>        <span class="n">coll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="n">sort</span><span class="p">]</span>
<span class="linenos"> 380</span>        <span class="n">elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">coll</span><span class="o">.</span><span class="n">element</span><span class="p">]</span>
<span class="linenos"> 381</span>        <span class="n">sorts</span> <span class="o">=</span> <span class="n">_param_sorts</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
<span class="linenos"> 382</span>        <span class="n">term</span><span class="p">:</span> <span class="n">Term</span>
<span class="linenos"> 383</span>        <span class="k">match</span> <span class="n">coll</span><span class="o">.</span><span class="n">kind</span><span class="p">:</span>
<span class="linenos"> 384</span>            <span class="k">case</span> <span class="n">CollectionKind</span><span class="o">.</span><span class="n">LIST</span><span class="p">:</span>
<span class="linenos"> 385</span>                <span class="p">(</span><span class="n">item</span><span class="p">,)</span> <span class="o">=</span> <span class="n">sorts</span>
<span class="linenos"> 386</span>                <span class="n">term</span> <span class="o">=</span> <span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;List </span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos"> 387</span>            <span class="k">case</span> <span class="n">CollectionKind</span><span class="o">.</span><span class="n">SET</span><span class="p">:</span>
<span class="linenos"> 388</span>                <span class="p">(</span><span class="n">item</span><span class="p">,)</span> <span class="o">=</span> <span class="n">sorts</span>
<span class="linenos"> 389</span>                <span class="n">term</span> <span class="o">=</span> <span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;List </span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos"> 390</span>            <span class="k">case</span> <span class="n">CollectionKind</span><span class="o">.</span><span class="n">MAP</span><span class="p">:</span>
<span class="linenos"> 391</span>                <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">sorts</span>
<span class="linenos"> 392</span>                <span class="n">term</span> <span class="o">=</span> <span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;List (</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1"> × </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="linenos"> 393</span>        <span class="k">return</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;coll&#39;</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span>
<span class="linenos"> 394</span>
<div class="viewcode-block" id="K2Lean4.sort_module">
<a class="viewcode-back" href="../../../api/pyk.klean.k2lean4.html#pyk.klean.k2lean4.K2Lean4.sort_module">[docs]</a>
<span class="linenos"> 395</span>    <span class="k">def</span><span class="w"> </span><span class="nf">sort_module</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Module</span><span class="p">:</span>
<span class="linenos"> 396</span>        <span class="n">commands</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Command</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
<span class="linenos"> 397</span>            <span class="n">block</span> <span class="k">for</span> <span class="n">sorts</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sort_sccs</span> <span class="k">if</span> <span class="p">(</span><span class="n">block</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sort_block</span><span class="p">(</span><span class="n">sorts</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="linenos"> 398</span>        <span class="p">)</span>
<span class="linenos"> 399</span>        <span class="k">return</span> <span class="n">Module</span><span class="p">(</span><span class="n">commands</span><span class="o">=</span><span class="n">commands</span><span class="p">)</span></div>

<span class="linenos"> 400</span>
<span class="linenos"> 401</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_sort_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sorts</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Command</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 402</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return an optional mutual block or declaration.&quot;&quot;&quot;</span>
<span class="linenos"> 403</span>        <span class="n">commands</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Command</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
<span class="linenos"> 404</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_transform_sort</span><span class="p">(</span><span class="n">sort</span><span class="p">)</span> <span class="k">for</span> <span class="n">sort</span> <span class="ow">in</span> <span class="n">sorts</span> <span class="k">if</span> <span class="n">sort</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_PRELUDE_SORTS</span>
<span class="linenos"> 405</span>        <span class="p">)</span>
<span class="linenos"> 406</span>
<span class="linenos"> 407</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">commands</span><span class="p">:</span>
<span class="linenos"> 408</span>            <span class="k">return</span> <span class="kc">None</span>
<span class="linenos"> 409</span>
<span class="linenos"> 410</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos"> 411</span>            <span class="p">(</span><span class="n">command</span><span class="p">,)</span> <span class="o">=</span> <span class="n">commands</span>
<span class="linenos"> 412</span>            <span class="k">return</span> <span class="n">command</span>
<span class="linenos"> 413</span>
<span class="linenos"> 414</span>        <span class="k">return</span> <span class="n">Mutual</span><span class="p">(</span><span class="n">commands</span><span class="o">=</span><span class="n">commands</span><span class="p">)</span>
<span class="linenos"> 415</span>
<span class="linenos"> 416</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_transform_sort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Declaration</span><span class="p">:</span>
<span class="linenos"> 417</span>        <span class="k">def</span><span class="w"> </span><span class="nf">is_inductive</span><span class="p">(</span><span class="n">sort</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="linenos"> 418</span>            <span class="n">decl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">sorts</span><span class="p">[</span><span class="n">sort</span><span class="p">]</span>
<span class="linenos"> 419</span>            <span class="k">return</span> <span class="ow">not</span> <span class="n">decl</span><span class="o">.</span><span class="n">hooked</span> <span class="ow">and</span> <span class="s1">&#39;hasDomainValues&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">decl</span><span class="o">.</span><span class="n">attrs_by_key</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_cell</span><span class="p">(</span><span class="n">sort</span><span class="p">)</span>
<span class="linenos"> 420</span>
<span class="linenos"> 421</span>        <span class="k">if</span> <span class="n">is_inductive</span><span class="p">(</span><span class="n">sort</span><span class="p">):</span>
<span class="linenos"> 422</span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inductive</span><span class="p">(</span><span class="n">sort</span><span class="p">)</span>
<span class="linenos"> 423</span>
<span class="linenos"> 424</span>        <span class="k">if</span> <span class="n">sort</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="p">:</span>
<span class="linenos"> 425</span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span><span class="p">(</span><span class="n">sort</span><span class="p">)</span>
<span class="linenos"> 426</span>
<span class="linenos"> 427</span>        <span class="k">raise</span> <span class="ne">AssertionError</span>
<span class="linenos"> 428</span>
<span class="linenos"> 429</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_inductive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Inductive</span><span class="p">:</span>
<span class="linenos"> 430</span>        <span class="n">subsorts</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">subsorts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sort</span><span class="p">,</span> <span class="p">()))</span>
<span class="linenos"> 431</span>        <span class="n">symbols</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">constructors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sort</span><span class="p">,</span> <span class="p">()))</span>
<span class="linenos"> 432</span>        <span class="n">ctors</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Ctor</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 433</span>        <span class="n">ctors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inj_ctor</span><span class="p">(</span><span class="n">sort</span><span class="p">,</span> <span class="n">subsort</span><span class="p">)</span> <span class="k">for</span> <span class="n">subsort</span> <span class="ow">in</span> <span class="n">subsorts</span><span class="p">)</span>
<span class="linenos"> 434</span>        <span class="n">ctors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_symbol_ctor</span><span class="p">(</span><span class="n">sort</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span> <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">)</span>
<span class="linenos"> 435</span>        <span class="k">return</span> <span class="n">Inductive</span><span class="p">(</span>
<span class="linenos"> 436</span>            <span class="n">sort</span><span class="p">,</span>
<span class="linenos"> 437</span>            <span class="n">Signature</span><span class="p">((),</span> <span class="n">Term</span><span class="p">(</span><span class="s1">&#39;Type&#39;</span><span class="p">)),</span>
<span class="linenos"> 438</span>            <span class="n">ctors</span><span class="o">=</span><span class="n">ctors</span><span class="p">,</span>
<span class="linenos"> 439</span>            <span class="n">deriving</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_deriving</span><span class="p">(</span><span class="n">sort</span><span class="p">),</span>
<span class="linenos"> 440</span>        <span class="p">)</span>
<span class="linenos"> 441</span>
<span class="linenos"> 442</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_inj_ctor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">subsort</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Ctor</span><span class="p">:</span>
<span class="linenos"> 443</span>        <span class="k">return</span> <span class="n">Ctor</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;inj_</span><span class="si">{</span><span class="n">subsort</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Signature</span><span class="p">((</span><span class="n">ExplBinder</span><span class="p">((</span><span class="s1">&#39;x&#39;</span><span class="p">,),</span> <span class="n">Term</span><span class="p">(</span><span class="n">subsort</span><span class="p">)),),</span> <span class="n">Term</span><span class="p">(</span><span class="n">sort</span><span class="p">)))</span>
<span class="linenos"> 444</span>
<span class="linenos"> 445</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_symbol_ctor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Ctor</span><span class="p">:</span>
<span class="linenos"> 446</span>        <span class="n">decl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
<span class="linenos"> 447</span>        <span class="n">param_sorts</span> <span class="o">=</span> <span class="n">_param_sorts</span><span class="p">(</span><span class="n">decl</span><span class="p">)</span>
<span class="linenos"> 448</span>        <span class="n">symbol</span> <span class="o">=</span> <span class="n">_symbol_ident</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
<span class="linenos"> 449</span>        <span class="n">binders</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ExplBinder</span><span class="p">((</span><span class="sa">f</span><span class="s1">&#39;x</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,),</span> <span class="n">Term</span><span class="p">(</span><span class="n">sort</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sort</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">param_sorts</span><span class="p">))</span>
<span class="linenos"> 450</span>        <span class="k">return</span> <span class="n">Ctor</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">Signature</span><span class="p">(</span><span class="n">binders</span><span class="p">,</span> <span class="n">Term</span><span class="p">(</span><span class="n">sort</span><span class="p">)))</span>
<span class="linenos"> 451</span>
<span class="linenos"> 452</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Structure</span><span class="p">:</span>
<span class="linenos"> 453</span>        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="p">[</span><span class="n">sort</span><span class="p">]</span>
<span class="linenos"> 454</span>        <span class="n">binders</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ExplBinder</span><span class="p">((</span><span class="n">name</span><span class="p">,),</span> <span class="n">ty</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">ty</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>
<span class="linenos"> 455</span>        <span class="k">return</span> <span class="n">Structure</span><span class="p">(</span>
<span class="linenos"> 456</span>            <span class="n">sort</span><span class="p">,</span>
<span class="linenos"> 457</span>            <span class="n">Signature</span><span class="p">((),</span> <span class="n">Term</span><span class="p">(</span><span class="s1">&#39;Type&#39;</span><span class="p">)),</span>
<span class="linenos"> 458</span>            <span class="n">ctor</span><span class="o">=</span><span class="n">StructCtor</span><span class="p">(</span><span class="n">binders</span><span class="p">),</span>
<span class="linenos"> 459</span>            <span class="n">deriving</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_deriving</span><span class="p">(</span><span class="n">sort</span><span class="p">),</span>
<span class="linenos"> 460</span>        <span class="p">)</span>
<span class="linenos"> 461</span>
<span class="linenos"> 462</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_deriving</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="linenos"> 463</span>        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 464</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">derive_beq</span><span class="p">:</span>
<span class="linenos"> 465</span>            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;BEq&#39;</span><span class="p">)</span>
<span class="linenos"> 466</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">derive_decidableeq</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s1">&#39;SortKItem&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sort_deps</span><span class="p">[</span><span class="n">sort</span><span class="p">]:</span>
<span class="linenos"> 467</span>            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;DecidableEq&#39;</span><span class="p">)</span>
<span class="linenos"> 468</span>        <span class="k">return</span> <span class="n">res</span>
<span class="linenos"> 469</span>
<div class="viewcode-block" id="K2Lean4.inj_module">
<a class="viewcode-back" href="../../../api/pyk.klean.k2lean4.html#pyk.klean.k2lean4.K2Lean4.inj_module">[docs]</a>
<span class="linenos"> 470</span>    <span class="k">def</span><span class="w"> </span><span class="nf">inj_module</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Module</span><span class="p">:</span>
<span class="linenos"> 471</span>        <span class="k">return</span> <span class="n">Module</span><span class="p">(</span><span class="n">commands</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_inj_commands</span><span class="p">())</span></div>

<span class="linenos"> 472</span>
<span class="linenos"> 473</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_inj_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Command</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="linenos"> 474</span>        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
<span class="linenos"> 475</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_inj_instance</span><span class="p">(</span><span class="n">subsort</span><span class="p">,</span> <span class="n">supersort</span><span class="p">)</span>
<span class="linenos"> 476</span>            <span class="k">for</span> <span class="n">supersort</span><span class="p">,</span> <span class="n">subsorts</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">subsorts</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="linenos"> 477</span>            <span class="k">for</span> <span class="n">subsort</span> <span class="ow">in</span> <span class="n">subsorts</span>
<span class="linenos"> 478</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">supersort</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span>
<span class="linenos"> 479</span>                <span class="s1">&#39;CellMap&#39;</span>
<span class="linenos"> 480</span>            <span class="p">)</span>  <span class="c1"># Strangely, cell collections can be injected from their value sort in KORE</span>
<span class="linenos"> 481</span>        <span class="p">)</span>
<span class="linenos"> 482</span>
<span class="linenos"> 483</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_inj_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subsort</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">supersort</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Instance</span><span class="p">:</span>
<span class="linenos"> 484</span>        <span class="n">ty</span> <span class="o">=</span> <span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Inj </span><span class="si">{</span><span class="n">subsort</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">supersort</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos"> 485</span>        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos"> 486</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_inj_field</span><span class="p">(</span><span class="n">subsort</span><span class="p">,</span> <span class="n">supersort</span><span class="p">),</span>
<span class="linenos"> 487</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_retr_field</span><span class="p">(</span><span class="n">subsort</span><span class="p">,</span> <span class="n">supersort</span><span class="p">),</span>
<span class="linenos"> 488</span>        <span class="p">)</span>
<span class="linenos"> 489</span>        <span class="k">return</span> <span class="n">Instance</span><span class="p">(</span><span class="n">Signature</span><span class="p">((),</span> <span class="n">ty</span><span class="p">),</span> <span class="n">StructVal</span><span class="p">(</span><span class="n">fields</span><span class="p">))</span>
<span class="linenos"> 490</span>
<span class="linenos"> 491</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_inj_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subsort</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">supersort</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InstField</span><span class="p">:</span>
<span class="linenos"> 492</span>        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inj_val</span><span class="p">(</span><span class="n">subsort</span><span class="p">,</span> <span class="n">supersort</span><span class="p">)</span>
<span class="linenos"> 493</span>        <span class="k">return</span> <span class="n">InstField</span><span class="p">(</span><span class="s1">&#39;inj&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
<span class="linenos"> 494</span>
<span class="linenos"> 495</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_inj_val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subsort</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">supersort</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FieldVal</span><span class="p">:</span>
<span class="linenos"> 496</span>        <span class="n">subsubsorts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="linenos"> 497</span>        <span class="k">if</span> <span class="n">subsort</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;CellMap&#39;</span><span class="p">):</span>
<span class="linenos"> 498</span>            <span class="n">subsubsorts</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Disregard injection from value sort to cell map sort</span>
<span class="linenos"> 499</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 500</span>            <span class="n">subsubsorts</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">subsorts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subsort</span><span class="p">,</span> <span class="p">[]))</span>
<span class="linenos"> 501</span>
<span class="linenos"> 502</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">subsubsorts</span><span class="p">:</span>
<span class="linenos"> 503</span>            <span class="k">return</span> <span class="n">SimpleFieldVal</span><span class="p">(</span><span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">supersort</span><span class="si">}</span><span class="s1">.inj_</span><span class="si">{</span><span class="n">subsort</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
<span class="linenos"> 504</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 505</span>            <span class="k">return</span> <span class="n">AltsFieldVal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inj_alts</span><span class="p">(</span><span class="n">subsort</span><span class="p">,</span> <span class="n">supersort</span><span class="p">,</span> <span class="n">subsubsorts</span><span class="p">))</span>
<span class="linenos"> 506</span>
<span class="linenos"> 507</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_inj_alts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subsort</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">supersort</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">subsubsorts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Alt</span><span class="p">]:</span>
<span class="linenos"> 508</span>        <span class="k">def</span><span class="w"> </span><span class="nf">inj</span><span class="p">(</span><span class="n">subsort</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">supersort</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Term</span><span class="p">:</span>
<span class="linenos"> 509</span>            <span class="k">return</span> <span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">supersort</span><span class="si">}</span><span class="s1">.inj_</span><span class="si">{</span><span class="n">subsort</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos"> 510</span>
<span class="linenos"> 511</span>        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 512</span>        <span class="k">for</span> <span class="n">subsubsort</span> <span class="ow">in</span> <span class="n">subsubsorts</span><span class="p">:</span>
<span class="linenos"> 513</span>            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Alt</span><span class="p">((</span><span class="n">inj</span><span class="p">(</span><span class="n">subsubsort</span><span class="p">,</span> <span class="n">subsort</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">),),</span> <span class="n">inj</span><span class="p">(</span><span class="n">subsubsort</span><span class="p">,</span> <span class="n">supersort</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">)))</span>
<span class="linenos"> 514</span>
<span class="linenos"> 515</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">constructors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subsort</span><span class="p">,</span> <span class="p">[]):</span>
<span class="linenos"> 516</span>            <span class="c1"># Has actual constructors, not only subsorts</span>
<span class="linenos"> 517</span>            <span class="n">default</span> <span class="o">=</span> <span class="n">Alt</span><span class="p">((</span><span class="n">Term</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">),),</span> <span class="n">inj</span><span class="p">(</span><span class="n">subsort</span><span class="p">,</span> <span class="n">supersort</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">))</span>
<span class="linenos"> 518</span>            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
<span class="linenos"> 519</span>
<span class="linenos"> 520</span>        <span class="k">return</span> <span class="n">res</span>
<span class="linenos"> 521</span>
<span class="linenos"> 522</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_retr_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subsort</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">supersort</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InstField</span><span class="p">:</span>
<span class="linenos"> 523</span>        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retr_val</span><span class="p">(</span><span class="n">subsort</span><span class="p">,</span> <span class="n">supersort</span><span class="p">)</span>
<span class="linenos"> 524</span>        <span class="k">return</span> <span class="n">InstField</span><span class="p">(</span><span class="s1">&#39;retr&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
<span class="linenos"> 525</span>
<span class="linenos"> 526</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_retr_val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subsort</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">supersort</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FieldVal</span><span class="p">:</span>
<span class="linenos"> 527</span>        <span class="n">subsubsorts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="linenos"> 528</span>        <span class="k">if</span> <span class="n">subsort</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;CellMap&#39;</span><span class="p">):</span>
<span class="linenos"> 529</span>            <span class="n">subsubsorts</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Disregard injection from value sort to cell map sort</span>
<span class="linenos"> 530</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 531</span>            <span class="n">subsubsorts</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">subsorts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subsort</span><span class="p">,</span> <span class="p">[]))</span>
<span class="linenos"> 532</span>
<span class="linenos"> 533</span>        <span class="k">return</span> <span class="n">AltsFieldVal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_retr_alts</span><span class="p">(</span><span class="n">subsort</span><span class="p">,</span> <span class="n">supersort</span><span class="p">,</span> <span class="n">subsubsorts</span><span class="p">))</span>
<span class="linenos"> 534</span>
<span class="linenos"> 535</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_retr_alts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subsort</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">supersort</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">subsubsorts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Alt</span><span class="p">]:</span>
<span class="linenos"> 536</span>        <span class="k">def</span><span class="w"> </span><span class="nf">inj</span><span class="p">(</span><span class="n">subsort</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">supersort</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Term</span><span class="p">:</span>
<span class="linenos"> 537</span>            <span class="k">return</span> <span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">supersort</span><span class="si">}</span><span class="s1">.inj_</span><span class="si">{</span><span class="n">subsort</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos"> 538</span>
<span class="linenos"> 539</span>        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 540</span>        <span class="k">for</span> <span class="n">subsubsort</span> <span class="ow">in</span> <span class="n">subsubsorts</span><span class="p">:</span>
<span class="linenos"> 541</span>            <span class="n">res_inj</span> <span class="o">=</span> <span class="n">inj</span><span class="p">(</span><span class="n">subsubsort</span><span class="p">,</span> <span class="n">subsort</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="linenos"> 542</span>            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Alt</span><span class="p">((</span><span class="n">inj</span><span class="p">(</span><span class="n">subsubsort</span><span class="p">,</span> <span class="n">supersort</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">),),</span> <span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;some (</span><span class="si">{</span><span class="n">res_inj</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)))</span>
<span class="linenos"> 543</span>
<span class="linenos"> 544</span>        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Alt</span><span class="p">((</span><span class="n">inj</span><span class="p">(</span><span class="n">subsort</span><span class="p">,</span> <span class="n">supersort</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">),),</span> <span class="n">Term</span><span class="p">(</span><span class="s1">&#39;some x&#39;</span><span class="p">)))</span>
<span class="linenos"> 545</span>
<span class="linenos"> 546</span>        <span class="n">n_covered</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">subsubsorts</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="linenos"> 547</span>        <span class="n">n_ctors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">constructors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">supersort</span><span class="p">,</span> <span class="p">()))</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">subsorts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">supersort</span><span class="p">,</span> <span class="p">()))</span>
<span class="linenos"> 548</span>        <span class="k">if</span> <span class="n">n_ctors</span> <span class="o">&gt;</span> <span class="n">n_covered</span><span class="p">:</span>
<span class="linenos"> 549</span>            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Alt</span><span class="p">((</span><span class="n">Term</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">),),</span> <span class="n">Term</span><span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">)))</span>
<span class="linenos"> 550</span>
<span class="linenos"> 551</span>        <span class="k">return</span> <span class="n">res</span>
<span class="linenos"> 552</span>
<div class="viewcode-block" id="K2Lean4.func_module">
<a class="viewcode-back" href="../../../api/pyk.klean.k2lean4.html#pyk.klean.k2lean4.K2Lean4.func_module">[docs]</a>
<span class="linenos"> 553</span>    <span class="k">def</span><span class="w"> </span><span class="nf">func_module</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Module</span><span class="p">:</span>
<span class="linenos"> 554</span>        <span class="n">sccs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func_sccs</span>
<span class="linenos"> 555</span>        <span class="k">return</span> <span class="n">Module</span><span class="p">(</span><span class="n">commands</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">command</span> <span class="k">for</span> <span class="n">elems</span> <span class="ow">in</span> <span class="n">sccs</span> <span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func_block</span><span class="p">(</span><span class="n">elems</span><span class="p">))))</span></div>

<span class="linenos"> 556</span>
<span class="linenos"> 557</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_func_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elems</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Command</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 558</span>        <span class="k">assert</span> <span class="n">elems</span>
<span class="linenos"> 559</span>        <span class="n">elems</span> <span class="o">=</span> <span class="p">[</span><span class="n">elem</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">elems</span> <span class="k">if</span> <span class="n">elem</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_PRELUDE_FUNCS</span><span class="p">]</span>
<span class="linenos"> 560</span>
<span class="linenos"> 561</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">elems</span><span class="p">:</span>
<span class="linenos"> 562</span>            <span class="k">return</span> <span class="kc">None</span>
<span class="linenos"> 563</span>
<span class="linenos"> 564</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">elems</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos"> 565</span>            <span class="p">(</span><span class="n">elem</span><span class="p">,)</span> <span class="o">=</span> <span class="n">elems</span>
<span class="linenos"> 566</span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func_command</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
<span class="linenos"> 567</span>
<span class="linenos"> 568</span>        <span class="k">return</span> <span class="n">Mutual</span><span class="p">(</span><span class="n">commands</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_func_command</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">elems</span><span class="p">))</span>
<span class="linenos"> 569</span>
<span class="linenos"> 570</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_func_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Command</span><span class="p">:</span>
<span class="linenos"> 571</span>        <span class="k">if</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">functions</span><span class="p">:</span>
<span class="linenos"> 572</span>            <span class="n">decl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">elem</span><span class="p">]</span>
<span class="linenos"> 573</span>            <span class="n">rules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">functions</span><span class="p">[</span><span class="n">elem</span><span class="p">]</span>
<span class="linenos"> 574</span>            <span class="k">if</span> <span class="n">rules</span><span class="p">:</span>
<span class="linenos"> 575</span>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func_def</span><span class="p">(</span><span class="n">decl</span><span class="p">,</span> <span class="n">rules</span><span class="p">)</span>
<span class="linenos"> 576</span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func_axiom</span><span class="p">(</span><span class="n">decl</span><span class="p">)</span>
<span class="linenos"> 577</span>        <span class="n">rule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func_rules_by_uid</span><span class="p">[</span><span class="n">elem</span><span class="p">]</span>
<span class="linenos"> 578</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func_rule_def</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
<span class="linenos"> 579</span>
<span class="linenos"> 580</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_func_def</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">decl</span><span class="p">:</span> <span class="n">SymbolDecl</span><span class="p">,</span> <span class="n">rules</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">FunctionRule</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Definition</span><span class="p">:</span>
<span class="linenos"> 581</span>        <span class="k">def</span><span class="w"> </span><span class="nf">sort_rules_by_priority</span><span class="p">(</span><span class="n">rules</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">FunctionRule</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="linenos"> 582</span>            <span class="n">grouped</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 583</span>            <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
<span class="linenos"> 584</span>                <span class="n">grouped</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">priority</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_rule_name</span><span class="p">(</span><span class="n">rule</span><span class="p">))</span>
<span class="linenos"> 585</span>            <span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sorted</span><span class="p">(</span><span class="n">grouped</span><span class="p">[</span><span class="n">priority</span><span class="p">])</span> <span class="k">for</span> <span class="n">priority</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">grouped</span><span class="p">)]</span>
<span class="linenos"> 586</span>            <span class="k">return</span> <span class="p">[</span><span class="n">rule</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span> <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">group</span><span class="p">]</span>
<span class="linenos"> 587</span>
<span class="linenos"> 588</span>        <span class="k">assert</span> <span class="n">rules</span>
<span class="linenos"> 589</span>
<span class="linenos"> 590</span>        <span class="n">sorted_rules</span> <span class="o">=</span> <span class="n">sort_rules_by_priority</span><span class="p">(</span><span class="n">rules</span><span class="p">)</span>
<span class="linenos"> 591</span>        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;x</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">decl</span><span class="o">.</span><span class="n">param_sorts</span><span class="p">))]</span>
<span class="linenos"> 592</span>        <span class="n">arg_str</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">if</span> <span class="n">params</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
<span class="linenos"> 593</span>        <span class="n">term</span><span class="p">:</span> <span class="n">Term</span>
<span class="linenos"> 594</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_rules</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos"> 595</span>            <span class="n">rule_str</span> <span class="o">=</span> <span class="n">sorted_rules</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 596</span>            <span class="n">term</span> <span class="o">=</span> <span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">rule_str</span><span class="si">}{</span><span class="n">arg_str</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos"> 597</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 598</span>            <span class="k">assert</span> <span class="n">arg_str</span>  <span class="c1"># a function with multiple rules is not nullary</span>
<span class="linenos"> 599</span>            <span class="n">rules_str</span> <span class="o">=</span> <span class="s1">&#39; &lt;|&gt; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">rule_str</span><span class="si">}{</span><span class="n">arg_str</span><span class="si">}</span><span class="s1">)&#39;</span> <span class="k">for</span> <span class="n">rule_str</span> <span class="ow">in</span> <span class="n">sorted_rules</span><span class="p">)</span>
<span class="linenos"> 600</span>            <span class="n">term</span> <span class="o">=</span> <span class="n">Term</span><span class="p">(</span><span class="n">rules_str</span><span class="p">)</span>
<span class="linenos"> 601</span>
<span class="linenos"> 602</span>        <span class="n">val</span> <span class="o">=</span> <span class="n">SimpleVal</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
<span class="linenos"> 603</span>        <span class="n">func</span> <span class="o">=</span> <span class="n">decl</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">name</span>
<span class="linenos"> 604</span>        <span class="n">ident</span> <span class="o">=</span> <span class="n">_symbol_ident</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
<span class="linenos"> 605</span>        <span class="n">signature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func_signature</span><span class="p">(</span><span class="n">decl</span><span class="p">)</span>
<span class="linenos"> 606</span>        <span class="n">modifiers</span> <span class="o">=</span> <span class="n">Modifiers</span><span class="p">(</span><span class="n">noncomputable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">noncomputable</span> <span class="k">else</span> <span class="kc">None</span>
<span class="linenos"> 607</span>
<span class="linenos"> 608</span>        <span class="k">return</span> <span class="n">Definition</span><span class="p">(</span><span class="n">ident</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">modifiers</span><span class="o">=</span><span class="n">modifiers</span><span class="p">)</span>
<span class="linenos"> 609</span>
<span class="linenos"> 610</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_func_rule_def</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">:</span> <span class="n">FunctionRule</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Definition</span><span class="p">:</span>
<span class="linenos"> 611</span>        <span class="n">decl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">rule</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">symbol</span><span class="p">]</span>
<span class="linenos"> 612</span>        <span class="n">sort_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">decl</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">vars</span><span class="p">]</span>
<span class="linenos"> 613</span>        <span class="n">param_sorts</span> <span class="o">=</span> <span class="p">[</span><span class="n">sort</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">sort</span> <span class="ow">in</span> <span class="n">decl</span><span class="o">.</span><span class="n">param_sorts</span><span class="p">]</span>
<span class="linenos"> 614</span>        <span class="n">sort</span> <span class="o">=</span> <span class="n">decl</span><span class="o">.</span><span class="n">sort</span><span class="o">.</span><span class="n">name</span>
<span class="linenos"> 615</span>
<span class="linenos"> 616</span>        <span class="n">ident</span> <span class="o">=</span> <span class="n">_rule_name</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
<span class="linenos"> 617</span>        <span class="n">binders</span> <span class="o">=</span> <span class="p">(</span><span class="n">ImplBinder</span><span class="p">(</span><span class="n">sort_params</span><span class="p">,</span> <span class="n">Term</span><span class="p">(</span><span class="s1">&#39;Type&#39;</span><span class="p">)),)</span> <span class="k">if</span> <span class="n">sort_params</span> <span class="k">else</span> <span class="p">()</span>
<span class="linenos"> 618</span>        <span class="n">ty</span> <span class="o">=</span> <span class="n">Term</span><span class="p">(</span><span class="s1">&#39; → &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">param_sorts</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Option </span><span class="si">{</span><span class="n">sort</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]))</span>
<span class="linenos"> 619</span>        <span class="n">modifiers</span> <span class="o">=</span> <span class="n">Modifiers</span><span class="p">(</span><span class="n">noncomputable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">rule</span><span class="o">.</span><span class="n">uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">noncomputable</span> <span class="k">else</span> <span class="kc">None</span>
<span class="linenos"> 620</span>        <span class="n">signature</span> <span class="o">=</span> <span class="n">Signature</span><span class="p">(</span><span class="n">binders</span><span class="p">,</span> <span class="n">ty</span><span class="p">)</span>
<span class="linenos"> 621</span>
<span class="linenos"> 622</span>        <span class="n">req</span><span class="p">,</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">defs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_func_rule</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
<span class="linenos"> 623</span>        <span class="n">free</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Var&#39;Unds&#39;Pat</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">count</span><span class="p">())</span>
<span class="linenos"> 624</span>        <span class="n">args</span><span class="p">,</span> <span class="n">matchers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func_rule_matchers</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">free</span><span class="p">)</span>
<span class="linenos"> 625</span>        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func_rule_val</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">matchers</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">defs</span><span class="p">)</span>
<span class="linenos"> 626</span>
<span class="linenos"> 627</span>        <span class="k">return</span> <span class="n">Definition</span><span class="p">(</span><span class="n">ident</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">modifiers</span><span class="o">=</span><span class="n">modifiers</span><span class="p">)</span>
<span class="linenos"> 628</span>
<span class="linenos"> 629</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_func_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">:</span> <span class="n">FunctionRule</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Pattern</span><span class="p">,</span> <span class="n">App</span><span class="p">,</span> <span class="n">Pattern</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Pattern</span><span class="p">]]:</span>
<span class="linenos"> 630</span>        <span class="n">req</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">req</span> <span class="k">if</span> <span class="n">rule</span><span class="o">.</span><span class="n">req</span> <span class="k">else</span> <span class="n">Top</span><span class="p">(</span><span class="n">SortApp</span><span class="p">(</span><span class="s1">&#39;Foo&#39;</span><span class="p">))</span>
<span class="linenos"> 631</span>
<span class="linenos"> 632</span>        <span class="n">pattern</span> <span class="o">=</span> <span class="n">elim_aliases</span><span class="p">(</span><span class="n">And</span><span class="p">(</span><span class="n">SortApp</span><span class="p">(</span><span class="s1">&#39;Foo&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">rhs</span><span class="p">)))</span>
<span class="linenos"> 633</span>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">And</span><span class="p">)</span>
<span class="linenos"> 634</span>        <span class="n">req</span><span class="p">,</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">ops</span>
<span class="linenos"> 635</span>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">App</span><span class="p">)</span>
<span class="linenos"> 636</span>
<span class="linenos"> 637</span>        <span class="n">free</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Var&#39;Unds&#39;Val</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">count</span><span class="p">())</span>
<span class="linenos"> 638</span>        <span class="n">pattern</span><span class="p">,</span> <span class="n">defs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elim_fun_apps</span><span class="p">(</span><span class="n">And</span><span class="p">(</span><span class="n">SortApp</span><span class="p">(</span><span class="s1">&#39;Foo&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)),</span> <span class="n">free</span><span class="p">)</span>
<span class="linenos"> 639</span>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">And</span><span class="p">)</span>
<span class="linenos"> 640</span>        <span class="n">req</span><span class="p">,</span> <span class="n">rhs</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">ops</span>
<span class="linenos"> 641</span>
<span class="linenos"> 642</span>        <span class="k">return</span> <span class="n">req</span><span class="p">,</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">defs</span>
<span class="linenos"> 643</span>
<span class="linenos"> 644</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_func_rule_val</span><span class="p">(</span>
<span class="linenos"> 645</span>        <span class="bp">self</span><span class="p">,</span>
<span class="linenos"> 646</span>        <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Pattern</span><span class="p">],</span>
<span class="linenos"> 647</span>        <span class="n">matchers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Matcher</span><span class="p">]],</span>
<span class="linenos"> 648</span>        <span class="n">req</span><span class="p">:</span> <span class="n">Pattern</span><span class="p">,</span>
<span class="linenos"> 649</span>        <span class="n">rhs</span><span class="p">:</span> <span class="n">Pattern</span><span class="p">,</span>
<span class="linenos"> 650</span>        <span class="n">defs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Pattern</span><span class="p">],</span>
<span class="linenos"> 651</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DeclVal</span><span class="p">:</span>
<span class="linenos"> 652</span>        <span class="n">rhs_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func_rule_rhs</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">defs</span><span class="p">)</span>
<span class="linenos"> 653</span>        <span class="n">term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func_rule_term</span><span class="p">(</span><span class="n">matchers</span><span class="p">,</span> <span class="n">rhs_term</span><span class="p">)</span>
<span class="linenos"> 654</span>
<span class="linenos"> 655</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
<span class="linenos"> 656</span>            <span class="k">return</span> <span class="n">SimpleVal</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
<span class="linenos"> 657</span>
<span class="linenos"> 658</span>        <span class="n">alts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Alt</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 659</span>
<span class="linenos"> 660</span>        <span class="n">match_alt</span> <span class="o">=</span> <span class="n">Alt</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transform_pattern</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">concrete</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">),</span> <span class="n">term</span><span class="p">)</span>
<span class="linenos"> 661</span>        <span class="n">alts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">match_alt</span><span class="p">)</span>
<span class="linenos"> 662</span>
<span class="linenos"> 663</span>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_exhaustive</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>
<span class="linenos"> 664</span>            <span class="n">nomatch_alt</span> <span class="o">=</span> <span class="n">Alt</span><span class="p">((</span><span class="n">Term</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">),)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="n">Term</span><span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">))</span>
<span class="linenos"> 665</span>            <span class="n">alts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nomatch_alt</span><span class="p">)</span>
<span class="linenos"> 666</span>
<span class="linenos"> 667</span>        <span class="k">return</span> <span class="n">AltsVal</span><span class="p">(</span><span class="n">alts</span><span class="p">)</span>
<span class="linenos"> 668</span>
<span class="linenos"> 669</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_func_rule_term</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matchers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Matcher</span><span class="p">]],</span> <span class="n">rhs</span><span class="p">:</span> <span class="n">Term</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Term</span><span class="p">:</span>
<span class="linenos"> 670</span>        <span class="k">def</span><span class="w"> </span><span class="nf">indent_rest</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="linenos"> 671</span>            <span class="n">lines</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
<span class="linenos"> 672</span>            <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]])</span>
<span class="linenos"> 673</span>
<span class="linenos"> 674</span>        <span class="n">match_groups</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos"> 675</span>            <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_matcher_to_terms</span><span class="p">(</span><span class="n">matcher</span><span class="p">)</span> <span class="k">for</span> <span class="n">matcher</span> <span class="ow">in</span> <span class="n">group</span><span class="p">),</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">matchers</span>
<span class="linenos"> 676</span>        <span class="p">]</span>
<span class="linenos"> 677</span>
<span class="linenos"> 678</span>        <span class="n">res</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span>
<span class="linenos"> 679</span>        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">match_groups</span><span class="p">):</span>
<span class="linenos"> 680</span>            <span class="n">args_str</span> <span class="o">=</span> <span class="s1">&#39;match </span><span class="si">{args}</span><span class="s1"> with</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">term</span><span class="p">)</span> <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">group</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="linenos"> 681</span>            <span class="n">match_str</span> <span class="o">=</span> <span class="s1">&#39;  | </span><span class="si">{matches}</span><span class="s1"> =&gt; </span><span class="si">{res}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<span class="linenos"> 682</span>                <span class="n">matches</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">term</span><span class="p">)</span> <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">group</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">res</span><span class="o">=</span><span class="n">indent_rest</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="linenos"> 683</span>            <span class="p">)</span>
<span class="linenos"> 684</span>            <span class="n">nomatch_str</span> <span class="o">=</span> <span class="s1">&#39;  | </span><span class="si">{no_matches}</span><span class="s1"> =&gt; none&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">no_matches</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;_&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
<span class="linenos"> 685</span>            <span class="n">res</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">args_str</span><span class="si">}{</span><span class="n">match_str</span><span class="si">}{</span><span class="n">nomatch_str</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="linenos"> 686</span>
<span class="linenos"> 687</span>        <span class="k">return</span> <span class="n">Term</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<span class="linenos"> 688</span>
<span class="linenos"> 689</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_matcher_to_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matcher</span><span class="p">:</span> <span class="n">Matcher</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Term</span><span class="p">,</span> <span class="n">Term</span><span class="p">]:</span>
<span class="linenos"> 690</span>        <span class="k">def</span><span class="w"> </span><span class="nf">list_from</span><span class="p">(</span><span class="n">elems</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Pattern</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Term</span><span class="p">:</span>
<span class="linenos"> 691</span>            <span class="n">elems_str</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transform_pattern</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">concrete</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">elems</span><span class="p">)</span>
<span class="linenos"> 692</span>            <span class="k">return</span> <span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="n">elems_str</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>
<span class="linenos"> 693</span>
<span class="linenos"> 694</span>        <span class="k">match</span> <span class="n">matcher</span><span class="p">:</span>
<span class="linenos"> 695</span>            <span class="k">case</span> <span class="n">EqMatcher</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="n">var2</span><span class="p">):</span>
<span class="linenos"> 696</span>                <span class="n">v1term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_pattern</span><span class="p">(</span><span class="n">var1</span><span class="p">)</span>
<span class="linenos"> 697</span>                <span class="n">v2term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_pattern</span><span class="p">(</span><span class="n">var2</span><span class="p">)</span>
<span class="linenos"> 698</span>                <span class="k">return</span> <span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">v1term</span><span class="si">}</span><span class="s1"> == </span><span class="si">{</span><span class="n">v2term</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">Term</span><span class="p">(</span><span class="s1">&#39;true&#39;</span><span class="p">)</span>
<span class="linenos"> 699</span>            <span class="k">case</span> <span class="n">SubsortMatcher</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">subsort</span><span class="p">,</span> <span class="n">supersort</span><span class="p">,</span> <span class="n">pat</span><span class="p">):</span>
<span class="linenos"> 700</span>                <span class="n">vterm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_pattern</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
<span class="linenos"> 701</span>                <span class="n">pterm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_arg</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">concrete</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 702</span>                <span class="k">return</span> <span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;(@retr </span><span class="si">{</span><span class="n">subsort</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">supersort</span><span class="si">}</span><span class="s1">) </span><span class="si">{</span><span class="n">vterm</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;some </span><span class="si">{</span><span class="n">pterm</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos"> 703</span>            <span class="k">case</span> <span class="n">ListMatcher</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">middle</span><span class="p">,</span> <span class="n">suffix</span><span class="p">):</span>
<span class="linenos"> 704</span>                <span class="n">vterm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_pattern</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
<span class="linenos"> 705</span>                <span class="n">arg</span> <span class="o">=</span> <span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;(ListHook SortKItem).split </span><span class="si">{</span><span class="n">vterm</span><span class="si">}</span><span class="s1">.coll </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos"> 706</span>                <span class="n">pterm</span> <span class="o">=</span> <span class="n">list_from</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
<span class="linenos"> 707</span>                <span class="n">mterm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_pattern</span><span class="p">(</span><span class="n">middle</span><span class="p">,</span> <span class="n">concrete</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 708</span>                <span class="n">sterm</span> <span class="o">=</span> <span class="n">list_from</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>
<span class="linenos"> 709</span>                <span class="n">pattern</span> <span class="o">=</span> <span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;some (</span><span class="si">{</span><span class="n">pterm</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">mterm</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">sterm</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="linenos"> 710</span>                <span class="k">return</span> <span class="n">arg</span><span class="p">,</span> <span class="n">pattern</span>
<span class="linenos"> 711</span>            <span class="k">case</span> <span class="n">EmptyListMatcher</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
<span class="linenos"> 712</span>                <span class="n">vterm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_pattern</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
<span class="linenos"> 713</span>                <span class="n">arg</span> <span class="o">=</span> <span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;(ListHook SortKItem).size </span><span class="si">{</span><span class="n">vterm</span><span class="si">}</span><span class="s1">.coll&#39;</span><span class="p">)</span>
<span class="linenos"> 714</span>                <span class="n">pattern</span> <span class="o">=</span> <span class="n">Term</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
<span class="linenos"> 715</span>                <span class="k">return</span> <span class="n">arg</span><span class="p">,</span> <span class="n">pattern</span>
<span class="linenos"> 716</span>            <span class="k">case</span> <span class="n">SetMatcher</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">elems</span><span class="p">,</span> <span class="n">rest</span><span class="p">):</span>
<span class="linenos"> 717</span>                <span class="n">vterm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_pattern</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
<span class="linenos"> 718</span>                <span class="n">eterm</span> <span class="o">=</span> <span class="n">list_from</span><span class="p">(</span><span class="n">elems</span><span class="p">)</span>
<span class="linenos"> 719</span>                <span class="n">rterm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_arg</span><span class="p">(</span><span class="n">rest</span><span class="p">,</span> <span class="n">concrete</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 720</span>                <span class="n">arg</span> <span class="o">=</span> <span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;(SetHook SortKItem).split </span><span class="si">{</span><span class="n">vterm</span><span class="si">}</span><span class="s1">.coll </span><span class="si">{</span><span class="n">eterm</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos"> 721</span>                <span class="n">pattern</span> <span class="o">=</span> <span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;some </span><span class="si">{</span><span class="n">rterm</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos"> 722</span>                <span class="k">return</span> <span class="n">arg</span><span class="p">,</span> <span class="n">pattern</span>
<span class="linenos"> 723</span>            <span class="k">case</span> <span class="n">EmptySetMatcher</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
<span class="linenos"> 724</span>                <span class="n">vterm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_pattern</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
<span class="linenos"> 725</span>                <span class="n">arg</span> <span class="o">=</span> <span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;(SetHook SortKItem).size </span><span class="si">{</span><span class="n">vterm</span><span class="si">}</span><span class="s1">.coll&#39;</span><span class="p">)</span>
<span class="linenos"> 726</span>                <span class="n">pattern</span> <span class="o">=</span> <span class="n">Term</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
<span class="linenos"> 727</span>                <span class="k">return</span> <span class="n">arg</span><span class="p">,</span> <span class="n">pattern</span>
<span class="linenos"> 728</span>            <span class="k">case</span> <span class="n">MapMatcher</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">key_sort</span><span class="p">,</span> <span class="n">value_sort</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">rest</span><span class="p">):</span>
<span class="linenos"> 729</span>                <span class="n">vterm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_pattern</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
<span class="linenos"> 730</span>                <span class="n">kterm</span> <span class="o">=</span> <span class="n">list_from</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
<span class="linenos"> 731</span>                <span class="n">arg</span> <span class="o">=</span> <span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;(MapHook </span><span class="si">{</span><span class="n">key_sort</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">value_sort</span><span class="si">}</span><span class="s1">).split </span><span class="si">{</span><span class="n">vterm</span><span class="si">}</span><span class="s1">.coll </span><span class="si">{</span><span class="n">kterm</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos"> 732</span>                <span class="n">vterm</span> <span class="o">=</span> <span class="n">list_from</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
<span class="linenos"> 733</span>                <span class="n">rterm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_pattern</span><span class="p">(</span><span class="n">rest</span><span class="p">,</span> <span class="n">concrete</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 734</span>                <span class="n">pattern</span> <span class="o">=</span> <span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;some (</span><span class="si">{</span><span class="n">vterm</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">rterm</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="linenos"> 735</span>                <span class="k">return</span> <span class="n">arg</span><span class="p">,</span> <span class="n">pattern</span>
<span class="linenos"> 736</span>            <span class="k">case</span> <span class="n">EmptyMapMatcher</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">key_sort</span><span class="p">,</span> <span class="n">value_sort</span><span class="p">):</span>
<span class="linenos"> 737</span>                <span class="n">vterm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_pattern</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
<span class="linenos"> 738</span>                <span class="n">arg</span> <span class="o">=</span> <span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;(MapHook </span><span class="si">{</span><span class="n">key_sort</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">value_sort</span><span class="si">}</span><span class="s1">).size </span><span class="si">{</span><span class="n">vterm</span><span class="si">}</span><span class="s1">.coll&#39;</span><span class="p">)</span>
<span class="linenos"> 739</span>                <span class="n">pattern</span> <span class="o">=</span> <span class="n">Term</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
<span class="linenos"> 740</span>                <span class="k">return</span> <span class="n">arg</span><span class="p">,</span> <span class="n">pattern</span>
<span class="linenos"> 741</span>            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
<span class="linenos"> 742</span>                <span class="k">raise</span> <span class="ne">AssertionError</span>
<span class="linenos"> 743</span>
<span class="linenos"> 744</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_func_rule_rhs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">Pattern</span><span class="p">,</span> <span class="n">rhs</span><span class="p">:</span> <span class="n">Pattern</span><span class="p">,</span> <span class="n">defs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Pattern</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Term</span><span class="p">:</span>
<span class="linenos"> 745</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">defs</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">Top</span><span class="p">):</span>
<span class="linenos"> 746</span>            <span class="k">return</span> <span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;some </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_transform_arg</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos"> 747</span>
<span class="linenos"> 748</span>        <span class="n">seq_strs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 749</span>        <span class="n">seq_strs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;let </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1"> &lt;- </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_transform_pattern</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">defs</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
<span class="linenos"> 750</span>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">Top</span><span class="p">):</span>
<span class="linenos"> 751</span>            <span class="n">seq_strs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;guard </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_transform_arg</span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos"> 752</span>        <span class="n">seq_strs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;return </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_transform_arg</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos"> 753</span>        <span class="n">do_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">seq_str</span> <span class="k">for</span> <span class="n">seq_str</span> <span class="ow">in</span> <span class="n">seq_strs</span><span class="p">)</span>
<span class="linenos"> 754</span>        <span class="k">return</span> <span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;do</span><span class="se">\n</span><span class="si">{</span><span class="n">do_str</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos"> 755</span>
<span class="linenos"> 756</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_is_exhaustive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">:</span> <span class="n">Pattern</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="linenos"> 757</span>        <span class="k">match</span> <span class="n">pattern</span><span class="p">:</span>
<span class="linenos"> 758</span>            <span class="k">case</span> <span class="n">DV</span><span class="p">():</span>
<span class="linenos"> 759</span>                <span class="k">return</span> <span class="kc">False</span>
<span class="linenos"> 760</span>            <span class="k">case</span> <span class="n">EVar</span><span class="p">():</span>
<span class="linenos"> 761</span>                <span class="k">return</span> <span class="kc">True</span>
<span class="linenos"> 762</span>            <span class="k">case</span><span class="w"> </span><span class="n">App</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="k">_</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="k">as</span> <span class="n">app</span><span class="p">:</span>
<span class="linenos"> 763</span>                <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">functions</span><span class="p">:</span>
<span class="linenos"> 764</span>                    <span class="c1"># Collection function</span>
<span class="linenos"> 765</span>                    <span class="k">return</span> <span class="kc">False</span>
<span class="linenos"> 766</span>
<span class="linenos"> 767</span>                <span class="n">_sort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol_table</span><span class="o">.</span><span class="n">infer_sort</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="linenos"> 768</span>                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_sort</span><span class="p">,</span> <span class="n">SortApp</span><span class="p">)</span>
<span class="linenos"> 769</span>                <span class="n">sort</span> <span class="o">=</span> <span class="n">_sort</span><span class="o">.</span><span class="n">name</span>
<span class="linenos"> 770</span>                <span class="n">n_ctors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">constructors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sort</span><span class="p">,</span> <span class="p">()))</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">subsorts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sort</span><span class="p">,</span> <span class="p">()))</span>
<span class="linenos"> 771</span>                <span class="k">assert</span> <span class="n">n_ctors</span>
<span class="linenos"> 772</span>                <span class="k">return</span> <span class="n">n_ctors</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_exhaustive</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">)</span>
<span class="linenos"> 773</span>            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
<span class="linenos"> 774</span>                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">()</span>
<span class="linenos"> 775</span>
<span class="linenos"> 776</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_func_rule_matchers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lhs</span><span class="p">:</span> <span class="n">Pattern</span><span class="p">,</span> <span class="n">free</span><span class="p">:</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Pattern</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Matcher</span><span class="p">]]]:</span>
<span class="linenos"> 777</span>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">App</span><span class="p">)</span>  <span class="c1"># pattern is the LHS of a function rule</span>
<span class="linenos"> 778</span>
<span class="linenos"> 779</span>        <span class="n">matchers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Matcher</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 780</span>
<span class="linenos"> 781</span>        <span class="k">def</span><span class="w"> </span><span class="nf">rename_outputs</span><span class="p">(</span><span class="n">pattern</span><span class="p">:</span> <span class="n">Pattern</span><span class="p">,</span> <span class="n">free</span><span class="p">:</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Pattern</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">EVar</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="linenos"> 782</span>            <span class="n">var_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">free_occs</span><span class="p">(</span><span class="n">pattern</span><span class="p">))</span>
<span class="linenos"> 783</span>            <span class="n">class_idx</span> <span class="o">=</span> <span class="n">count</span><span class="p">()</span>
<span class="linenos"> 784</span>            <span class="n">classes</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 785</span>
<span class="linenos"> 786</span>            <span class="k">def</span><span class="w"> </span><span class="nf">rename</span><span class="p">(</span><span class="n">pattern</span><span class="p">:</span> <span class="n">Pattern</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Pattern</span><span class="p">:</span>
<span class="linenos"> 787</span>                <span class="k">match</span> <span class="n">pattern</span><span class="p">:</span>
<span class="linenos"> 788</span>                    <span class="k">case</span> <span class="n">EVar</span><span class="p">()</span> <span class="k">as</span> <span class="n">var</span><span class="p">:</span>
<span class="linenos"> 789</span>                        <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
<span class="linenos"> 790</span>                            <span class="n">classes</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">class_idx</span><span class="p">)</span>
<span class="linenos"> 791</span>                            <span class="k">return</span> <span class="n">pattern</span>
<span class="linenos"> 792</span>
<span class="linenos"> 793</span>                        <span class="k">while</span> <span class="p">(</span><span class="n">new_name</span> <span class="o">:=</span> <span class="nb">next</span><span class="p">(</span><span class="n">free</span><span class="p">))</span> <span class="ow">in</span> <span class="n">var_names</span><span class="p">:</span>
<span class="linenos"> 794</span>                            <span class="k">continue</span>
<span class="linenos"> 795</span>
<span class="linenos"> 796</span>                        <span class="n">var_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_name</span><span class="p">)</span>
<span class="linenos"> 797</span>                        <span class="n">new_var</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">let</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">new_name</span><span class="p">)</span>
<span class="linenos"> 798</span>                        <span class="n">classes</span><span class="p">[</span><span class="n">new_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">classes</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
<span class="linenos"> 799</span>                        <span class="k">return</span> <span class="n">new_var</span>
<span class="linenos"> 800</span>                    <span class="k">case</span> <span class="n">App</span><span class="p">(</span><span class="s1">&#39;LblSetItem&#39;</span><span class="p">):</span>
<span class="linenos"> 801</span>                        <span class="k">return</span> <span class="n">pattern</span>  <span class="c1"># the arg is input</span>
<span class="linenos"> 802</span>                    <span class="k">case</span> <span class="n">App</span><span class="p">(</span><span class="s2">&quot;Lbl&#39;UndsPipe&#39;-&#39;-GT-Unds&#39;&quot;</span><span class="p">,</span> <span class="p">(),</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)):</span>
<span class="linenos"> 803</span>                        <span class="k">return</span> <span class="n">pattern</span><span class="o">.</span><span class="n">let</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">rename</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>  <span class="c1"># the key is input</span>
<span class="linenos"> 804</span>                    <span class="k">case</span> <span class="n">App</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="p">(),</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)):</span>
<span class="linenos"> 805</span>                        <span class="k">if</span> <span class="n">symbol</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;CellMapItem&#39;</span><span class="p">):</span>
<span class="linenos"> 806</span>                            <span class="k">return</span> <span class="n">pattern</span><span class="o">.</span><span class="n">let</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">rename</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>  <span class="c1"># the key is input</span>
<span class="linenos"> 807</span>
<span class="linenos"> 808</span>                <span class="k">return</span> <span class="n">pattern</span><span class="o">.</span><span class="n">let_patterns</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">rename</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">pattern</span><span class="o">.</span><span class="n">patterns</span><span class="p">))</span>
<span class="linenos"> 809</span>
<span class="linenos"> 810</span>            <span class="k">return</span> <span class="n">rename</span><span class="p">(</span><span class="n">pattern</span><span class="p">),</span> <span class="n">classes</span>
<span class="linenos"> 811</span>
<span class="linenos"> 812</span>        <span class="k">def</span><span class="w"> </span><span class="nf">eq_matchers</span><span class="p">(</span><span class="n">classes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">EVar</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">EqMatcher</span><span class="p">]:</span>
<span class="linenos"> 813</span>            <span class="n">grouped</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">EVar</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 814</span>            <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">classes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos"> 815</span>                <span class="n">grouped</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
<span class="linenos"> 816</span>
<span class="linenos"> 817</span>            <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 818</span>            <span class="k">for</span> <span class="n">clazz</span> <span class="ow">in</span> <span class="n">grouped</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<span class="linenos"> 819</span>                <span class="k">assert</span> <span class="n">clazz</span>
<span class="linenos"> 820</span>                <span class="n">representative</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span> <span class="o">=</span> <span class="n">clazz</span>
<span class="linenos"> 821</span>                <span class="k">for</span> <span class="n">other</span> <span class="ow">in</span> <span class="n">rest</span><span class="p">:</span>
<span class="linenos"> 822</span>                    <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EqMatcher</span><span class="p">(</span><span class="n">representative</span><span class="p">,</span> <span class="n">other</span><span class="p">))</span>
<span class="linenos"> 823</span>
<span class="linenos"> 824</span>            <span class="k">return</span> <span class="n">res</span>
<span class="linenos"> 825</span>
<span class="linenos"> 826</span>        <span class="k">def</span><span class="w"> </span><span class="nf">abstract_matchers</span><span class="p">(</span><span class="n">pattern</span><span class="p">:</span> <span class="n">Pattern</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Pattern</span><span class="p">:</span>
<span class="linenos"> 827</span>            <span class="k">match</span> <span class="n">pattern</span><span class="p">:</span>
<span class="linenos"> 828</span>                <span class="k">case</span> <span class="n">App</span><span class="p">(</span><span class="s1">&#39;inj&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">SortApp</span><span class="p">(</span><span class="n">subsort</span><span class="p">),</span> <span class="n">SortApp</span><span class="p">(</span><span class="n">supersort</span><span class="p">)),</span> <span class="p">(</span><span class="n">pat</span><span class="p">,)):</span>
<span class="linenos"> 829</span>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">subsorts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subsort</span><span class="p">)</span> <span class="ow">and</span> <span class="n">free_occs</span><span class="p">(</span><span class="n">pat</span><span class="p">):</span>
<span class="linenos"> 830</span>                        <span class="n">var</span> <span class="o">=</span> <span class="n">EVar</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">free</span><span class="p">),</span> <span class="n">SortApp</span><span class="p">(</span><span class="n">supersort</span><span class="p">))</span>
<span class="linenos"> 831</span>                        <span class="n">matchers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SubsortMatcher</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">subsort</span><span class="p">,</span> <span class="n">supersort</span><span class="p">,</span> <span class="n">pat</span><span class="p">))</span>
<span class="linenos"> 832</span>                        <span class="k">return</span> <span class="n">var</span>
<span class="linenos"> 833</span>                <span class="k">case</span> <span class="n">App</span><span class="p">(</span><span class="s2">&quot;Lbl&#39;Unds&#39;List&#39;Unds&#39;&quot;</span><span class="p">,</span> <span class="p">(),</span> <span class="p">(</span><span class="n">App</span><span class="p">(</span><span class="s1">&#39;LblListItem&#39;</span><span class="p">,</span> <span class="p">(),</span> <span class="p">(</span><span class="n">head</span><span class="p">,)),</span> <span class="n">tail</span><span class="p">)):</span>
<span class="linenos"> 834</span>                    <span class="n">var</span> <span class="o">=</span> <span class="n">EVar</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">free</span><span class="p">),</span> <span class="n">SortApp</span><span class="p">(</span><span class="s1">&#39;SortList&#39;</span><span class="p">))</span>
<span class="linenos"> 835</span>                    <span class="n">matchers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ListMatcher</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="p">(</span><span class="n">head</span><span class="p">,),</span> <span class="n">tail</span><span class="p">,</span> <span class="p">()))</span>
<span class="linenos"> 836</span>                    <span class="k">return</span> <span class="n">var</span>
<span class="linenos"> 837</span>                <span class="k">case</span> <span class="n">App</span><span class="p">(</span><span class="s2">&quot;Lbl&#39;Unds&#39;List&#39;Unds&#39;&quot;</span><span class="p">,</span> <span class="p">(),</span> <span class="p">(</span><span class="n">init</span><span class="p">,</span> <span class="n">App</span><span class="p">(</span><span class="s1">&#39;LblListItem&#39;</span><span class="p">,</span> <span class="p">(),</span> <span class="p">(</span><span class="n">last</span><span class="p">,)))):</span>
<span class="linenos"> 838</span>                    <span class="n">var</span> <span class="o">=</span> <span class="n">EVar</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">free</span><span class="p">),</span> <span class="n">SortApp</span><span class="p">(</span><span class="s1">&#39;SortList&#39;</span><span class="p">))</span>
<span class="linenos"> 839</span>                    <span class="n">matchers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ListMatcher</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="p">(),</span> <span class="n">init</span><span class="p">,</span> <span class="p">(</span><span class="n">last</span><span class="p">,)))</span>
<span class="linenos"> 840</span>                    <span class="k">return</span> <span class="n">var</span>
<span class="linenos"> 841</span>                <span class="k">case</span> <span class="n">App</span><span class="p">(</span><span class="s2">&quot;Lbl&#39;Stop&#39;List&quot;</span><span class="p">):</span>
<span class="linenos"> 842</span>                    <span class="n">var</span> <span class="o">=</span> <span class="n">EVar</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">free</span><span class="p">),</span> <span class="n">SortApp</span><span class="p">(</span><span class="s1">&#39;SortList&#39;</span><span class="p">))</span>
<span class="linenos"> 843</span>                    <span class="n">matchers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EmptyListMatcher</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
<span class="linenos"> 844</span>                    <span class="k">return</span> <span class="n">var</span>
<span class="linenos"> 845</span>                <span class="k">case</span> <span class="n">App</span><span class="p">(</span><span class="s2">&quot;Lbl&#39;Unds&#39;Set&#39;Unds&#39;&quot;</span><span class="p">,</span> <span class="p">(),</span> <span class="p">(</span><span class="n">App</span><span class="p">(</span><span class="s1">&#39;LblSetItem&#39;</span><span class="p">,</span> <span class="p">(),</span> <span class="p">(</span><span class="n">elem</span><span class="p">,)),</span> <span class="n">rest</span><span class="p">)):</span>
<span class="linenos"> 846</span>                    <span class="n">var</span> <span class="o">=</span> <span class="n">EVar</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">free</span><span class="p">),</span> <span class="n">SortApp</span><span class="p">(</span><span class="s1">&#39;SortSet&#39;</span><span class="p">))</span>
<span class="linenos"> 847</span>                    <span class="n">matchers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SetMatcher</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="p">(</span><span class="n">elem</span><span class="p">,),</span> <span class="n">rest</span><span class="p">))</span>
<span class="linenos"> 848</span>                    <span class="k">return</span> <span class="n">var</span>
<span class="linenos"> 849</span>                <span class="k">case</span> <span class="n">App</span><span class="p">(</span><span class="s2">&quot;Lbl&#39;Stop&#39;Set&quot;</span><span class="p">):</span>
<span class="linenos"> 850</span>                    <span class="n">var</span> <span class="o">=</span> <span class="n">EVar</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">free</span><span class="p">),</span> <span class="n">SortApp</span><span class="p">(</span><span class="s1">&#39;SortSet&#39;</span><span class="p">))</span>
<span class="linenos"> 851</span>                    <span class="n">matchers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EmptySetMatcher</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
<span class="linenos"> 852</span>                    <span class="k">return</span> <span class="n">var</span>
<span class="linenos"> 853</span>                <span class="k">case</span> <span class="n">App</span><span class="p">(</span><span class="n">map_symbol</span><span class="p">,</span> <span class="p">(),</span> <span class="p">(</span><span class="n">App</span><span class="p">(</span><span class="n">item_symbol</span><span class="p">,</span> <span class="p">(),</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)),</span> <span class="n">rest</span><span class="p">)):</span>
<span class="linenos"> 854</span>                    <span class="k">if</span> <span class="p">(</span>
<span class="linenos"> 855</span>                        <span class="n">map_symbol</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Lbl&#39;Unds&#39;&quot;</span><span class="p">)</span>
<span class="linenos"> 856</span>                        <span class="ow">and</span> <span class="n">map_symbol</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;Map&#39;Unds&#39;&quot;</span><span class="p">)</span>
<span class="linenos"> 857</span>                        <span class="ow">and</span> <span class="p">(</span>
<span class="linenos"> 858</span>                            <span class="n">item_symbol</span> <span class="o">==</span> <span class="s2">&quot;Lbl&#39;UndsPipe&#39;-&#39;-GT-Unds&#39;&quot;</span>
<span class="linenos"> 859</span>                            <span class="ow">or</span> <span class="p">(</span><span class="n">item_symbol</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Lbl&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item_symbol</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;CellMapItem&#39;</span><span class="p">))</span>
<span class="linenos"> 860</span>                        <span class="p">)</span>
<span class="linenos"> 861</span>                    <span class="p">):</span>
<span class="linenos"> 862</span>                        <span class="n">sort</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Sort</span><span class="si">{</span><span class="n">map_symbol</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="linenos"> 863</span>                        <span class="n">var</span> <span class="o">=</span> <span class="n">EVar</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">free</span><span class="p">),</span> <span class="n">SortApp</span><span class="p">(</span><span class="n">sort</span><span class="p">))</span>
<span class="linenos"> 864</span>                        <span class="n">coll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="n">sort</span><span class="p">]</span>
<span class="linenos"> 865</span>                        <span class="n">elem_decl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">coll</span><span class="o">.</span><span class="n">element</span><span class="p">]</span>
<span class="linenos"> 866</span>                        <span class="n">key_sort</span><span class="p">,</span> <span class="n">value_sort</span> <span class="o">=</span> <span class="n">_param_sorts</span><span class="p">(</span><span class="n">elem_decl</span><span class="p">)</span>
<span class="linenos"> 867</span>                        <span class="n">matchers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MapMatcher</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">key_sort</span><span class="p">,</span> <span class="n">value_sort</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,),</span> <span class="p">(</span><span class="n">value</span><span class="p">,),</span> <span class="n">rest</span><span class="p">))</span>
<span class="linenos"> 868</span>                        <span class="k">return</span> <span class="n">var</span>
<span class="linenos"> 869</span>                <span class="k">case</span> <span class="n">App</span><span class="p">(</span><span class="n">symbol</span><span class="p">):</span>
<span class="linenos"> 870</span>                    <span class="k">if</span> <span class="n">symbol</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Lbl&#39;Stop&#39;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">symbol</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;Map&#39;</span><span class="p">):</span>
<span class="linenos"> 871</span>                        <span class="n">sort</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Sort</span><span class="si">{</span><span class="n">symbol</span><span class="p">[</span><span class="mi">9</span><span class="p">:]</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="linenos"> 872</span>                        <span class="n">var</span> <span class="o">=</span> <span class="n">EVar</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">free</span><span class="p">),</span> <span class="n">SortApp</span><span class="p">(</span><span class="n">sort</span><span class="p">))</span>
<span class="linenos"> 873</span>                        <span class="n">coll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="n">sort</span><span class="p">]</span>
<span class="linenos"> 874</span>                        <span class="n">elem_decl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">coll</span><span class="o">.</span><span class="n">element</span><span class="p">]</span>
<span class="linenos"> 875</span>                        <span class="n">key_sort</span><span class="p">,</span> <span class="n">value_sort</span> <span class="o">=</span> <span class="n">_param_sorts</span><span class="p">(</span><span class="n">elem_decl</span><span class="p">)</span>
<span class="linenos"> 876</span>                        <span class="n">matchers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EmptyMapMatcher</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">key_sort</span><span class="p">,</span> <span class="n">value_sort</span><span class="p">))</span>
<span class="linenos"> 877</span>                        <span class="k">return</span> <span class="n">var</span>
<span class="linenos"> 878</span>
<span class="linenos"> 879</span>            <span class="k">return</span> <span class="n">pattern</span>
<span class="linenos"> 880</span>
<span class="linenos"> 881</span>        <span class="k">def</span><span class="w"> </span><span class="nf">order_matchers</span><span class="p">(</span><span class="n">matchers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Matcher</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Matcher</span><span class="p">]]:</span>
<span class="linenos"> 882</span>            <span class="n">prec</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 883</span>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">this</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">matchers</span><span class="p">):</span>
<span class="linenos"> 884</span>                <span class="n">prec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 885</span>                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">other</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">matchers</span><span class="p">):</span>
<span class="linenos"> 886</span>                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">in</span> <span class="n">this</span><span class="o">.</span><span class="n">outputs</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">inputs</span><span class="p">):</span>
<span class="linenos"> 887</span>                        <span class="n">prec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
<span class="linenos"> 888</span>
<span class="linenos"> 889</span>            <span class="n">dg</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">(</span><span class="n">prec</span><span class="p">)</span>
<span class="linenos"> 890</span>            <span class="n">generations</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">topological_generations</span><span class="p">(</span><span class="n">dg</span><span class="p">)</span>
<span class="linenos"> 891</span>            <span class="k">return</span> <span class="p">[[</span><span class="n">matchers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">generation</span><span class="p">]</span> <span class="k">for</span> <span class="n">generation</span> <span class="ow">in</span> <span class="n">generations</span><span class="p">]</span>
<span class="linenos"> 892</span>
<span class="linenos"> 893</span>        <span class="n">pattern</span><span class="p">,</span> <span class="n">eq_classes</span> <span class="o">=</span> <span class="n">rename_outputs</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Var&#39;Unds&#39;Uniq</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">count</span><span class="p">()))</span>
<span class="linenos"> 894</span>        <span class="n">matchers</span> <span class="o">+=</span> <span class="n">eq_matchers</span><span class="p">(</span><span class="n">eq_classes</span><span class="p">)</span>
<span class="linenos"> 895</span>        <span class="n">pattern</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">bottom_up</span><span class="p">(</span><span class="n">abstract_matchers</span><span class="p">)</span>
<span class="linenos"> 896</span>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">App</span><span class="p">)</span>
<span class="linenos"> 897</span>        <span class="n">ordered</span> <span class="o">=</span> <span class="n">order_matchers</span><span class="p">(</span><span class="n">matchers</span><span class="p">)</span>
<span class="linenos"> 898</span>
<span class="linenos"> 899</span>        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">pattern</span><span class="o">.</span><span class="n">args</span><span class="p">),</span> <span class="n">ordered</span>
<span class="linenos"> 900</span>
<span class="linenos"> 901</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_func_axiom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">decl</span><span class="p">:</span> <span class="n">SymbolDecl</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axiom</span><span class="p">:</span>
<span class="linenos"> 902</span>        <span class="n">ident</span> <span class="o">=</span> <span class="n">_symbol_ident</span><span class="p">(</span><span class="n">decl</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="linenos"> 903</span>        <span class="n">signature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func_signature</span><span class="p">(</span><span class="n">decl</span><span class="p">)</span>
<span class="linenos"> 904</span>        <span class="k">return</span> <span class="n">Axiom</span><span class="p">(</span><span class="n">ident</span><span class="p">,</span> <span class="n">signature</span><span class="p">)</span>
<span class="linenos"> 905</span>
<span class="linenos"> 906</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_func_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">decl</span><span class="p">:</span> <span class="n">SymbolDecl</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Signature</span><span class="p">:</span>
<span class="linenos"> 907</span>        <span class="n">sort_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">decl</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">vars</span><span class="p">]</span>
<span class="linenos"> 908</span>        <span class="n">param_sorts</span> <span class="o">=</span> <span class="p">[</span><span class="n">sort</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">sort</span> <span class="ow">in</span> <span class="n">decl</span><span class="o">.</span><span class="n">param_sorts</span><span class="p">]</span>
<span class="linenos"> 909</span>        <span class="n">sort</span> <span class="o">=</span> <span class="n">decl</span><span class="o">.</span><span class="n">sort</span><span class="o">.</span><span class="n">name</span>
<span class="linenos"> 910</span>
<span class="linenos"> 911</span>        <span class="n">binders</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Binder</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 912</span>        <span class="k">if</span> <span class="n">sort_params</span><span class="p">:</span>
<span class="linenos"> 913</span>            <span class="n">binders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ImplBinder</span><span class="p">(</span><span class="n">sort_params</span><span class="p">,</span> <span class="n">Term</span><span class="p">(</span><span class="s1">&#39;Type&#39;</span><span class="p">)))</span>
<span class="linenos"> 914</span>        <span class="n">binders</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ExplBinder</span><span class="p">((</span><span class="sa">f</span><span class="s1">&#39;x</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,),</span> <span class="n">Term</span><span class="p">(</span><span class="n">sort</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sort</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">param_sorts</span><span class="p">))</span>
<span class="linenos"> 915</span>
<span class="linenos"> 916</span>        <span class="k">return</span> <span class="n">Signature</span><span class="p">(</span><span class="n">binders</span><span class="p">,</span> <span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Option </span><span class="si">{</span><span class="n">sort</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
<span class="linenos"> 917</span>
<div class="viewcode-block" id="K2Lean4.rewrite_module">
<a class="viewcode-back" href="../../../api/pyk.klean.k2lean4.html#pyk.klean.k2lean4.K2Lean4.rewrite_module">[docs]</a>
<span class="linenos"> 918</span>    <span class="k">def</span><span class="w"> </span><span class="nf">rewrite_module</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Module</span><span class="p">:</span>
<span class="linenos"> 919</span>        <span class="n">commands</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rewrite_inductive</span><span class="p">(),)</span>
<span class="linenos"> 920</span>        <span class="k">return</span> <span class="n">Module</span><span class="p">(</span><span class="n">commands</span><span class="o">=</span><span class="n">commands</span><span class="p">)</span></div>

<span class="linenos"> 921</span>
<span class="linenos"> 922</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_rewrite_inductive</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Inductive</span><span class="p">:</span>
<span class="linenos"> 923</span>        <span class="k">def</span><span class="w"> </span><span class="nf">tran_ctor</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Ctor</span><span class="p">:</span>
<span class="linenos"> 924</span>            <span class="k">return</span> <span class="n">Ctor</span><span class="p">(</span>
<span class="linenos"> 925</span>                <span class="s1">&#39;tran&#39;</span><span class="p">,</span>
<span class="linenos"> 926</span>                <span class="n">Signature</span><span class="p">(</span>
<span class="linenos"> 927</span>                    <span class="p">(</span>
<span class="linenos"> 928</span>                        <span class="n">ImplBinder</span><span class="p">((</span><span class="s1">&#39;s1&#39;</span><span class="p">,</span> <span class="s1">&#39;s2&#39;</span><span class="p">,</span> <span class="s1">&#39;s3&#39;</span><span class="p">),</span> <span class="n">Term</span><span class="p">(</span><span class="s1">&#39;SortGeneratedTopCell&#39;</span><span class="p">)),</span>
<span class="linenos"> 929</span>                        <span class="n">ExplBinder</span><span class="p">((</span><span class="s1">&#39;t1&#39;</span><span class="p">,),</span> <span class="n">Term</span><span class="p">(</span><span class="s1">&#39;Rewrites s1 s2&#39;</span><span class="p">)),</span>
<span class="linenos"> 930</span>                        <span class="n">ExplBinder</span><span class="p">((</span><span class="s1">&#39;t2&#39;</span><span class="p">,),</span> <span class="n">Term</span><span class="p">(</span><span class="s1">&#39;Rewrites s2 s3&#39;</span><span class="p">)),</span>
<span class="linenos"> 931</span>                    <span class="p">),</span>
<span class="linenos"> 932</span>                    <span class="n">Term</span><span class="p">(</span><span class="s1">&#39;Rewrites s1 s3&#39;</span><span class="p">),</span>
<span class="linenos"> 933</span>                <span class="p">),</span>
<span class="linenos"> 934</span>            <span class="p">)</span>
<span class="linenos"> 935</span>
<span class="linenos"> 936</span>        <span class="n">ctors</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Ctor</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 937</span>        <span class="n">ctors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tran_ctor</span><span class="p">())</span>
<span class="linenos"> 938</span>        <span class="n">ctors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rewrite_ctors</span><span class="p">())</span>
<span class="linenos"> 939</span>        <span class="n">signature</span> <span class="o">=</span> <span class="n">Signature</span><span class="p">(</span><span class="n">ty</span><span class="o">=</span><span class="n">Term</span><span class="p">(</span><span class="s1">&#39;SortGeneratedTopCell → SortGeneratedTopCell → Prop&#39;</span><span class="p">))</span>
<span class="linenos"> 940</span>        <span class="k">return</span> <span class="n">Inductive</span><span class="p">(</span><span class="s1">&#39;Rewrites&#39;</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">ctors</span><span class="o">=</span><span class="n">ctors</span><span class="p">)</span>
<span class="linenos"> 941</span>
<span class="linenos"> 942</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_rewrite_ctors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Ctor</span><span class="p">]:</span>
<span class="linenos"> 943</span>        <span class="n">rewrites</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">rewrites</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">_rule_name</span><span class="p">)</span>
<span class="linenos"> 944</span>        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_rewrite_ctor</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span> <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rewrites</span><span class="p">]</span>
<span class="linenos"> 945</span>
<span class="linenos"> 946</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_rewrite_ctor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">:</span> <span class="n">RewriteRule</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Ctor</span><span class="p">:</span>
<span class="linenos"> 947</span>        <span class="n">req</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">req</span> <span class="k">if</span> <span class="n">rule</span><span class="o">.</span><span class="n">req</span> <span class="k">else</span> <span class="n">Top</span><span class="p">(</span><span class="n">SortApp</span><span class="p">(</span><span class="s1">&#39;Foo&#39;</span><span class="p">))</span>
<span class="linenos"> 948</span>
<span class="linenos"> 949</span>        <span class="c1"># Step 1: eliminate aliases</span>
<span class="linenos"> 950</span>        <span class="n">pattern</span> <span class="o">=</span> <span class="n">elim_aliases</span><span class="p">(</span><span class="n">And</span><span class="p">(</span><span class="n">SortApp</span><span class="p">(</span><span class="s1">&#39;Foo&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">rhs</span><span class="p">)))</span>
<span class="linenos"> 951</span>
<span class="linenos"> 952</span>        <span class="c1"># Step 2: eliminate function application</span>
<span class="linenos"> 953</span>        <span class="n">free</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Var&#39;Unds&#39;Val</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">count</span><span class="p">())</span>
<span class="linenos"> 954</span>        <span class="n">pattern</span><span class="p">,</span> <span class="n">defs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elim_fun_apps</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">free</span><span class="p">)</span>
<span class="linenos"> 955</span>
<span class="linenos"> 956</span>        <span class="c1"># Step 3: create binders</span>
<span class="linenos"> 957</span>        <span class="n">binders</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Binder</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 958</span>        <span class="n">binders</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
<span class="linenos"> 959</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_free_binders</span><span class="p">(</span><span class="n">And</span><span class="p">(</span><span class="n">SortApp</span><span class="p">(</span><span class="s1">&#39;Foo&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">pattern</span><span class="p">,)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">defs</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
<span class="linenos"> 960</span>        <span class="p">)</span>  <span class="c1"># Binders of the form {x y : SortInt}</span>
<span class="linenos"> 961</span>        <span class="n">binders</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_def_binders</span><span class="p">(</span><span class="n">defs</span><span class="p">))</span>  <span class="c1"># Binders of the form (def_y : foo x = some y)</span>
<span class="linenos"> 962</span>
<span class="linenos"> 963</span>        <span class="c1"># Step 4: transform patterns</span>
<span class="linenos"> 964</span>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">And</span><span class="p">)</span>
<span class="linenos"> 965</span>        <span class="n">req</span><span class="p">,</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">ops</span>
<span class="linenos"> 966</span>
<span class="linenos"> 967</span>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">Top</span><span class="p">):</span>
<span class="linenos"> 968</span>            <span class="n">req_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_pattern</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
<span class="linenos"> 969</span>            <span class="n">binders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ExplBinder</span><span class="p">((</span><span class="s1">&#39;req&#39;</span><span class="p">,),</span> <span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">req_term</span><span class="si">}</span><span class="s1"> = true&#39;</span><span class="p">)))</span>
<span class="linenos"> 970</span>
<span class="linenos"> 971</span>        <span class="n">lhs_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_pattern</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span>
<span class="linenos"> 972</span>        <span class="n">rhs_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_pattern</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span>
<span class="linenos"> 973</span>        <span class="k">return</span> <span class="n">Ctor</span><span class="p">(</span><span class="n">_rule_name</span><span class="p">(</span><span class="n">rule</span><span class="p">),</span> <span class="n">Signature</span><span class="p">(</span><span class="n">binders</span><span class="p">,</span> <span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Rewrites </span><span class="si">{</span><span class="n">lhs_term</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">rhs_term</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)))</span>
<span class="linenos"> 974</span>
<span class="linenos"> 975</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_elim_fun_apps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">:</span> <span class="n">Pattern</span><span class="p">,</span> <span class="n">free</span><span class="p">:</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Pattern</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Pattern</span><span class="p">]]:</span>
<span class="linenos"> 976</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Replace ``foo(bar(x))`` with ``z`` and return mapping ``{y: bar(x), z: foo(y)}`` with ``y``, ``z`` fresh variables.&quot;&quot;&quot;</span>
<span class="linenos"> 977</span>        <span class="n">defs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Pattern</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 978</span>
<span class="linenos"> 979</span>        <span class="k">def</span><span class="w"> </span><span class="nf">abstract_funcs</span><span class="p">(</span><span class="n">pattern</span><span class="p">:</span> <span class="n">Pattern</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Pattern</span><span class="p">:</span>
<span class="linenos"> 980</span>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">App</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pattern</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">functions</span><span class="p">:</span>
<span class="linenos"> 981</span>                <span class="n">name</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">free</span><span class="p">)</span>
<span class="linenos"> 982</span>                <span class="n">ident</span> <span class="o">=</span> <span class="n">_var_ident</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="linenos"> 983</span>                <span class="n">defs</span><span class="p">[</span><span class="n">ident</span><span class="p">]</span> <span class="o">=</span> <span class="n">pattern</span>
<span class="linenos"> 984</span>                <span class="n">sort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol_table</span><span class="o">.</span><span class="n">infer_sort</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
<span class="linenos"> 985</span>                <span class="k">return</span> <span class="n">EVar</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sort</span><span class="p">)</span>
<span class="linenos"> 986</span>            <span class="k">return</span> <span class="n">pattern</span>
<span class="linenos"> 987</span>
<span class="linenos"> 988</span>        <span class="k">return</span> <span class="n">pattern</span><span class="o">.</span><span class="n">bottom_up</span><span class="p">(</span><span class="n">abstract_funcs</span><span class="p">),</span> <span class="n">defs</span>
<span class="linenos"> 989</span>
<span class="linenos"> 990</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_free_binders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">:</span> <span class="n">Pattern</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Binder</span><span class="p">]:</span>
<span class="linenos"> 991</span>        <span class="n">free_vars</span> <span class="o">=</span> <span class="p">{</span><span class="n">occ</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">occs</span> <span class="ow">in</span> <span class="n">free_occs</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">occ</span> <span class="ow">in</span> <span class="n">occs</span><span class="p">}</span>
<span class="linenos"> 992</span>        <span class="n">grouped_vars</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 993</span>        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">free_vars</span><span class="p">:</span>
<span class="linenos"> 994</span>            <span class="k">match</span> <span class="n">var</span><span class="p">:</span>
<span class="linenos"> 995</span>                <span class="k">case</span> <span class="n">EVar</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">SortApp</span><span class="p">(</span><span class="n">sort</span><span class="p">)):</span>
<span class="linenos"> 996</span>                    <span class="n">ident</span> <span class="o">=</span> <span class="n">_var_ident</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="linenos"> 997</span>                    <span class="k">assert</span> <span class="n">ident</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grouped_vars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sort</span><span class="p">,</span> <span class="p">())</span>
<span class="linenos"> 998</span>                    <span class="n">grouped_vars</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">sort</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ident</span><span class="p">)</span>
<span class="linenos"> 999</span>                <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
<span class="linenos">1000</span>                    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">()</span>
<span class="linenos">1001</span>        <span class="n">sorted_vars</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
<span class="linenos">1002</span>            <span class="nb">sorted</span><span class="p">(((</span><span class="n">sort</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">idents</span><span class="p">))</span> <span class="k">for</span> <span class="n">sort</span><span class="p">,</span> <span class="n">idents</span> <span class="ow">in</span> <span class="n">grouped_vars</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos">1003</span>        <span class="p">)</span>
<span class="linenos">1004</span>        <span class="k">return</span> <span class="p">[</span><span class="n">ImplBinder</span><span class="p">(</span><span class="n">idents</span><span class="p">,</span> <span class="n">Term</span><span class="p">(</span><span class="n">sort</span><span class="p">))</span> <span class="k">for</span> <span class="n">sort</span><span class="p">,</span> <span class="n">idents</span> <span class="ow">in</span> <span class="n">sorted_vars</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
<span class="linenos">1005</span>
<span class="linenos">1006</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_def_binders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">defs</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Pattern</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Binder</span><span class="p">]:</span>
<span class="linenos">1007</span>        <span class="k">return</span> <span class="p">[</span>
<span class="linenos">1008</span>            <span class="n">ExplBinder</span><span class="p">((</span><span class="sa">f</span><span class="s1">&#39;defn</span><span class="si">{</span><span class="n">ident</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,),</span> <span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_transform_pattern</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span><span class="si">}</span><span class="s1"> = some </span><span class="si">{</span><span class="n">ident</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
<span class="linenos">1009</span>            <span class="k">for</span> <span class="n">ident</span><span class="p">,</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">defs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="linenos">1010</span>        <span class="p">]</span>
<span class="linenos">1011</span>
<span class="linenos">1012</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_transform_pattern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">:</span> <span class="n">Pattern</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">concrete</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Term</span><span class="p">:</span>
<span class="linenos">1013</span>        <span class="k">match</span> <span class="n">pattern</span><span class="p">:</span>
<span class="linenos">1014</span>            <span class="k">case</span> <span class="n">EVar</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
<span class="linenos">1015</span>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_evar</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="linenos">1016</span>            <span class="k">case</span> <span class="n">DV</span><span class="p">(</span><span class="n">SortApp</span><span class="p">(</span><span class="n">sort</span><span class="p">),</span> <span class="n">String</span><span class="p">(</span><span class="n">value</span><span class="p">)):</span>
<span class="linenos">1017</span>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_dv</span><span class="p">(</span><span class="n">sort</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
<span class="linenos">1018</span>            <span class="k">case</span> <span class="n">App</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">sorts</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="linenos">1019</span>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_app</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">sorts</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">concrete</span><span class="o">=</span><span class="n">concrete</span><span class="p">)</span>
<span class="linenos">1020</span>            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
<span class="linenos">1021</span>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unsupported pattern: </span><span class="si">{</span><span class="n">pattern</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos">1022</span>
<span class="linenos">1023</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_transform_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">:</span> <span class="n">Pattern</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">concrete</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Term</span><span class="p">:</span>
<span class="linenos">1024</span>        <span class="n">term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_pattern</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">concrete</span><span class="o">=</span><span class="n">concrete</span><span class="p">)</span>
<span class="linenos">1025</span>
<span class="linenos">1026</span>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">App</span><span class="p">):</span>
<span class="linenos">1027</span>            <span class="k">return</span> <span class="n">term</span>
<span class="linenos">1028</span>
<span class="linenos">1029</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">pattern</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
<span class="linenos">1030</span>            <span class="k">return</span> <span class="n">term</span>
<span class="linenos">1031</span>
<span class="linenos">1032</span>        <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure_symbols</span><span class="p">:</span>
<span class="linenos">1033</span>            <span class="k">return</span> <span class="n">term</span>
<span class="linenos">1034</span>
<span class="linenos">1035</span>        <span class="k">return</span> <span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="linenos">1036</span>
<span class="linenos">1037</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_transform_evar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Term</span><span class="p">:</span>
<span class="linenos">1038</span>        <span class="k">return</span> <span class="n">Term</span><span class="p">(</span><span class="n">_var_ident</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
<span class="linenos">1039</span>
<span class="linenos">1040</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_transform_dv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Term</span><span class="p">:</span>
<span class="linenos">1041</span>        <span class="k">match</span> <span class="n">sort</span><span class="p">:</span>
<span class="linenos">1042</span>            <span class="k">case</span> <span class="s1">&#39;SortBool&#39;</span><span class="p">:</span>
<span class="linenos">1043</span>                <span class="k">return</span> <span class="n">Term</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="linenos">1044</span>            <span class="k">case</span> <span class="s1">&#39;SortInt&#39;</span><span class="p">:</span>
<span class="linenos">1045</span>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_int_dv</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="linenos">1046</span>            <span class="k">case</span> <span class="s1">&#39;SortBytes&#39;</span><span class="p">:</span>
<span class="linenos">1047</span>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_bytes_dv</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="linenos">1048</span>            <span class="k">case</span> <span class="s1">&#39;SortId&#39;</span> <span class="o">|</span> <span class="s1">&#39;SortString&#39;</span> <span class="o">|</span> <span class="s1">&#39;SortStringBuffer&#39;</span><span class="p">:</span>
<span class="linenos">1049</span>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_string_dv</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="linenos">1050</span>            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
<span class="linenos">1051</span>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unsupported sort: </span><span class="si">{</span><span class="n">sort</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos">1052</span>
<span class="linenos">1053</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_transform_int_dv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Term</span><span class="p">:</span>
<span class="linenos">1054</span>        <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="linenos">1055</span>        <span class="k">return</span> <span class="n">Term</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="linenos">1056</span>
<span class="linenos">1057</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_transform_bytes_dv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Term</span><span class="p">:</span>
<span class="linenos">1058</span>        <span class="n">bytes_str</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;0x</span><span class="si">{</span><span class="n">byte</span><span class="si">:</span><span class="s1">02X</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">byte</span> <span class="ow">in</span> <span class="n">bytes_encode</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
<span class="linenos">1059</span>        <span class="k">return</span> <span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;⟨#[</span><span class="si">{</span><span class="n">bytes_str</span><span class="si">}</span><span class="s1">]⟩&#39;</span><span class="p">)</span>
<span class="linenos">1060</span>
<span class="linenos">1061</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_transform_string_dv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Term</span><span class="p">:</span>
<span class="linenos">1062</span>        <span class="n">escapes</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">1063</span>            <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">):</span> <span class="sa">r</span><span class="s1">&#39;\r&#39;</span><span class="p">,</span>
<span class="linenos">1064</span>            <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span> <span class="sa">r</span><span class="s1">&#39;\n&#39;</span><span class="p">,</span>
<span class="linenos">1065</span>            <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">):</span> <span class="sa">r</span><span class="s1">&#39;\t&#39;</span><span class="p">,</span>
<span class="linenos">1066</span>            <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">):</span> <span class="sa">r</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span>
<span class="linenos">1067</span>            <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">):</span> <span class="sa">r</span><span class="s1">&#39;\&quot;&#39;</span><span class="p">,</span>
<span class="linenos">1068</span>            <span class="nb">ord</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">):</span> <span class="sa">r</span><span class="s2">&quot;\&#39;&quot;</span><span class="p">,</span>
<span class="linenos">1069</span>        <span class="p">}</span>
<span class="linenos">1070</span>
<span class="linenos">1071</span>        <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span><span class="n">c</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="linenos">1072</span>            <span class="n">code</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="linenos">1073</span>            <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">escapes</span><span class="p">:</span>
<span class="linenos">1074</span>                <span class="k">return</span> <span class="n">escapes</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>
<span class="linenos">1075</span>            <span class="k">elif</span> <span class="mi">32</span> <span class="o">&lt;=</span> <span class="n">code</span> <span class="o">&lt;</span> <span class="mi">127</span><span class="p">:</span>
<span class="linenos">1076</span>                <span class="k">return</span> <span class="n">c</span>
<span class="linenos">1077</span>            <span class="k">elif</span> <span class="n">code</span> <span class="o">&lt;=</span> <span class="mh">0xFF</span><span class="p">:</span>
<span class="linenos">1078</span>                <span class="k">return</span> <span class="sa">fr</span><span class="s1">&#39;\x</span><span class="si">{</span><span class="n">code</span><span class="si">:</span><span class="s1">02x</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="linenos">1079</span>            <span class="k">elif</span> <span class="n">code</span> <span class="o">&lt;=</span> <span class="mh">0xFFFF</span><span class="p">:</span>
<span class="linenos">1080</span>                <span class="k">return</span> <span class="sa">fr</span><span class="s1">&#39;\u</span><span class="si">{</span><span class="n">code</span><span class="si">:</span><span class="s1">04x</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="linenos">1081</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">1082</span>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported character: &#39;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&#39; (</span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="linenos">1083</span>
<span class="linenos">1084</span>        <span class="n">encoded</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">encode</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">value</span><span class="p">)</span>
<span class="linenos">1085</span>        <span class="k">return</span> <span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">encoded</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
<span class="linenos">1086</span>
<span class="linenos">1087</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_transform_app</span><span class="p">(</span>
<span class="linenos">1088</span>        <span class="bp">self</span><span class="p">,</span>
<span class="linenos">1089</span>        <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="linenos">1090</span>        <span class="n">sorts</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
<span class="linenos">1091</span>        <span class="n">args</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Pattern</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
<span class="linenos">1092</span>        <span class="o">*</span><span class="p">,</span>
<span class="linenos">1093</span>        <span class="n">concrete</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<span class="linenos">1094</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Term</span><span class="p">:</span>
<span class="linenos">1095</span>        <span class="k">if</span> <span class="n">symbol</span> <span class="o">==</span> <span class="s1">&#39;inj&#39;</span><span class="p">:</span>
<span class="linenos">1096</span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_inj_app</span><span class="p">(</span><span class="n">sorts</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">concrete</span><span class="o">=</span><span class="n">concrete</span><span class="p">)</span>
<span class="linenos">1097</span>
<span class="linenos">1098</span>        <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure_symbols</span><span class="p">:</span>
<span class="linenos">1099</span>            <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">structure_symbols</span><span class="p">[</span><span class="n">symbol</span><span class="p">]]</span>
<span class="linenos">1100</span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_structure_app</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">concrete</span><span class="o">=</span><span class="n">concrete</span><span class="p">)</span>
<span class="linenos">1101</span>
<span class="linenos">1102</span>        <span class="n">decl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
<span class="linenos">1103</span>        <span class="n">sort</span> <span class="o">=</span> <span class="n">decl</span><span class="o">.</span><span class="n">sort</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">decl</span><span class="o">.</span><span class="n">sort</span><span class="p">,</span> <span class="n">SortApp</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
<span class="linenos">1104</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_basic_app</span><span class="p">(</span><span class="n">sort</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">concrete</span><span class="o">=</span><span class="n">concrete</span><span class="p">)</span>
<span class="linenos">1105</span>
<span class="linenos">1106</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_transform_inj_app</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sorts</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Sort</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">args</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Pattern</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">concrete</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Term</span><span class="p">:</span>
<span class="linenos">1107</span>        <span class="n">_from_sort</span><span class="p">,</span> <span class="n">_to_sort</span> <span class="o">=</span> <span class="n">sorts</span>
<span class="linenos">1108</span>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_from_sort</span><span class="p">,</span> <span class="n">SortApp</span><span class="p">)</span>
<span class="linenos">1109</span>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_to_sort</span><span class="p">,</span> <span class="n">SortApp</span><span class="p">)</span>
<span class="linenos">1110</span>        <span class="n">from_str</span> <span class="o">=</span> <span class="n">_from_sort</span><span class="o">.</span><span class="n">name</span>
<span class="linenos">1111</span>        <span class="n">to_str</span> <span class="o">=</span> <span class="n">_to_sort</span><span class="o">.</span><span class="n">name</span>
<span class="linenos">1112</span>        <span class="p">(</span><span class="n">arg</span><span class="p">,)</span> <span class="o">=</span> <span class="n">args</span>
<span class="linenos">1113</span>        <span class="n">term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">concrete</span><span class="o">=</span><span class="n">concrete</span><span class="p">)</span>
<span class="linenos">1114</span>        <span class="k">if</span> <span class="n">concrete</span><span class="p">:</span>
<span class="linenos">1115</span>            <span class="k">return</span> <span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">to_str</span><span class="si">}</span><span class="s1">.inj_</span><span class="si">{</span><span class="n">from_str</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos">1116</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1117</span>            <span class="k">return</span> <span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;(@inj </span><span class="si">{</span><span class="n">from_str</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">to_str</span><span class="si">}</span><span class="s1">) </span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos">1118</span>
<span class="linenos">1119</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_transform_structure_app</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Field</span><span class="p">],</span> <span class="n">args</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Pattern</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">concrete</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Term</span><span class="p">:</span>
<span class="linenos">1120</span>        <span class="n">fields_str</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
<span class="linenos">1121</span>            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> := </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_transform_pattern</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="n">concrete</span><span class="o">=</span><span class="n">concrete</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="linenos">1122</span>            <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">1123</span>        <span class="p">)</span>
<span class="linenos">1124</span>        <span class="n">lbrace</span><span class="p">,</span> <span class="n">rbrace</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;{&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">]</span>
<span class="linenos">1125</span>        <span class="k">return</span> <span class="n">Term</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">lbrace</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">fields_str</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">rbrace</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos">1126</span>
<span class="linenos">1127</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_transform_basic_app</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Pattern</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">concrete</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Term</span><span class="p">:</span>
<span class="linenos">1128</span>        <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">1129</span>
<span class="linenos">1130</span>        <span class="n">ident</span><span class="p">:</span> <span class="nb">str</span>
<span class="linenos">1131</span>        <span class="k">if</span> <span class="n">sort</span> <span class="ow">and</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">constructors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sort</span><span class="p">,</span> <span class="p">()):</span>
<span class="linenos">1132</span>            <span class="c1"># Symbol is a constructor</span>
<span class="linenos">1133</span>            <span class="n">ident</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sort</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">_symbol_ident</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="linenos">1134</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1135</span>            <span class="n">ident</span> <span class="o">=</span> <span class="n">_symbol_ident</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
<span class="linenos">1136</span>
<span class="linenos">1137</span>        <span class="n">chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ident</span><span class="p">)</span>
<span class="linenos">1138</span>        <span class="n">chunks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transform_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">concrete</span><span class="o">=</span><span class="n">concrete</span><span class="p">))</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">)</span>
<span class="linenos">1139</span>        <span class="k">return</span> <span class="n">Term</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chunks</span><span class="p">))</span></div>

<span class="linenos">1140</span>
<span class="linenos">1141</span>
<span class="linenos">1142</span><span class="k">def</span><span class="w"> </span><span class="nf">_rule_name</span><span class="p">(</span><span class="n">rule</span><span class="p">:</span> <span class="n">Rule</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="linenos">1143</span>    <span class="k">if</span> <span class="n">rule</span><span class="o">.</span><span class="n">label</span><span class="p">:</span>
<span class="linenos">1144</span>        <span class="n">label</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
<span class="linenos">1145</span>        <span class="k">return</span> <span class="n">_escape_ident</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
<span class="linenos">1146</span>    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">rule</span><span class="o">.</span><span class="n">uid</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="linenos">1147</span>
<span class="linenos">1148</span>
<span class="linenos">1149</span><span class="k">def</span><span class="w"> </span><span class="nf">_symbol_ident</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="linenos">1150</span>    <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">_SYMBOL_OVERRIDES</span><span class="p">:</span>
<span class="linenos">1151</span>        <span class="k">return</span> <span class="n">_SYMBOL_OVERRIDES</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
<span class="linenos">1152</span>    <span class="k">if</span> <span class="n">symbol</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Lbl&#39;</span><span class="p">):</span>
<span class="linenos">1153</span>        <span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
<span class="linenos">1154</span>    <span class="k">return</span> <span class="n">_escape_ident</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">kore</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">1155</span>
<span class="linenos">1156</span>
<span class="linenos">1157</span><span class="k">def</span><span class="w"> </span><span class="nf">_var_ident</span><span class="p">(</span><span class="n">var</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="linenos">1158</span>    <span class="k">assert</span> <span class="n">var</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Var&#39;</span><span class="p">)</span>
<span class="linenos">1159</span>    <span class="k">return</span> <span class="n">_escape_ident</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="mi">3</span><span class="p">:],</span> <span class="n">kore</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">1160</span>
<span class="linenos">1161</span>
<span class="linenos">1162</span><span class="n">_VALID_LEAN_IDENT</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
<span class="linenos">1163</span>    <span class="s2">&quot;_[a-zA-Z0-9_?!&#39;]+|[a-zA-Z][a-zA-Z0-9_?!&#39;]*&quot;</span>
<span class="linenos">1164</span><span class="p">)</span>  <span class="c1"># Simplified to characters permitted in KORE in the first place</span>
<span class="linenos">1165</span>
<span class="linenos">1166</span>
<span class="linenos">1167</span><span class="k">def</span><span class="w"> </span><span class="nf">_escape_ident</span><span class="p">(</span><span class="n">ident</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">kore</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="linenos">1168</span>    <span class="k">if</span> <span class="n">kore</span><span class="p">:</span>
<span class="linenos">1169</span>        <span class="n">ident</span> <span class="o">=</span> <span class="n">unmunge</span><span class="p">(</span><span class="n">ident</span><span class="p">)</span>
<span class="linenos">1170</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">_VALID_LEAN_IDENT</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="n">ident</span><span class="p">):</span>
<span class="linenos">1171</span>        <span class="n">ident</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;«</span><span class="si">{</span><span class="n">ident</span><span class="si">}</span><span class="s1">»&#39;</span>
<span class="linenos">1172</span>    <span class="k">return</span> <span class="n">ident</span>
<span class="linenos">1173</span>
<span class="linenos">1174</span>
<span class="linenos">1175</span><span class="k">def</span><span class="w"> </span><span class="nf">_param_sorts</span><span class="p">(</span><span class="n">decl</span><span class="p">:</span> <span class="n">SymbolDecl</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="linenos">1176</span>    <span class="kn">from</span><span class="w"> </span><span class="nn">..utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">check_type</span>
<span class="linenos">1177</span>
<span class="linenos">1178</span>    <span class="k">return</span> <span class="p">[</span><span class="n">check_type</span><span class="p">(</span><span class="n">sort</span><span class="p">,</span> <span class="n">SortApp</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">sort</span> <span class="ow">in</span> <span class="n">decl</span><span class="o">.</span><span class="n">param_sorts</span><span class="p">]</span>  <span class="c1"># TODO eliminate check_type</span>
<span class="linenos">1179</span>
<span class="linenos">1180</span>
<span class="linenos">1181</span><span class="k">def</span><span class="w"> </span><span class="nf">_ordered_sccs</span><span class="p">(</span><span class="n">deps</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Collection</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="linenos">1182</span>    <span class="n">sccs</span> <span class="o">=</span> <span class="n">_sccs</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span>
<span class="linenos">1183</span>
<span class="linenos">1184</span>    <span class="n">elems_by_scc</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">1185</span>    <span class="k">for</span> <span class="n">elem</span><span class="p">,</span> <span class="n">scc</span> <span class="ow">in</span> <span class="n">sccs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos">1186</span>        <span class="n">elems_by_scc</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
<span class="linenos">1187</span>
<span class="linenos">1188</span>    <span class="n">scc_deps</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">1189</span>    <span class="k">for</span> <span class="n">scc</span><span class="p">,</span> <span class="n">elems</span> <span class="ow">in</span> <span class="n">elems_by_scc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos">1190</span>        <span class="k">assert</span> <span class="n">elems</span>
<span class="linenos">1191</span>        <span class="n">elem</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">elems</span>
<span class="linenos">1192</span>        <span class="n">scc_deps</span><span class="p">[</span><span class="n">scc</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="linenos">1193</span>        <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">[</span><span class="n">elem</span><span class="p">]:</span>
<span class="linenos">1194</span>            <span class="n">dep_scc</span> <span class="o">=</span> <span class="n">sccs</span><span class="p">[</span><span class="n">dep</span><span class="p">]</span>
<span class="linenos">1195</span>            <span class="k">if</span> <span class="n">dep_scc</span> <span class="o">==</span> <span class="n">scc</span><span class="p">:</span>
<span class="linenos">1196</span>                <span class="k">continue</span>
<span class="linenos">1197</span>            <span class="n">scc_deps</span><span class="p">[</span><span class="n">scc</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dep_scc</span><span class="p">)</span>
<span class="linenos">1198</span>
<span class="linenos">1199</span>    <span class="n">ordered_sccs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">TopologicalSorter</span><span class="p">(</span><span class="n">scc_deps</span><span class="p">)</span><span class="o">.</span><span class="n">static_order</span><span class="p">())</span>
<span class="linenos">1200</span>    <span class="k">return</span> <span class="p">[</span><span class="nb">sorted</span><span class="p">(</span><span class="n">elems_by_scc</span><span class="p">[</span><span class="n">scc</span><span class="p">])</span> <span class="k">for</span> <span class="n">scc</span> <span class="ow">in</span> <span class="n">ordered_sccs</span><span class="p">]</span>
<span class="linenos">1201</span>
<span class="linenos">1202</span>
<span class="linenos">1203</span><span class="c1"># TODO Implement a more efficient algorithm, e.g. Tarjan&#39;s algorithm</span>
<span class="linenos">1204</span><span class="k">def</span><span class="w"> </span><span class="nf">_sccs</span><span class="p">(</span><span class="n">deps</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="linenos">1205</span>    <span class="n">res</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">1206</span>
<span class="linenos">1207</span>    <span class="n">scc</span> <span class="o">=</span> <span class="n">count</span><span class="p">()</span>
<span class="linenos">1208</span>    <span class="k">for</span> <span class="n">elem</span><span class="p">,</span> <span class="n">dep_elems</span> <span class="ow">in</span> <span class="n">deps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos">1209</span>        <span class="k">if</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">1210</span>            <span class="k">continue</span>
<span class="linenos">1211</span>        <span class="n">idx</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">scc</span><span class="p">)</span>
<span class="linenos">1212</span>        <span class="n">res</span><span class="p">[</span><span class="n">elem</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>
<span class="linenos">1213</span>        <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">dep_elems</span><span class="p">:</span>
<span class="linenos">1214</span>            <span class="k">if</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">[</span><span class="n">dep</span><span class="p">]:</span>
<span class="linenos">1215</span>                <span class="n">res</span><span class="p">[</span><span class="n">dep</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>
<span class="linenos">1216</span>
<span class="linenos">1217</span>    <span class="k">return</span> <span class="n">res</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Runtime Verification, Inc.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>