<!DOCTYPE html>
<html lang="en">
  <head>
<meta charset="utf-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
/>
<meta
  name="description"
  content="Design and implement your programming language and software analysis tools with mathematical rigor."
/>
<meta name="keywords" content="runtime, verification, rv, k" />
<meta name="author" content="K | Runtime Verification Inc" />
<meta name="robots" content="index, follow" />
<link rel="canonical" href="https://kframework.org/k-distribution/tests/regression-new/pl-tutorial/2_languages/2_kool/1_untyped/kool-untyped/" />

<!--favicon icon-->
<link rel="icon" type="image/png" href="../../../../../../../../assets/img/favicon.ico" />

<title>KOOL — Untyped | Runtime Verification Inc</title>

<!-- <base href="/k/" /> -->

<!--web fonts-->
<link
  href="https://fonts.googleapis.com/css?family=Nunito:300,400,600,700,800"
  rel="stylesheet"
/>
<link
  href="https://fonts.googleapis.com/css?family=Lora:400i"
  rel="stylesheet"
/>

<link
  href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css"
  rel="stylesheet"
/>

<link href="../../../../../../../../assets/css/index.css" rel="stylesheet" />

<!--[if (gt IE 9) |!(IE)]><!-->
<!--<link rel="stylesheet" href="/assets/vendor/custom-nav/css/effects/fade-menu.css"/>-->
<!-- <link rel="stylesheet" href="../../../../../../../../assets/k/vl-nav/css/effects/slide-menu.css" /> -->
<!--<![endif]-->

  </head>

  <body>
<header
  class="navbar navbar-expand navbar-dark flex-column flex-md-row bd-navbar"
>
  <a class="logo-link" href="../../../../../../../../index.html">
    <picture>
      <source
        srcset="../../../../../../../../assets/img/k-logo-dark.png"
        media="(prefers-color-scheme: dark)"
      />
      <img src="../../../../../../../../assets/img/k-logo.png" alt="K" style="height: 48px" />
    </picture>
    Semantic Framework
  </a>
  <ul class="navbar-nav ml-md-auto">
    <li class="nav-item dropdown">
      <a
        class="nav-link dropdown-toggle"
        href="#"
        id="navbarDropdown"
        role="button"
        data-toggle="dropdown"
        aria-haspopup="true"
        aria-expanded="false"
      >
        <i class="fas fa-book"></i>
      </a>
      <div class="dropdown-menu" aria-labelledby="navbarDropdown">
        <a class="dropdown-item" href="../../../../../../../../exports/K.pdf">pdf</a>
        <a class="dropdown-item" href="../../../../../../../../exports/K.epub">epub</a>
        <a class="dropdown-item" href="../../../../../../../../exports/K.mobi">mobi</a>
        <a class="dropdown-item" href="../../../../../../../../exports/K.html">html</a>
      </div>
    </li>
    <li class="nav-item">
      <a
        class="nav-link pl-2 pr-1 mx-1 py-3 my-n2"
        href="https://github.com/runtimeverification/k"
        target="_blank"
        rel="noopener"
        aria-label="GitHub"
      >
        <i class="fab fa-github"></i>
      </a>
    </li>
  </ul>
  <a
    class="btn btn-rv-blue d-none d-lg-inline-block mb-3 mb-md-0 ml-md-3"
    href="https://github.com/runtimeverification/k/releases/latest"
    >Download</a
  >
</header>
<style>
  .dropdown:hover .dropdown-menu {
    display: block;
    margin-top: 0; /* remove the gap so it doesn't close */
  }
</style>


    <div class="container-fluid">
      <div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 bd-sidebar mb-3">
  <form
    role="search"
    class="bd-search d-flex align-items-center justify-content-between"
  >
    <input
      type="search"
      class="form-control"
      placeholder="Search..."
      aria-label="Search for..."
      autocomplete="false"
      id="search-box"
    />
    <button
      class="btn bd-search-docs-toggle d-md-none p-0 ml-3 collapsed"
      type="button"
      aria-label="Toggle docs navigation"
      style="font-size: 1.4rem"
    >
      <i class="fas fa-bars"></i>
    </button>
  </form>
  <nav class="collapse bd-links" aria-label="Main navigation">
    <div class="sidebar-toc pl-2"><div>
<div style="padding:0.25rem 0;;padding-left: 8px;"><a href="../../../../../../../../">Homepage</a></div>
<div style="padding:0.25rem 0;;padding-left: 8px;"><a href="https://github.com/runtimeverification/k/releases/latest">Install K</a></div>
<div style="padding:0.25rem 0;;padding-left: 8px;"><a href="https://kframework.org/pyk">Pyk Documentation</a></div>
<details style="padding:0.25rem 0;;padding-left: 8px;"><summary><a href="../../../../../../../../k-distribution/k-tutorial/">K Tutorial</a></summary><div>
<details style="padding:0.25rem 0;;padding-left: 16px;"><summary><a href="../../../../../../../../k-distribution/k-tutorial/1_basic/">Section 1: Basic K Concepts</a></summary><div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/1_basic/01_installing/">Lesson 1.1: Setting up a K Environment</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/1_basic/02_basics/">Lesson 1.2: Basics of Functional K</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/1_basic/03_parsing/">Lesson 1.3: BNF Syntax and Parser Generation</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/1_basic/04_disambiguation/">Lesson 1.4: Disambiguating Parses</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/1_basic/05_modules/">Lesson 1.5: Modules, Imports, and Requires</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/1_basic/06_ints_and_bools/">Lesson 1.6: Integers and Booleans</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/1_basic/07_side_conditions/">Lesson 1.7: Side Conditions and Rule Priority</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/1_basic/08_literate_programming/">Lesson 1.8: Literate Programming with Markdown</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/1_basic/09_unparsing/">Lesson 1.9: Unparsing and the format and color attributes</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/1_basic/10_strings/">Lesson 1.10: Strings</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/1_basic/11_casts/">Lesson 1.11: Casting Terms</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/1_basic/12_syntactic_lists/">Lesson 1.12: Syntactic Lists</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/1_basic/13_rewrite_rules/">Lesson 1.13: Basics of K Rewriting</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/1_basic/14_evaluation_order/">Lesson 1.14: Defining Evaluation Order</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/1_basic/15_configurations/">Lesson 1.15: Configuration Declarations and Cell Nesting</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/1_basic/16_collections/">Lesson 1.16: Maps, Semantic Lists, and Sets</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/1_basic/17_cell_multiplicity/">Lesson 1.17: Cell Multiplicity and Cell Collections</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/1_basic/18_equality_and_conditionals/">Lesson 1.18: Term Equality and the Ternary Operator</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/1_basic/19_debugging/">Lesson 1.19: Debugging with GDB or LLDB</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/1_basic/20_backends/">Lesson 1.20: K Backends and the Haskell Backend</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/1_basic/21_symbolic_execution/">Lesson 1.21: Unification and Symbolic Execution</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/1_basic/22_proofs/">Lesson 1.22: K Deductive Verification</a></div>
</div></details>
<details style="padding:0.25rem 0;;padding-left: 16px;"><summary><a href="../../../../../../../../k-distribution/k-tutorial/2_intermediate/">Section 2: Intermediate K Concepts</a></summary><div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/2_intermediate/01_macros/">Lesson 2.1: Macros, Aliases, and Anywhere Rules</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/2_intermediate/02_fresh_constants/">Lesson 2.2: Fresh Constants</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/2_intermediate/03_klabels/">Lesson 2.3: KLabels and Abstract Syntax</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/2_intermediate/04_overloading/">Lesson 2.4: Overloaded Symbols</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/2_intermediate/05_matching_logic/">Lesson 2.5: Matching Logic Connectives and #Or Patterns</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/2_intermediate/06_function_context/">Lesson 2.6: Function Context</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/2_intermediate/07_record_productions/">Lesson 2.7: Record Productions and Named Nonterminals</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/2_intermediate/08_fun_and_let/">Lesson 2.8: #fun and #let</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/2_intermediate/09_as/">Lesson 2.9: #as Patterns</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/2_intermediate/10_matching_operator/">Lesson 2.10: The Matching Operators, :=K and :/=K</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/2_intermediate/11_evaluation_order/">Lesson 2.11: Uncommon Evaluation Order Concepts</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/2_intermediate/12_floats_and_machine_ints/">Lesson 2.12: IEEE 754 Floating Point and Fixed Width Integers</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/2_intermediate/13_substitution/">Lesson 2.13: Alpha-renaming-aware Substitution</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/2_intermediate/14_io/">Lesson 2.14: File I/O</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/2_intermediate/15_string_buffers_and_bytes/">Lesson 2.15: String Buffers and Byte Sequences</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/2_intermediate/16_kore/">Lesson 2.16: The Intermediate Language of K, KORE</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../k-distribution/k-tutorial/2_intermediate/17_debugging_proofs/">Lesson 2.17: Debugging Proofs using the Haskell Backend REPL</a></div>
</div></details>
</div></details>
<div style="padding:0.25rem 0;;padding-left: 8px;"><a href="../../../../../../../../docs/user_manual/">K User Manual</a></div>
<div style="padding:0.25rem 0;;padding-left: 8px;"><a href="../../../../../../../../docs/cheat_sheet/">K Cheat Sheet</a></div>
<div style="padding:0.25rem 0;;padding-left: 8px;"><a href="../../../../../../../../docs/ktools/">K Tool Reference</a></div>
<details style="padding:0.25rem 0;;padding-left: 8px;"><summary><a href="../../../../../../../../k-distribution/include/kframework/">K Builtins</a></summary><div>
<div style="padding:0.25rem 0;;padding-left: 16px;"><a href="../../../../../../../../k-distribution/include/kframework/builtin/domains/">domains</a></div>
<div style="padding:0.25rem 0;;padding-left: 16px;"><a href="../../../../../../../../k-distribution/include/kframework/builtin/kast/">kast</a></div>
<div style="padding:0.25rem 0;;padding-left: 16px;"><a href="../../../../../../../../k-distribution/include/kframework/builtin/prelude/">prelude</a></div>
<div style="padding:0.25rem 0;;padding-left: 16px;"><a href="../../../../../../../../k-distribution/include/kframework/builtin/ffi/">ffi</a></div>
<div style="padding:0.25rem 0;;padding-left: 16px;"><a href="../../../../../../../../k-distribution/include/kframework/builtin/json/">json</a></div>
<div style="padding:0.25rem 0;;padding-left: 16px;"><a href="../../../../../../../../k-distribution/include/kframework/builtin/rat/">rat</a></div>
<div style="padding:0.25rem 0;;padding-left: 16px;"><a href="../../../../../../../../k-distribution/include/kframework/builtin/substitution/">substitution</a></div>
<div style="padding:0.25rem 0;;padding-left: 16px;"><a href="https://github.com/runtimeverification/k/blob/master/k-distribution/include/kframework/builtin/unification.k">unification</a></div>
</div></details>
<details style="padding:0.25rem 0;;padding-left: 8px;"><summary><a href="../../../../../../../../k-distribution/pl-tutorial/">K PL Tutorial</a></summary><div>
<div style="padding:0.25rem 0;;padding-left: 16px;"><a href="../../../../../../../../overview/">K Overview</a></div>
<details style="padding:0.25rem 0;;padding-left: 16px;"><summary><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/">Learning K</a></summary><div>
<details style="padding:0.25rem 0;;padding-left: 24px;"><summary><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/1_lambda/">Part 1: Defining LAMBDA</a></summary><div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/1_lambda/lesson_1/">Lesson 1, LAMBDA: Syntax Modules and Basic K Commands</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/1_lambda/lesson_2/">Lesson 2, LAMBDA: Module Importing, Rules, Variables</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/1_lambda/lesson_3/">Lesson 3, LAMBDA: Evaluation Strategies using Strictness</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/1_lambda/lesson_4/">Lesson 4, LAMBDA: Generating Documentation; Latex Attributes</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/1_lambda/lesson_5/">Lesson 5, LAMBDA: Adding Builtins; Side Conditions</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/1_lambda/lesson_6/">Lesson 6, LAMBDA: Selective Strictness; Anonymous Variables</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/1_lambda/lesson_7/">Lesson 7, LAMBDA: Derived Constructs; Extending Predefined Syntax</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/1_lambda/lesson_8/">Lesson 8, LAMBDA: Multiple Binding Constructs</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/1_lambda/lesson_9/">Lesson 9, LAMBDA: A Complete and Commented Definition</a></div>
</div></details>
<details style="padding:0.25rem 0;;padding-left: 24px;"><summary><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/2_imp/">Part 2: Defining IMP</a></summary><div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/2_imp/lesson_1/">Lesson 1, IMP: Defining a More Complex Syntax</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/2_imp/lesson_2/">Lesson 2, IMP: Defining a Configuration</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/2_imp/lesson_3/">Lesson 3, IMP: Computations, Results, Strictness; Rules Involving Cells</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/2_imp/lesson_4/">Lesson 4, IMP: Configuration Abstraction, Part 1; Types of Rules</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/2_imp/lesson_5/">Lesson 5, IMP: Completing and Documenting IMP</a></div>
</div></details>
<details style="padding:0.25rem 0;;padding-left: 24px;"><summary><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/3_lambda++/">Part 3: Defining LAMBDA++</a></summary><div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/3_lambda++/lesson_1/">Lesson 1, LAMBDA++: Abrupt Changes of Control</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/3_lambda++/lesson_2/">Lesson 2, LAMBDA++: Semantic (Non-Syntactic) Computation Items</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/3_lambda++/lesson_3/">Lesson 3, LAMBDA++: Reusing Existing Semantics</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/3_lambda++/lesson_4/">Lesson 4, LAMBDA++: Do Not Reuse Blindly!</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/3_lambda++/lesson_5/">Lesson 5, LAMBDA++: More Semantic Computation Items</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/3_lambda++/lesson_6/">Lesson 6, LAMBDA++: Wrapping Up and Documenting LAMBDA++ (environment-based)</a></div>
</div></details>
<details style="padding:0.25rem 0;;padding-left: 24px;"><summary><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/4_imp++/">Part 4: Defining IMP++</a></summary><div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/4_imp++/lesson_1/">Lesson 1, IMP++: Extending/Changing an Existing Language Syntax</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/4_imp++/lesson_2/">Lesson 2, IMP++: Configuration Refinement; Freshness</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/4_imp++/lesson_3/">Lesson 3, IMP++: Tagging; Superheat/Supercool Kompilation Options</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/4_imp++/lesson_4/">Lesson 4, IMP++: Semantic Lists; Input/Output Streaming</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/4_imp++/lesson_5/">Lesson 5, IMP++: Deleting, Saving and Restoring Cell Contents</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/4_imp++/lesson_6/">Lesson 6, IMP++: Adding/Deleting Cells Dynamically; Configuration Abstraction, Part 2</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/4_imp++/lesson_7/">Lesson 7, IMP++: Everything Changes: Syntax, Configuration, Semantics</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/4_imp++/lesson_8/">Lesson 8, IMP++: Wrapping up Larger Languages</a></div>
</div></details>
<details style="padding:0.25rem 0;;padding-left: 24px;"><summary><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/5_types/">Part 5: Defining Type Systems</a></summary><div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/5_types/lesson_1/">Lesson 1, Type Systems: Imperative, Environment-Based Type Systems</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/5_types/lesson_2/">Lesson 2, Type Systems: Substitution-Based Higher-Order Type Systems</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/5_types/lesson_3/">Lesson 3, Type Systems: Environment-Based Higher-Order Type Systems</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/5_types/lesson_4/">Lesson 4, Type Systems: A Naive Substitution-Based Type Inferencer</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/5_types/lesson_5/">Lesson 5, Type Systems: A Naive Environment-Based Type Inferencer</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/5_types/lesson_6/">Lesson 6, Type Systems: Parallel Type Checkers/Inferencers</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/5_types/lesson_7/">Lesson 7, Type Systems: A Naive Substitution-based Polymorphic Type Inferencer</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/5_types/lesson_8/">Lesson 8, Type Systems: A Naive Environment-based Polymorphic Type Inferencer</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/1_k/5_types/lesson_9/">Lesson 9, Type Systems: Let-Polymorphic Type Inferencer (Damas-Hindley-Milner)</a></div>
</div></details>
</div></details>
<details style="padding:0.25rem 0;;padding-left: 16px;"><summary><a href="../../../../../../../../k-distribution/pl-tutorial/2_languages/">Learning Language Design and Semantics using K</a></summary><div>
<details style="padding:0.25rem 0;;padding-left: 24px;"><summary><a href="../../../../../../../../k-distribution/pl-tutorial/2_languages/1_simple/1_untyped/simple-untyped/">Part 7: SIMPLE: Designing Imperative Programming Languages</a></summary><div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/2_languages/1_simple/1_untyped/simple-untyped/">Lesson 1, SIMPLE untyped</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/2_languages/1_simple/2_typed/1_static/simple-typed-static/">Lesson 2, SIMPLE typed static</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/2_languages/1_simple/2_typed/2_dynamic/simple-typed-dynamic/">Lesson 3, SIMPLE typed dynamic</a></div>
</div></details>
<details style="padding:0.25rem 0;;padding-left: 24px;"><summary><a href="../../../../../../../../k-distribution/pl-tutorial/2_languages/2_kool/1_untyped/kool-untyped/">Part 8: KOOL: Designing Object-Oriented Programming Languages</a></summary><div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/2_languages/2_kool/1_untyped/kool-untyped/">Lesson 1, KOOL untyped</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/2_languages/2_kool/2_typed/1_dynamic/kool-typed-dynamic/">Lesson 2, KOOL typed dynamic</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/2_languages/2_kool/2_typed/2_static/kool-typed-static/">Lesson 3, KOOL typed static</a></div>
</div></details>
<details style="padding:0.25rem 0;;padding-left: 24px;"><summary><a href="../../../../../../../../k-distribution/pl-tutorial/2_languages/3_fun/1_untyped/1_environment/fun-untyped/">Part 9: FUN: Designing Functional Programming Languages</a></summary><div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/2_languages/3_fun/1_untyped/1_environment/fun-untyped/">Lesson 1, FUN untyped, Environment-Based</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/2_languages/3_fun/1_untyped/2_substitution/fun-untyped/">Lesson 2, FUN untyped, Substitution-Based</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;">Lesson 3, FUN polymorphic type inferencer</div>
</div></details>
<details style="padding:0.25rem 0;;padding-left: 24px;"><summary><a href="../../../../../../../../k-distribution/pl-tutorial/2_languages/4_logik/basic/logik/">Part 10: LOGIK: Designing Logic Programming Languages</a></summary><div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../k-distribution/pl-tutorial/2_languages/4_logik/basic/logik/">Lesson 1, LOGIK</a></div>
</div></details>
</div></details>
</div></details>
<div style="padding:0.25rem 0;;padding-left: 8px;"><a href="../../../../../../../../projects/">Projects using K</a></div>
</div></div>
  </nav>
</div>

        <main
          class="col-12 col-md-6 col-xl-8 py-md-3 pl-md-5 bd-content"
          role="main"
        >
          <div class="introduction markdown-preview"><html><head></head><body><h1 id="kool-%E2%80%94-untyped">KOOL — Untyped</h1>
<p>Author: Grigore Roșu (grosu@illinois.edu)<br>
Organization: University of Illinois at Urbana-Champaign</p>
<p>Author: Traian Florin Șerbănuță (traian.serbanuta@unibuc.ro)<br>
Organization: University of Bucharest</p>
<h2 id="abstract">Abstract</h2>
<p>This is the <strong>K</strong> semantic definition of the untyped KOOL language.  KOOL
is aimed at being a pedagogical and research language that captures
the essence of the object-oriented programming paradigm.  Its untyped
variant discussed here is simpler than the typed one, ignoring several
intricate aspects of types in the presence of objects.  A program
consists of a set of class declarations.  Each class can extend at
most one other class (KOOL is single-inheritance).  A class can
declare a set of fields and a set of methods, all public and called
the class' <em>members</em>.  Specifically, KOOL includes the
following features:</p>
<ul>
<li>
<p>Class declarations, where a class may or may not explicitly
extend another class.  In case a class does not explicitly extend
another class, then it is assumed that it extends the default top-most
and empty (i.e., no members) class called <code>Object</code>.  Each class
is required to declare precisely one homonymous method, called its
<em>constructor</em>.  Each valid program should contain one class
named <code>Main</code>, whose constructor, <code>Main()</code>, takes no
arguments.  The execution of a program consists of creating an object
instance of class <code>Main</code> and invoking the constructor
<code>Main()</code> on it, that is, of executing <code>new Main();</code>.</p>
</li>
<li>
<p>All features of SIMPLE (see <code>examples/simple/untyped</code>),
i.e., multidimensional arrays, function (here called "method")
abstractions with call-by-value parameter passing style and static
scoping, blocks with locals, input/output, parametric exceptions, and
concurrency via dynamic thread creation/termination and synchronization.
The only change in the syntax of SIMPLE when imported in KOOL is the
function declaration keyword, <code>function</code>, which is changed into
<code>method</code>.  The exact same desugaring macros from SIMPLE are
also included in KOOL.  We can think of KOOL's classes as embedding
SIMPLE programs (extended with OO constructs, as discussed next).</p>
</li>
<li>
<p>Object creation using the <code>new C(e1,...,en)</code>
expression construct.  An object instance of class <code>C</code> is first
created and then the constructor <code>C(e1,...,en)</code> is implicitly
called on that object.  KOOL only allows (and requires) one
constructor per class.  The class constructor can be called either
implicitly during a new object creation for the class, or explicitly.
The superclass constructor is <strong>not</strong> implicitly invoked when a
class constructor is invoked; if you want to invoke the superclass
constructor from a subclass constructor then you have to do it
explicitly.</p>
</li>
<li>
<p>An expression construct <code>this</code>, which evaluates to the
current object.</p>
</li>
<li>
<p>An expression construct <code>super</code>, which is used (only) in
combination with member lookup (see next) to refer to a superclass
field or method.</p>
</li>
<li>
<p>A member lookup expression construct <code>e.x</code>, where <code>e</code>
is an expression (either an expression expected to evaluate to an object
or the <code>super</code> construct) and <code>x</code> is a class member name,
that is, a field or a method name.</p>
</li>
<li>
<p>Expression constructs <code>e instanceOf C</code> and
<code>(C) e</code>, where <code>e</code> is an expression expected
to evaluate to an object and <code>C</code> a class name.  The former
tells whether the class of <code>e</code> is a subclass of <code>C</code>,
that is, whether <code>e</code> can be used as an instance of <code>C</code>,
and the latter changes the class of <code>e</code> to <code>C</code>.  These
operations always succeed: the former returns a Boolean value, while
the latter changes the current class of <code>e</code> to <code>C</code>
regardless of whether it is safe to do so or not.  The typed version
of KOOL will check the safety of casting by ensuring that the instance
class of the object is a subclass of <code>C</code>.  In untyped KOOL we
do not want to perform this check because we want to allow the
programmer maximum of flexibility: if one always accesses only
available members, then the program can execute successfully despite
the potentially unsafe cast.</p>
</li>
</ul>
<p>There are some specific aspects of KOOL that need to be discussed.</p>
<p>First, KOOL is higher-order, allowing function abstractions to be
treated like any other values in the language.  For example, if
<code>m</code> is a method of object <code>e</code> then <code>e.m</code>
evaluates to the corresponding function abstraction.  The function
abstraction is in fact a closure, because in addition to the method
parameters and body it also encapsulates the object value (i.e., the
environment of the object together with its current class—see below)
that <code>e</code> evaluates to.  This way, function abstractions can be
invoked anywhere and have the capability to change the state of their
object.  For example, if <code>m</code> is a method of object <code>e</code>
which increments a field <code>c</code> of <code>e</code> when invoked, and if
<code>getm</code> is another method of <code>e</code> which simply returns
<code>m</code> when invoked, then the double application
<code>(e.getm())()</code> has the same effect as <code>e.m()</code>, that is,
increments the counter <code>c</code> of <code>e</code>.  Note that the
higher-order nature of KOOL was not originally planned; it came as a
natural consequence of evaluating methods to closures and we decided
to keep it.  If you do not like it then do not use it.</p>
<p>Second, since all the fields and methods are public in KOOL and since
they can be redeclared in subclasses, it is not immediately clear how
to lookup the member <code>x</code> when we write <code>e.x</code> and
<code>e</code> is different from <code>super</code>.  We distinguish two cases,
depending on whether <code>e.x</code> occurs in a method invocation
context (i.e., <code>e.x(...)</code>) or in a field context.  KOOL has
dynamic method dispatch, so if <code>e.x</code> is invoked as a method
then <code>x</code> will be searched for starting with the instance class of
the object value to which <code>e</code> evaluates.  If <code>e.x</code>
occurs in a non-method-invocation context then <code>x</code> will be
treated as a field (although it may hold a method closure due to the
higher-order nature of KOOL) and thus will be searched starting with
the current class of the object value of <code>e</code> (which, because of
<code>this</code> and casting, may be different from its instance class).
In order to achieve the above, each object value will consist of a
pair holding the current class of the object and an environment stack
with one layer for each class in the object's instance class hierarchy.</p>
<p>Third, although KOOL is dynamic method dispatch, its capabilities
described above are powerful enough to allow us to mimic static
method dispatch.  For example, suppose that you want to invoke method
<code>m()</code> statically.  Then all you need to do is to declare a
local variable and bind it to <code>m</code>, for example <code>var staticm = m;</code>, and
then call <code>staticm()</code>.  This works because
<code>staticm</code> is first bound to the method closure that <code>m</code>
evaluates to, and then looked up as any local variable when invoked.
We only enable the dynamic method dispatch when we have an object
member on an application position, e.g., <code>m()</code>.</p>
<p>In what follows, we limit our comments to the new, KOOL-specific
aspects of the language.  We refer the reader to the untyped SIMPLE
language for documentation on the the remaining features, because
those were all borrowed from SIMPLE.</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k"><span class="token keyword">module</span> KOOL<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>SYNTAX
  <span class="token keyword">imports</span> DOMAINS<span class="token operator">-</span>SYNTAX
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="syntax">Syntax</h2>
<p>The syntax of KOOL extends that of SIMPLE with object-oriented
constructs.  We removed from the <strong>K</strong> annotated syntax of SIMPLE two
constructs, namely the one for function declarations (because we want
to call them <code>methods</code> now) and the one for function application
(because application is not strict in the first argument
anymore—needs to initiate dynamic method dispatch).  The additional
syntax includes:</p>
<ul>
<li>First, we need a new dedicated identifier, <code>Object</code>, for
the default top-most class.</li>
<li>Second, we rename the <code>function</code> keyword of SIMPLE into <code>method</code>.</li>
<li>Third, we add syntax for class declarations together with a
macro making classes which extend nothing to extend <code>Object</code>.</li>
<li>Fourth, we change the strictness attribute of application
into <code>strict(2)</code>.</li>
<li>Finally, we add syntax and corresponding strictness
for the KOOL object-oriented constructs.</li>
</ul>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> <span class="token keyword">Id</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">"Object"</span> <span class="token punctuation">[</span><span class="token class-name">token</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token string">"Main"</span> <span class="token punctuation">[</span><span class="token class-name">token</span><span class="token punctuation">]</span>

  <span class="token keyword">syntax</span> Stmt <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">"var"</span> Exps <span class="token string">";"</span>
                <span class="token operator">|</span> <span class="token string">"method"</span> <span class="token keyword">Id</span> <span class="token string">"("</span> Ids <span class="token string">")"</span> Block  <span class="token comment">// called "function" in SIMPLE</span>
                <span class="token operator">|</span> <span class="token string">"class"</span> <span class="token keyword">Id</span> Block               <span class="token comment">// KOOL</span>
                <span class="token operator">|</span> <span class="token string">"class"</span> <span class="token keyword">Id</span> <span class="token string">"extends"</span> <span class="token keyword">Id</span> Block  <span class="token comment">// KOOL</span>

  <span class="token keyword">syntax</span> Exp <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token keyword">Int</span> <span class="token operator">|</span> <span class="token keyword">Bool</span> <span class="token operator">|</span> <span class="token keyword">String</span> <span class="token operator">|</span> <span class="token keyword">Id</span>
               <span class="token operator">|</span> <span class="token string">"this"</span>                                 <span class="token comment">// KOOL</span>
               <span class="token operator">|</span> <span class="token string">"super"</span>                                <span class="token comment">// KOOL</span>
               <span class="token operator">|</span> <span class="token string">"("</span> Exp <span class="token string">")"</span>             <span class="token punctuation">[</span><span class="token class-name">bracket</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> <span class="token string">"++"</span> Exp
               <span class="token operator">|</span> Exp <span class="token string">"instanceOf"</span> <span class="token keyword">Id</span>     <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>    <span class="token comment">// KOOL</span>
               <span class="token operator">|</span> <span class="token string">"("</span> <span class="token keyword">Id</span> <span class="token string">")"</span> Exp          <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>    <span class="token comment">// KOOL  cast</span>
               <span class="token operator">|</span> <span class="token string">"new"</span> <span class="token keyword">Id</span> <span class="token string">"("</span> Exps <span class="token string">")"</span>   <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>    <span class="token comment">// KOOL</span>
               <span class="token operator">|</span> Exp <span class="token string">"."</span> <span class="token keyword">Id</span>                             <span class="token comment">// KOOL</span>
               &gt; Exp <span class="token string">"["</span> Exps <span class="token string">"]"</span>        <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">]</span>
               &gt; Exp <span class="token string">"("</span> Exps <span class="token string">")"</span>        <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>    <span class="token comment">// was strict in SIMPLE</span>
               <span class="token operator">|</span> <span class="token string">"-"</span> Exp                 <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> <span class="token string">"sizeOf"</span> <span class="token string">"("</span> Exp <span class="token string">")"</span>    <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> <span class="token string">"read"</span> <span class="token string">"("</span> <span class="token string">")"</span>
               &gt; <span class="token class-name">left</span><span class="token punctuation">:</span>
                 Exp <span class="token string">"*"</span> Exp             <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> <span class="token class-name">left</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">"/"</span> Exp             <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> <span class="token class-name">left</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">"%"</span> Exp             <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> <span class="token class-name">left</span><span class="token punctuation">]</span>
               &gt; <span class="token class-name">left</span><span class="token punctuation">:</span>
                 Exp <span class="token string">"+"</span> Exp             <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> <span class="token class-name">left</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">"-"</span> Exp             <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> <span class="token class-name">left</span><span class="token punctuation">]</span>
               &gt; <span class="token class-name">non-assoc</span><span class="token punctuation">:</span>
                 Exp <span class="token string">"&lt;"</span> Exp             <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> <span class="token class-name">non-assoc</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">"&lt;="</span> Exp            <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> <span class="token class-name">non-assoc</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">"&gt;"</span> Exp             <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> <span class="token class-name">non-assoc</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">"&gt;="</span> Exp            <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> <span class="token class-name">non-assoc</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">"=="</span> Exp            <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> <span class="token class-name">non-assoc</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">"!="</span> Exp            <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> <span class="token class-name">non-assoc</span><span class="token punctuation">]</span>
               &gt; <span class="token string">"!"</span> Exp                 <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">]</span>
               &gt; <span class="token class-name">left</span><span class="token punctuation">:</span>
                 Exp <span class="token string">"&amp;&amp;"</span> Exp            <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">left</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">"||"</span> Exp            <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">left</span><span class="token punctuation">]</span>
               &gt; <span class="token string">"spawn"</span> Block
               &gt; Exp <span class="token string">"="</span> Exp             <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">right</span><span class="token punctuation">]</span>

  <span class="token keyword">syntax</span> Ids  <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> List<span class="token punctuation">{</span><span class="token keyword">Id</span><span class="token punctuation">,</span><span class="token string">","</span><span class="token punctuation">}</span>

  <span class="token keyword">syntax</span> Exps <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> List<span class="token punctuation">{</span>Exp<span class="token punctuation">,</span><span class="token string">","</span><span class="token punctuation">}</span>          <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> overload<span class="token punctuation">(</span>exps<span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token keyword">syntax</span> Val
  <span class="token keyword">syntax</span> Vals <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> List<span class="token punctuation">{</span>Val<span class="token punctuation">,</span><span class="token string">","</span><span class="token punctuation">}</span>          <span class="token punctuation">[</span>overload<span class="token punctuation">(</span>exps<span class="token punctuation">)</span><span class="token punctuation">]</span>

  <span class="token keyword">syntax</span> Block <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">"{"</span> <span class="token string">"}"</span>
                <span class="token operator">|</span> <span class="token string">"{"</span> Stmt <span class="token string">"}"</span>

  <span class="token keyword">syntax</span> Stmt <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Block
                <span class="token operator">|</span> Exp <span class="token string">";"</span>                               <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">]</span>
                <span class="token operator">|</span> <span class="token string">"if"</span> <span class="token string">"("</span> Exp <span class="token string">")"</span> Block <span class="token string">"else"</span> Block   <span class="token punctuation">[</span><span class="token class-name">avoid</span><span class="token punctuation">,</span> <span class="token class-name">strict</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
                <span class="token operator">|</span> <span class="token string">"if"</span> <span class="token string">"("</span> Exp <span class="token string">")"</span> Block                <span class="token punctuation">[</span><span class="token class-name">macro</span><span class="token punctuation">]</span>
                <span class="token operator">|</span> <span class="token string">"while"</span> <span class="token string">"("</span> Exp <span class="token string">")"</span> Block
                <span class="token operator">|</span> <span class="token string">"for"</span> <span class="token string">"("</span> Stmt Exp <span class="token string">";"</span> Exp <span class="token string">")"</span> Block  <span class="token punctuation">[</span><span class="token class-name">macro</span><span class="token punctuation">]</span>
                <span class="token operator">|</span> <span class="token string">"return"</span> Exp <span class="token string">";"</span>                      <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">]</span>
                <span class="token operator">|</span> <span class="token string">"return"</span> <span class="token string">";"</span>                          <span class="token punctuation">[</span><span class="token class-name">macro</span><span class="token punctuation">]</span>
                <span class="token operator">|</span> <span class="token string">"print"</span> <span class="token string">"("</span> Exps <span class="token string">")"</span> <span class="token string">";"</span>              <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">]</span>
                <span class="token operator">|</span> <span class="token string">"try"</span> Block <span class="token string">"catch"</span> <span class="token string">"("</span> <span class="token keyword">Id</span> <span class="token string">")"</span> Block
                <span class="token operator">|</span> <span class="token string">"throw"</span> Exp <span class="token string">";"</span>                       <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">]</span>
                <span class="token operator">|</span> <span class="token string">"join"</span> Exp <span class="token string">";"</span>                        <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">]</span>
                <span class="token operator">|</span> <span class="token string">"acquire"</span> Exp <span class="token string">";"</span>                     <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">]</span>
                <span class="token operator">|</span> <span class="token string">"release"</span> Exp <span class="token string">";"</span>                     <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">]</span>
                <span class="token operator">|</span> <span class="token string">"rendezvous"</span> Exp <span class="token string">";"</span>                  <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">]</span>

  <span class="token keyword">syntax</span> Stmt <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Stmt Stmt                          <span class="token punctuation">[</span><span class="token class-name">right</span><span class="token punctuation">]</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Old desugaring rules, from SIMPLE</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">rule</span> if <span class="token punctuation">(</span>E<span class="token punctuation">)</span> S <span class="token operator">=&gt;</span> if <span class="token punctuation">(</span>E<span class="token punctuation">)</span> S else <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">rule</span> for<span class="token punctuation">(</span>Start Cond<span class="token punctuation">;</span> Step<span class="token punctuation">)</span> <span class="token punctuation">{</span>S<span class="token punctuation">}</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>Start while <span class="token punctuation">(</span>Cond<span class="token punctuation">)</span> <span class="token punctuation">{</span>S Step<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token keyword">rule</span> var E1<span class="token punctuation">:</span><span class="token punctuation">:</span>Exp<span class="token punctuation">,</span> E2<span class="token punctuation">:</span><span class="token punctuation">:</span>Exp<span class="token punctuation">,</span> Es<span class="token punctuation">:</span><span class="token punctuation">:</span>Exps<span class="token punctuation">;</span> <span class="token operator">=&gt;</span> var E1<span class="token punctuation">;</span> var E2<span class="token punctuation">,</span> Es<span class="token punctuation">;</span>       <span class="token punctuation">[</span>anywhere<span class="token punctuation">]</span>
  <span class="token keyword">rule</span> var X<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">Id</span> <span class="token operator">=</span> E<span class="token punctuation">;</span> <span class="token operator">=&gt;</span> var X<span class="token punctuation">;</span> X <span class="token operator">=</span> E<span class="token punctuation">;</span>                              <span class="token punctuation">[</span>anywhere<span class="token punctuation">]</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>New desugaring rule</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">rule</span> class C<span class="token punctuation">:</span><span class="token keyword">Id</span> S <span class="token operator">=&gt;</span> class C extends Object S                     <span class="token comment">// KOOL</span>

<span class="token keyword">endmodule</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="semantics">Semantics</h2>
<p>We first discuss the new configuration of KOOL, which extends that of
SIMPLE.  Then we include the semantics of the constructs borrowed from
SIMPLE unchanged; we refrain from discussing those, because they were
already discussed in the <strong>K</strong> definition of SIMPLE.  Then we discuss
changes to SIMPLE's semantics needed for the more general meaning of
the previous SIMPLE constructs (for example for thread spawning,
assignment, etc.).  Finally, we discuss in detail the
semantics of the additional KOOL constructs.</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k"><span class="token keyword">module</span> KOOL<span class="token operator">-</span>UNTYPED
  <span class="token keyword">imports</span> KOOL<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>SYNTAX
  <span class="token keyword">imports</span> DOMAINS
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="configuration">Configuration</h2>
<p>KOOL removes one cell and adds two nested cells to the configuration
of SIMPLE.  The cell which is removed is the one holding the global
environment, because a KOOL program consists of a set of classes only,
with no global declarations.  In fact, since informally speaking each
KOOL class now includes a SIMPLE program, it is safe to say that the
global variables in SIMPLE became class fields in KOOL.  Let us now
discuss the new cells that are added to the configuration of SIMPLE.</p>
<ul>
<li>
<p>The cell <code>crntObj</code> holds data pertaining to the current
object, that is, the object environment in which the code in cell
<code>k</code> executes: <code>crntClass</code> holds the current class (which
can change as methods of the current object are invoked);
<code>envStack</code> holds the stack of environments as a list,
each layer corresponding to one class in the objects' instance class
hierarchy; <code>location</code>, which is optional, holds the location in
the store where the current object is or has to be located (this is
useful both for method closures and for the semantics of object
creation).</p>
</li>
<li>
<p>The cell <code>classes</code> holds all the declared classes, each
class being held in its own <code>class</code> cell which contains a name
(<code>className</code>), a parent (<code>extends</code>), and the actual
member declarations (<code>declarations</code>).</p>
</li>
</ul>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token comment">// the syntax declarations below are required because the sorts are</span>
  <span class="token comment">// referenced directly by a production and, because of the way KIL to KORE</span>
  <span class="token comment">// is implemented, the configuration syntax is not available yet</span>
  <span class="token comment">// should simply work once KIL is removed completely</span>
  <span class="token comment">// check other definitions for this hack as well</span>
  <span class="token keyword">syntax</span> EnvCell
  <span class="token keyword">syntax</span> ControlCell
  <span class="token keyword">syntax</span> EnvStackCell
  <span class="token keyword">syntax</span> CrntObjCellFragment

  <span class="token keyword">configuration</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>T</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>red<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>threads</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>orange<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>thread</span> <span class="token attr-name">multiplicity</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>*<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Set<span class="token punctuation">"</span></span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>yellow<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>green<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> $PGM<span class="token punctuation">:</span>Stmt <span class="token operator">~&gt;</span> execute <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
                    <span class="token comment">//&lt;br/&gt; // TODO(KORE): support latex annotations #1799</span>
                      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>control</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cyan<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>fstack</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>blue<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span>List <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>fstack</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xstack</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>purple<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span>List <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xstack</span><span class="token punctuation">&gt;</span></span>
                      <span class="token comment">//&lt;br/&gt; // TODO(KORE): support latex annotations #1799</span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>crntObj</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Fuchsia<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>  <span class="token comment">// KOOL</span>
                           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>crntClass</span><span class="token punctuation">&gt;</span></span> Object <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>crntClass</span><span class="token punctuation">&gt;</span></span>
                           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>envStack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span>List <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>envStack</span><span class="token punctuation">&gt;</span></span>
                           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span> <span class="token attr-name">multiplicity</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span>K <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>crntObj</span><span class="token punctuation">&gt;</span></span>
                      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>control</span><span class="token punctuation">&gt;</span></span>
                    <span class="token comment">//&lt;br/&gt; // TODO(KORE): support latex annotations #1799</span>
                      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>violet<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span>Map <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env</span><span class="token punctuation">&gt;</span></span>
                      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>holds</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>black<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span>Map <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>holds</span><span class="token punctuation">&gt;</span></span>
                      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>pink<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> <span class="token number">0</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>thread</span><span class="token punctuation">&gt;</span></span>
                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>threads</span><span class="token punctuation">&gt;</span></span>
                <span class="token comment">//&lt;br/&gt; // TODO(KORE): support latex annotations #1799</span>
                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>store</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>white<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span>Map <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>store</span><span class="token punctuation">&gt;</span></span>
                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>busy</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cyan<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span>Set <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>busy</span><span class="token punctuation">&gt;</span></span>
                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>terminated</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>red<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span>Set <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>terminated</span><span class="token punctuation">&gt;</span></span>
                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>magenta<span class="token punctuation">"</span></span> <span class="token attr-name">stream</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stdin<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span>List <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>input</span><span class="token punctuation">&gt;</span></span>
                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>output</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>brown<span class="token punctuation">"</span></span> <span class="token attr-name">stream</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stdout<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span>List <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>output</span><span class="token punctuation">&gt;</span></span>
                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nextLoc</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>gray<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> <span class="token number">0</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nextLoc</span><span class="token punctuation">&gt;</span></span>
                <span class="token comment">//&lt;br/&gt; // TODO(KORE): support latex annotations #1799</span>
                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>classes</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Fuchsia<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>        <span class="token comment">// KOOL</span>
                     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>classData</span> <span class="token attr-name">multiplicity</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>*<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Map<span class="token punctuation">"</span></span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Fuchsia<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                        <span class="token comment">// the Map has as its key the first child of the cell,</span>
                        <span class="token comment">// in this case the className cell.</span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>className</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Fuchsia<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> Main <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>className</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>baseClass</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Fuchsia<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> Object <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>baseClass</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>declarations</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Fuchsia<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span>K <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>declarations</span><span class="token punctuation">&gt;</span></span>
                     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>classData</span><span class="token punctuation">&gt;</span></span>
                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>classes</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>T</span><span class="token punctuation">&gt;</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="unchanged-semantics-from-untyped-simple">Unchanged Semantics from untyped SIMPLE</h2>
<p>The semantics below is taken over from SIMPLE unchanged.
The semantics of function declaration and invocation, including the
use of the special <code>lambda</code> abstraction value, needs to change
in order to account for the fact that methods are now invoked into
their object's environment.  The semantics of function return actually
stays unchanged.  Also, the semantics of program initialization is
different: now we have to create an instance of the <code>Main</code>
class which also calls the constructor <code>Main()</code>, while in
SIMPLE we only had to invoke the function <code>Main()</code>.
Finally, the semantics of thread spawning needs to change, too: the
parent thread needs to also share its object environment with the
spawned thread (in addition to its local environment, like in SIMPLE).
This is needed in order to be able to spawn method invokations under
dynamic method dispatch; for example, <code>spawn { run(); }</code>
will need to look up the method <code>run()</code> in the newly created
thread, operation which will most likely fail unless the child thread
sees the object environment of the parent thread.  Note that the
<code>spawn</code> statement of KOOL is more permissive than the threads
of Java.  In fact, the latter can be implemented in terms of our
<code>spawn</code>—see the program <code>threads.kool</code> for a sketch.</p>
<p>Below is a subset of the values of SIMPLE, which are also values
of KOOL.  We will add other values later in the semantics, such as
object and method closures.</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> Val <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token keyword">Int</span> <span class="token operator">|</span> <span class="token keyword">Bool</span> <span class="token operator">|</span> <span class="token keyword">String</span>
               <span class="token operator">|</span> array<span class="token punctuation">(</span><span class="token keyword">Int</span><span class="token punctuation">,</span><span class="token keyword">Int</span><span class="token punctuation">)</span>
  <span class="token keyword">syntax</span> Exp <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Val
  <span class="token keyword">syntax</span> Exps <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Vals
  <span class="token keyword">syntax</span> KResult <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Val
  <span class="token keyword">syntax</span> KResult <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Vals
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>The semantics below are taken verbatim from the untyped SIMPLE
definition.</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">"undefined"</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> var X<span class="token punctuation">:</span><span class="token keyword">Id</span><span class="token punctuation">;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env</span><span class="token punctuation">&gt;</span></span> Env <span class="token operator">=&gt;</span> Env<span class="token punctuation">[</span>X &lt;<span class="token operator">-</span> L<span class="token punctuation">]</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>store</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span>Map <span class="token operator">=&gt;</span> L <span class="token operator">|</span><span class="token operator">-</span>&gt; undefined <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>store</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nextLoc</span><span class="token punctuation">&gt;</span></span> L<span class="token punctuation">:</span><span class="token keyword">Int</span> <span class="token operator">=&gt;</span> L <span class="token operator">+</span><span class="token keyword">Int</span> <span class="token number">1</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nextLoc</span><span class="token punctuation">&gt;</span></span>


  <span class="token keyword">context</span> var _<span class="token punctuation">:</span><span class="token keyword">Id</span><span class="token punctuation">[</span>HOLE<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> var X<span class="token punctuation">:</span><span class="token keyword">Id</span><span class="token punctuation">[</span>N<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env</span><span class="token punctuation">&gt;</span></span> Env <span class="token operator">=&gt;</span> Env<span class="token punctuation">[</span>X &lt;<span class="token operator">-</span> L<span class="token punctuation">]</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>store</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span>Map <span class="token operator">=&gt;</span> L <span class="token operator">|</span><span class="token operator">-</span>&gt; array<span class="token punctuation">(</span>L <span class="token operator">+</span><span class="token keyword">Int</span> <span class="token number">1</span><span class="token punctuation">,</span> N<span class="token punctuation">)</span>
                          <span class="token punctuation">(</span>L <span class="token operator">+</span><span class="token keyword">Int</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">(</span>L <span class="token operator">+</span><span class="token keyword">Int</span> N<span class="token punctuation">)</span> <span class="token operator">|</span><span class="token operator">-</span>&gt; undefined <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>store</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nextLoc</span><span class="token punctuation">&gt;</span></span> L<span class="token punctuation">:</span><span class="token keyword">Int</span> <span class="token operator">=&gt;</span> L <span class="token operator">+</span><span class="token keyword">Int</span> <span class="token number">1</span> <span class="token operator">+</span><span class="token keyword">Int</span> N <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nextLoc</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> N <span class="token operator">&gt;=</span><span class="token keyword">Int</span> <span class="token number">0</span>


  <span class="token keyword">syntax</span> <span class="token keyword">Id</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">"$1"</span> <span class="token punctuation">[</span><span class="token class-name">token</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token string">"$2"</span> <span class="token punctuation">[</span><span class="token class-name">token</span><span class="token punctuation">]</span>
  <span class="token keyword">rule</span> var X<span class="token punctuation">:</span><span class="token keyword">Id</span><span class="token punctuation">[</span>N1<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">,</span> N2<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">,</span> Vs<span class="token punctuation">:</span>Vals<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token operator">=&gt;</span> var X<span class="token punctuation">[</span>N1<span class="token punctuation">]</span><span class="token punctuation">;</span>
       <span class="token punctuation">{</span>
         var $<span class="token number">1</span><span class="token operator">=</span>X<span class="token punctuation">;</span>
         for<span class="token punctuation">(</span>var $<span class="token number">2</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> $<span class="token number">2</span> <span class="token operator">&lt;=</span> N1 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">++</span>$<span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           var X<span class="token punctuation">[</span>N2<span class="token punctuation">,</span>Vs<span class="token punctuation">]</span><span class="token punctuation">;</span>
           $<span class="token number">1</span><span class="token punctuation">[</span>$<span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> X<span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>


  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> X<span class="token punctuation">:</span><span class="token keyword">Id</span> <span class="token operator">=&gt;</span> V <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> X <span class="token operator">|</span><span class="token operator">-</span>&gt; L <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>store</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> L <span class="token operator">|</span><span class="token operator">-</span>&gt; V<span class="token punctuation">:</span>Val <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>store</span><span class="token punctuation">&gt;</span></span>  <span class="token punctuation">[</span>group<span class="token punctuation">(</span>lookup<span class="token punctuation">)</span><span class="token punctuation">]</span>


  <span class="token keyword">context</span> <span class="token operator">++</span><span class="token punctuation">(</span>HOLE <span class="token operator">=&gt;</span> lvalue<span class="token punctuation">(</span>HOLE<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token operator">++</span>loc<span class="token punctuation">(</span>L<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> I <span class="token operator">+</span><span class="token keyword">Int</span> <span class="token number">1</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>store</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> L <span class="token operator">|</span><span class="token operator">-</span>&gt; <span class="token punctuation">(</span>I<span class="token punctuation">:</span><span class="token keyword">Int</span> <span class="token operator">=&gt;</span> I <span class="token operator">+</span><span class="token keyword">Int</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>store</span><span class="token punctuation">&gt;</span></span>  <span class="token punctuation">[</span>group<span class="token punctuation">(</span>increment<span class="token punctuation">)</span><span class="token punctuation">]</span>


  <span class="token keyword">rule</span> I1 <span class="token operator">+</span> I2 <span class="token operator">=&gt;</span> I1 <span class="token operator">+</span><span class="token keyword">Int</span> I2
  <span class="token keyword">rule</span> Str1 <span class="token operator">+</span> Str2 <span class="token operator">=&gt;</span> Str1 <span class="token operator">+</span><span class="token keyword">String</span> Str2
  <span class="token keyword">rule</span> I1 <span class="token operator">-</span> I2 <span class="token operator">=&gt;</span> I1 <span class="token operator">-</span><span class="token keyword">Int</span> I2
  <span class="token keyword">rule</span> I1 <span class="token operator">*</span> I2 <span class="token operator">=&gt;</span> I1 <span class="token operator">*</span><span class="token keyword">Int</span> I2
  <span class="token keyword">rule</span> I1 <span class="token operator">/</span> I2 <span class="token operator">=&gt;</span> I1 <span class="token operator">/</span><span class="token keyword">Int</span> I2 <span class="token keyword">requires</span> I2 <span class="token operator">=</span><span class="token operator">/</span><span class="token operator">=</span>K <span class="token number">0</span>
  <span class="token keyword">rule</span> I1 <span class="token operator">%</span> I2 <span class="token operator">=&gt;</span> I1 <span class="token operator">%</span><span class="token keyword">Int</span> I2 <span class="token keyword">requires</span> I2 <span class="token operator">=</span><span class="token operator">/</span><span class="token operator">=</span>K <span class="token number">0</span>
  <span class="token keyword">rule</span> <span class="token operator">-</span> I <span class="token operator">=&gt;</span> <span class="token number">0</span> <span class="token operator">-</span><span class="token keyword">Int</span> I
  <span class="token keyword">rule</span> I1 &lt; I2 <span class="token operator">=&gt;</span> I1 &lt;<span class="token keyword">Int</span> I2
  <span class="token keyword">rule</span> I1 <span class="token operator">&lt;=</span> I2 <span class="token operator">=&gt;</span> I1 <span class="token operator">&lt;=</span><span class="token keyword">Int</span> I2
  <span class="token keyword">rule</span> I1 &gt; I2 <span class="token operator">=&gt;</span> I1 &gt;<span class="token keyword">Int</span> I2
  <span class="token keyword">rule</span> I1 <span class="token operator">&gt;=</span> I2 <span class="token operator">=&gt;</span> I1 <span class="token operator">&gt;=</span><span class="token keyword">Int</span> I2

  <span class="token keyword">rule</span> V1<span class="token punctuation">:</span>Val <span class="token operator">==</span> V2<span class="token punctuation">:</span>Val <span class="token operator">=&gt;</span> V1 <span class="token operator">==</span>K V2
  <span class="token keyword">rule</span> V1<span class="token punctuation">:</span>Val <span class="token operator">!=</span> V2<span class="token punctuation">:</span>Val <span class="token operator">=&gt;</span> V1 <span class="token operator">=</span><span class="token operator">/</span><span class="token operator">=</span>K V2
  <span class="token keyword">rule</span> <span class="token operator">!</span> T <span class="token operator">=&gt;</span> notBool<span class="token punctuation">(</span>T<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> <span class="token boolean">true</span>  <span class="token operator">&amp;&amp;</span> E <span class="token operator">=&gt;</span> E
  <span class="token keyword">rule</span> <span class="token boolean">false</span> <span class="token operator">&amp;&amp;</span> _ <span class="token operator">=&gt;</span> <span class="token boolean">false</span>
  <span class="token keyword">rule</span> <span class="token boolean">true</span>  <span class="token operator">||</span> _ <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> <span class="token boolean">false</span> <span class="token operator">||</span> E <span class="token operator">=&gt;</span> E


  <span class="token keyword">rule</span> V<span class="token punctuation">:</span>Val<span class="token punctuation">[</span>N1<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">,</span> N2<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">,</span> Vs<span class="token punctuation">:</span>Vals<span class="token punctuation">]</span> <span class="token operator">=&gt;</span> V<span class="token punctuation">[</span>N1<span class="token punctuation">]</span><span class="token punctuation">[</span>N2<span class="token punctuation">,</span> Vs<span class="token punctuation">]</span>
    <span class="token punctuation">[</span>anywhere<span class="token punctuation">]</span>

  <span class="token keyword">rule</span> array<span class="token punctuation">(</span>L<span class="token punctuation">,</span>_<span class="token punctuation">)</span><span class="token punctuation">[</span>N<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">]</span> <span class="token operator">=&gt;</span> lookup<span class="token punctuation">(</span>L <span class="token operator">+</span><span class="token keyword">Int</span> N<span class="token punctuation">)</span>
    <span class="token punctuation">[</span>anywhere<span class="token punctuation">]</span>


  <span class="token keyword">rule</span> sizeOf<span class="token punctuation">(</span>array<span class="token punctuation">(</span>_<span class="token punctuation">,</span>N<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> N
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>The semantics of function application needs to change into dynamic
method dispatch invocation, which is defined shortly.  However,
interestingly, the semantics of return stays unchanged.</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> return<span class="token punctuation">(</span>V<span class="token punctuation">:</span>Val<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">~&gt;</span> _ <span class="token operator">=&gt;</span> V <span class="token operator">~&gt;</span> K <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>control</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>fstack</span><span class="token punctuation">&gt;</span></span> ListItem<span class="token punctuation">(</span>fstackFrame<span class="token punctuation">(</span>Env<span class="token punctuation">,</span>K<span class="token punctuation">,</span>XS<span class="token punctuation">,</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>crntObj</span><span class="token punctuation">&gt;</span></span> CO <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>crntObj</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>List <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>fstack</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xstack</span><span class="token punctuation">&gt;</span></span> _ <span class="token operator">=&gt;</span> XS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xstack</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>crntObj</span><span class="token punctuation">&gt;</span></span> _ <span class="token operator">=&gt;</span> CO <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>crntObj</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>control</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env</span><span class="token punctuation">&gt;</span></span> _ <span class="token operator">=&gt;</span> Env <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">syntax</span> Val <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">"nothing"</span>
  <span class="token keyword">rule</span> return<span class="token punctuation">;</span> <span class="token operator">=&gt;</span> return nothing<span class="token punctuation">;</span>


  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> read<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> I <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span><span class="token punctuation">&gt;</span></span> ListItem<span class="token punctuation">(</span>I<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>List <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>input</span><span class="token punctuation">&gt;</span></span>  <span class="token punctuation">[</span>group<span class="token punctuation">(</span>read<span class="token punctuation">)</span><span class="token punctuation">]</span>


  <span class="token keyword">context</span> <span class="token punctuation">(</span>HOLE <span class="token operator">=&gt;</span> lvalue<span class="token punctuation">(</span>HOLE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> _

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> loc<span class="token punctuation">(</span>L<span class="token punctuation">)</span> <span class="token operator">=</span> V<span class="token punctuation">:</span>Val <span class="token operator">=&gt;</span> V <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>store</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> L <span class="token operator">|</span><span class="token operator">-</span>&gt; <span class="token punctuation">(</span>_ <span class="token operator">=&gt;</span> V<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>store</span><span class="token punctuation">&gt;</span></span>
    <span class="token punctuation">[</span>group<span class="token punctuation">(</span>assignment<span class="token punctuation">)</span><span class="token punctuation">]</span>


  <span class="token keyword">rule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span> S <span class="token punctuation">}</span> <span class="token operator">=&gt;</span> S <span class="token operator">~&gt;</span> setEnv<span class="token punctuation">(</span>Env<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env</span><span class="token punctuation">&gt;</span></span> Env <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env</span><span class="token punctuation">&gt;</span></span>


  <span class="token keyword">rule</span> S1<span class="token punctuation">:</span><span class="token punctuation">:</span>Stmt S2<span class="token punctuation">:</span><span class="token punctuation">:</span>Stmt <span class="token operator">=&gt;</span> S1 <span class="token operator">~&gt;</span> S2

  <span class="token keyword">rule</span> _<span class="token punctuation">:</span>Val<span class="token punctuation">;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K

  <span class="token keyword">rule</span> if <span class="token punctuation">(</span> <span class="token boolean">true</span><span class="token punctuation">)</span> S else _ <span class="token operator">=&gt;</span> S
  <span class="token keyword">rule</span> if <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> _ else S <span class="token operator">=&gt;</span> S

  <span class="token keyword">rule</span> while <span class="token punctuation">(</span>E<span class="token punctuation">)</span> S <span class="token operator">=&gt;</span> if <span class="token punctuation">(</span>E<span class="token punctuation">)</span> <span class="token punctuation">{</span>S while<span class="token punctuation">(</span>E<span class="token punctuation">)</span>S<span class="token punctuation">}</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> print<span class="token punctuation">(</span>V<span class="token punctuation">:</span>Val<span class="token punctuation">,</span> Es <span class="token operator">=&gt;</span> Es<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>output</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span>List <span class="token operator">=&gt;</span> ListItem<span class="token punctuation">(</span>V<span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>output</span><span class="token punctuation">&gt;</span></span>
    <span class="token punctuation">[</span>group<span class="token punctuation">(</span>print<span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token keyword">rule</span> print<span class="token punctuation">(</span><span class="token punctuation">.</span>Vals<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K


  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> xstackFrame<span class="token punctuation">(</span><span class="token keyword">Id</span><span class="token punctuation">,</span>Stmt<span class="token punctuation">,</span>K<span class="token punctuation">,</span>Map<span class="token punctuation">,</span>K<span class="token punctuation">)</span>
  <span class="token comment">// TODO(KORE): drop the additional production once parsing issue #1842 is fixed</span>
                 <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token keyword">Id</span><span class="token punctuation">,</span>Stmt<span class="token punctuation">,</span>K<span class="token punctuation">,</span>Map<span class="token punctuation">,</span>K<span class="token punctuation">)</span>

  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">"popx"</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span>try S1 catch<span class="token punctuation">(</span>X<span class="token punctuation">)</span> <span class="token punctuation">{</span>S2<span class="token punctuation">}</span> <span class="token operator">=&gt;</span> S1 <span class="token operator">~&gt;</span> popx<span class="token punctuation">)</span> <span class="token operator">~&gt;</span> K <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>control</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xstack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span>List <span class="token operator">=&gt;</span> ListItem<span class="token punctuation">(</span>xstackFrame<span class="token punctuation">(</span>X<span class="token punctuation">,</span> S2<span class="token punctuation">,</span> K<span class="token punctuation">,</span> Env<span class="token punctuation">,</span> C<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xstack</span><span class="token punctuation">&gt;</span></span>
         C
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>control</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env</span><span class="token punctuation">&gt;</span></span> Env <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> popx <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xstack</span><span class="token punctuation">&gt;</span></span> ListItem<span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>List <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xstack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> throw V<span class="token punctuation">:</span>Val<span class="token punctuation">;</span> <span class="token operator">~&gt;</span> _ <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> var X <span class="token operator">=</span> V<span class="token punctuation">;</span> S2 <span class="token punctuation">}</span> <span class="token operator">~&gt;</span> K <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>control</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xstack</span><span class="token punctuation">&gt;</span></span> ListItem<span class="token punctuation">(</span>xstackFrame<span class="token punctuation">(</span>X<span class="token punctuation">,</span> S2<span class="token punctuation">,</span> K<span class="token punctuation">,</span> Env<span class="token punctuation">,</span> C<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>List <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xstack</span><span class="token punctuation">&gt;</span></span>
         <span class="token punctuation">(</span>_ <span class="token operator">=&gt;</span> C<span class="token punctuation">)</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>control</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env</span><span class="token punctuation">&gt;</span></span> _ <span class="token operator">=&gt;</span> Env <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env</span><span class="token punctuation">&gt;</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Thread spawning needs a new semantics, because we want the child
thread to also share the object environment with its parent.  The new
semantics of thread spawning will be defined shortly.  However,
interestingly, the other concurrency constructs keep their semantics
from SIMPLE unchanged.</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token comment">// TODO(KORE): ..Bag should be . throughout this definition #1772</span>
  <span class="token keyword">rule</span> <span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>thread</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span>K<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>holds</span><span class="token punctuation">&gt;</span></span>H<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>holds</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>T<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>thread</span><span class="token punctuation">&gt;</span></span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>Bag<span class="token punctuation">)</span>
  <span class="token comment">/*
  rule (&lt;thread&gt;... &lt;k&gt;.&lt;/k&gt; &lt;holds&gt;H&lt;/holds&gt; &lt;id&gt;T&lt;/id&gt; ...&lt;/thread&gt; =&gt; .)
  */</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>busy</span><span class="token punctuation">&gt;</span></span> Busy <span class="token operator">=&gt;</span> Busy <span class="token operator">-</span>Set keys<span class="token punctuation">(</span>H<span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>busy</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>terminated</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span>Set <span class="token operator">=&gt;</span> SetItem<span class="token punctuation">(</span>T<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>terminated</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> join T<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>terminated</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> SetItem<span class="token punctuation">(</span>T<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>terminated</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> acquire V<span class="token punctuation">:</span>Val<span class="token punctuation">;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>holds</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span>Map <span class="token operator">=&gt;</span> V <span class="token operator">|</span><span class="token operator">-</span>&gt; <span class="token number">0</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>holds</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>busy</span><span class="token punctuation">&gt;</span></span> Busy <span class="token punctuation">(</span><span class="token punctuation">.</span>Set <span class="token operator">=&gt;</span> SetItem<span class="token punctuation">(</span>V<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>busy</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> <span class="token punctuation">(</span>notBool<span class="token punctuation">(</span>V in Busy<span class="token punctuation">:</span>Set<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">[</span>group<span class="token punctuation">(</span>acquire<span class="token punctuation">)</span><span class="token punctuation">]</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> acquire V<span class="token punctuation">;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>holds</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> V<span class="token punctuation">:</span>Val <span class="token operator">|</span><span class="token operator">-</span>&gt; <span class="token punctuation">(</span>N<span class="token punctuation">:</span><span class="token keyword">Int</span> <span class="token operator">=&gt;</span> N <span class="token operator">+</span><span class="token keyword">Int</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>holds</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> release V<span class="token punctuation">:</span>Val<span class="token punctuation">;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>holds</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> V <span class="token operator">|</span><span class="token operator">-</span>&gt; <span class="token punctuation">(</span>N <span class="token operator">=&gt;</span> N<span class="token punctuation">:</span><span class="token keyword">Int</span> <span class="token operator">-</span><span class="token keyword">Int</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>holds</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> N &gt;<span class="token keyword">Int</span> <span class="token number">0</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> release V<span class="token punctuation">;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>holds</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> V<span class="token punctuation">:</span>Val <span class="token operator">|</span><span class="token operator">-</span>&gt; <span class="token number">0</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>Map <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>holds</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>busy</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> SetItem<span class="token punctuation">(</span>V<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>Set <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>busy</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> rendezvous V<span class="token punctuation">:</span>Val<span class="token punctuation">;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> rendezvous V<span class="token punctuation">;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>  <span class="token punctuation">[</span>group<span class="token punctuation">(</span>rendezvous<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="unchanged-auxiliary-operations-from-untyped-simple">Unchanged auxiliary operations from untyped SIMPLE</h2>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> Stmt <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> mkDecls<span class="token punctuation">(</span>Ids<span class="token punctuation">,</span>Vals<span class="token punctuation">)</span>  <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
  <span class="token keyword">rule</span> mkDecls<span class="token punctuation">(</span><span class="token punctuation">(</span>X<span class="token punctuation">:</span><span class="token keyword">Id</span><span class="token punctuation">,</span> Xs<span class="token punctuation">:</span>Ids<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>V<span class="token punctuation">:</span>Val<span class="token punctuation">,</span> Vs<span class="token punctuation">:</span>Vals<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> var X<span class="token operator">=</span>V<span class="token punctuation">;</span> mkDecls<span class="token punctuation">(</span>Xs<span class="token punctuation">,</span>Vs<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> mkDecls<span class="token punctuation">(</span><span class="token punctuation">.</span>Ids<span class="token punctuation">,</span><span class="token punctuation">.</span>Vals<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment">// TODO(KORE): clarify sort inferences #1803</span>
  <span class="token keyword">syntax</span> Exp <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> lookup<span class="token punctuation">(</span><span class="token keyword">Int</span><span class="token punctuation">)</span>
  <span class="token comment">/*
  syntax KItem ::= lookup(Int)
  */</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> lookup<span class="token punctuation">(</span>L<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> V <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>store</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> L <span class="token operator">|</span><span class="token operator">-</span>&gt; V<span class="token punctuation">:</span>Val <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>store</span><span class="token punctuation">&gt;</span></span>  <span class="token punctuation">[</span>group<span class="token punctuation">(</span>lookup<span class="token punctuation">)</span><span class="token punctuation">]</span>

  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> setEnv<span class="token punctuation">(</span>Map<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> setEnv<span class="token punctuation">(</span>Env<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env</span><span class="token punctuation">&gt;</span></span> _ <span class="token operator">=&gt;</span> Env <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token punctuation">(</span>setEnv<span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K<span class="token punctuation">)</span> <span class="token operator">~&gt;</span> setEnv<span class="token punctuation">(</span>_<span class="token punctuation">)</span>
  <span class="token comment">// TODO: How can we make sure that the second rule above applies before the first one?</span>
  <span class="token comment">//       Probably we'll deal with this using strategies, eventually.</span>

  <span class="token keyword">syntax</span> Exp <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> lvalue<span class="token punctuation">(</span>K<span class="token punctuation">)</span>
  <span class="token keyword">syntax</span> Val <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> loc<span class="token punctuation">(</span><span class="token keyword">Int</span><span class="token punctuation">)</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> lvalue<span class="token punctuation">(</span>X<span class="token punctuation">:</span><span class="token keyword">Id</span> <span class="token operator">=&gt;</span> loc<span class="token punctuation">(</span>L<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> X <span class="token operator">|</span><span class="token operator">-</span>&gt; L<span class="token punctuation">:</span><span class="token keyword">Int</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">context</span> lvalue<span class="token punctuation">(</span>_<span class="token punctuation">:</span><span class="token punctuation">:</span>Exp<span class="token punctuation">[</span>HOLE<span class="token punctuation">:</span><span class="token punctuation">:</span>Exps<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">context</span> lvalue<span class="token punctuation">(</span>HOLE<span class="token punctuation">:</span><span class="token punctuation">:</span>Exp<span class="token punctuation">[</span>_<span class="token punctuation">:</span><span class="token punctuation">:</span>Exps<span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token keyword">rule</span> lvalue<span class="token punctuation">(</span>lookup<span class="token punctuation">(</span>L<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> loc<span class="token punctuation">(</span>L<span class="token punctuation">)</span><span class="token punctuation">)</span>


  <span class="token keyword">syntax</span> Map <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token keyword">Int</span> <span class="token string">"..."</span> <span class="token keyword">Int</span> <span class="token string">"|-&gt;"</span> K <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
  <span class="token keyword">rule</span> N<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>M <span class="token operator">|</span><span class="token operator">-</span>&gt; _ <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>Map  <span class="token keyword">requires</span> N &gt;<span class="token keyword">Int</span> M
  <span class="token keyword">rule</span> N<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>M <span class="token operator">|</span><span class="token operator">-</span>&gt; K <span class="token operator">=&gt;</span> N <span class="token operator">|</span><span class="token operator">-</span>&gt; K <span class="token punctuation">(</span>N <span class="token operator">+</span><span class="token keyword">Int</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>M <span class="token operator">|</span><span class="token operator">-</span>&gt; K  <span class="token keyword">requires</span> N <span class="token operator">&lt;=</span><span class="token keyword">Int</span> M
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="changes-to-the-existing-untyped-simple-semantics">Changes to the existing untyped SIMPLE semantics</h2>
<p>When we extend a language, sometimes we need to do more than just add
new language constructs and semantics for them.  Sometimes we want to
also extend the semantics of existing language constructs, in order to
get more from them.</p>
<h2 id="program-initialization">Program initialization</h2>
<p>In SIMPLE, once all the global declarations were processed, the
function <code>main()</code> was invoked.  In KOOL, the global
declarations are classes, and their specific semantics is given
shortly; essentially, they are pre-processed one by one and added
into the <code>class</code> cell structure in the configuration.
Once all the classes are processed, the computation item
<code>execute</code>, which was placed right after the program in the
initial configuration, is reached.  In SIMPLE, the program was
initialized by calling the method <code>main()</code>.  In KOOL, the
program is initialized by creating an object instance of class
<code>Main</code>.  This will also implicitly call the method
<code>Main()</code> (the <code>Main</code> class constructor).  The emptiness
of the <code>env</code> cell below is just a sanity check, to make sure
that the user has not declared anything but classes at the top level
of the program.</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">"execute"</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> execute <span class="token operator">=&gt;</span> new Main<span class="token punctuation">(</span><span class="token punctuation">.</span>Exps<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span>Map <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env</span><span class="token punctuation">&gt;</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>The semantics of <code>new</code> (defined below) requires the
execution of all the class' declarations (and also of its
superclasses').</p>
<h2 id="object-and-method-closures">Object and method closures</h2>
<p>Before we can define the semantics of method application (previously
called function application in SIMPLE), we need to add two more values
to the language, namely object and method closures:</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> Val <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> objectClosure<span class="token punctuation">(</span><span class="token keyword">Id</span><span class="token punctuation">,</span> List<span class="token punctuation">)</span>
               <span class="token operator">|</span> methodClosure<span class="token punctuation">(</span><span class="token keyword">Id</span><span class="token punctuation">,</span><span class="token keyword">Int</span><span class="token punctuation">,</span>Ids<span class="token punctuation">,</span>Stmt<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>An object value consists of an <code>objectClosure</code>-wrapped bag
containing the current class of the object and the environment stack
of the object.  The current class of an object will always be one of
the classes mapped to an environment in the environment stack of the
object.  A method closure encapsulates the method's parameters and
code (last two arguments), as well as the object context in which the
method code should execute.  This object context includes the current
class of the object (the first argument of <code>methodClosure</code>) and
the object environment stack (located in the object stored at the
location specified as the second argument of <code>methodClosure</code>).</p>
<h2 id="method-application">Method application</h2>
<p>KOOL has a complex mechanism to invoke methods, because it allows both
dynamic method dispatch and methods as first-class-citizen values (the
latter making it a higher-order language).  The invocation mechanism
will be defined later.  What is sufficient to know for now is that
the two arguments of the application construct eventually reduce to
values, the first being a method closure and the latter a list of
values.  The semantics of the method closure application is then as
expected: the local environment and control are stacked, then we
switch to method closure's class and object environment and execute
the method body.  The <code>mkDecls</code> construct is the one that came
with the unchanged semantics of SIMPLE above.</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> fstackFrame<span class="token punctuation">(</span>Map<span class="token punctuation">,</span>K<span class="token punctuation">,</span>List<span class="token punctuation">,</span>K<span class="token punctuation">)</span>
  <span class="token comment">// TODO(KORE): drop the additional production once parsing issue #1842 is fixed</span>
                 <span class="token operator">|</span> <span class="token punctuation">(</span>Map<span class="token punctuation">,</span>K<span class="token punctuation">,</span>K<span class="token punctuation">)</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> methodClosure<span class="token punctuation">(</span>Class<span class="token punctuation">,</span>OL<span class="token punctuation">,</span>Xs<span class="token punctuation">,</span>S<span class="token punctuation">)</span><span class="token punctuation">(</span>Vs<span class="token punctuation">:</span>Vals<span class="token punctuation">)</span> <span class="token operator">~&gt;</span> K
           <span class="token operator">=&gt;</span> mkDecls<span class="token punctuation">(</span>Xs<span class="token punctuation">,</span>Vs<span class="token punctuation">)</span> S return<span class="token punctuation">;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env</span><span class="token punctuation">&gt;</span></span> Env <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>Map <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>store</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> OL <span class="token operator">|</span><span class="token operator">-</span>&gt; objectClosure<span class="token punctuation">(</span>_<span class="token punctuation">,</span> EnvStack<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>store</span><span class="token punctuation">&gt;</span></span>
     <span class="token comment">//&lt;br/&gt; // TODO(KORE): support latex annotations #1799</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>control</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xstack</span><span class="token punctuation">&gt;</span></span> XS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xstack</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>fstack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span>List <span class="token operator">=&gt;</span> ListItem<span class="token punctuation">(</span>fstackFrame<span class="token punctuation">(</span>Env<span class="token punctuation">,</span> K<span class="token punctuation">,</span> XS<span class="token punctuation">,</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>crntObj</span><span class="token punctuation">&gt;</span></span> Obj' <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>crntObj</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>fstack</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>crntObj</span><span class="token punctuation">&gt;</span></span> Obj' <span class="token operator">=&gt;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>crntClass</span><span class="token punctuation">&gt;</span></span> Class <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>crntClass</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>envStack</span><span class="token punctuation">&gt;</span></span> EnvStack <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>envStack</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>crntObj</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>control</span><span class="token punctuation">&gt;</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="spawn">Spawn</h2>
<p>We want to extend the semantics of <code>spawn</code> to also share the
current object environment with the child thread, in addition to the
current environment.  This extension will allow us to also use method
invocations in the spawned statements, which will be thus looked up as
expected, using dynamic method dispatch.  This lookup operation would
fail if the child thread did not have access to its parent's object
environment.</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>thread</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> spawn S <span class="token operator">=&gt;</span> <span class="token operator">!</span>T<span class="token punctuation">:</span><span class="token keyword">Int</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env</span><span class="token punctuation">&gt;</span></span> Env <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>crntObj</span><span class="token punctuation">&gt;</span></span> Obj <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>crntObj</span><span class="token punctuation">&gt;</span></span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>thread</span><span class="token punctuation">&gt;</span></span>
       <span class="token punctuation">(</span><span class="token punctuation">.</span>Bag <span class="token operator">=&gt;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>thread</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> S <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env</span><span class="token punctuation">&gt;</span></span> Env <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env</span><span class="token punctuation">&gt;</span></span>
               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span> <span class="token operator">!</span>T <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>crntObj</span><span class="token punctuation">&gt;</span></span> Obj <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>crntObj</span><span class="token punctuation">&gt;</span></span>
             <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>thread</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="semantics-of-the-new-kool-constructs">Semantics of the new KOOL constructs</h2>
<h2 id="class-declaration">Class declaration</h2>
<p>Initially, the classes forming the program are moved into their
corresponding cells:</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> class Class1 extends Class2 <span class="token punctuation">{</span> S <span class="token punctuation">}</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>classes</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">(</span><span class="token punctuation">.</span>Bag <span class="token operator">=&gt;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>classData</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>className</span><span class="token punctuation">&gt;</span></span> Class1 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>className</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>baseClass</span><span class="token punctuation">&gt;</span></span> Class2 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>baseClass</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>declarations</span><span class="token punctuation">&gt;</span></span> S <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>declarations</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>classData</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>classes</span><span class="token punctuation">&gt;</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="method-declaration">Method declaration</h2>
<p>Like in SIMPLE, method names are added to the environment and bound
to their code.  However, unlike in SIMPLE where each function was
executed in the same environment, namely the program global
environment, a method in KOOL needs to be executed into its object's
environment.  Thus, methods evaluate to closures, which encapsulate
their object's context (i.e., the current class and environment stack
of the object) in addition to method's parameters and body.  This
approach to bind method names to method closures in the environment
will also allow objects to pass their methods to other objects, to
dynamically change their methods by assigning them other method
closures, and even to allow all these to be done from other objects.
This gives the KOOL programmer a lot of power; one should use this
power wisely, though, because programs can become easily hard to
understand and reason about if one overuses these features.</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> method F<span class="token punctuation">:</span><span class="token keyword">Id</span><span class="token punctuation">(</span>Xs<span class="token punctuation">:</span>Ids<span class="token punctuation">)</span> S <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>crntClass</span><span class="token punctuation">&gt;</span></span> Class<span class="token punctuation">:</span><span class="token keyword">Id</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>crntClass</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">&gt;</span></span> OL<span class="token punctuation">:</span><span class="token keyword">Int</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env</span><span class="token punctuation">&gt;</span></span> Env <span class="token operator">=&gt;</span> Env<span class="token punctuation">[</span>F &lt;<span class="token operator">-</span> L<span class="token punctuation">]</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>store</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span>Map <span class="token operator">=&gt;</span> L <span class="token operator">|</span><span class="token operator">-</span>&gt; methodClosure<span class="token punctuation">(</span>Class<span class="token punctuation">,</span>OL<span class="token punctuation">,</span>Xs<span class="token punctuation">,</span>S<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>store</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nextLoc</span><span class="token punctuation">&gt;</span></span> L <span class="token operator">=&gt;</span> L <span class="token operator">+</span><span class="token keyword">Int</span> <span class="token number">1</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nextLoc</span><span class="token punctuation">&gt;</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="new">New</h2>
<p>The semantics of <code>new</code> consists of two actions: memory
allocation for the new object and execution of the corresponding
constructor.  Then the created object is returned as the result of the
<code>new</code> operation; the value returned by the constructor, if any,
is discarded.  The current environment and object are stored onto the
stack and recovered after new (according to the semantics of
<code>return</code> borrowed from SIMPLE, when the statement
<code>return this;</code> in the rule below is reached and evaluated),
because the object creation part of <code>new</code> will destroy them.
The rule below also initializes the object creation process by
emptying the local environment and the current object, and allocating
a location in the store where the created object will be eventually
stored (this is what the <code>storeObj</code> task after the object
creation task in the rule below will do—its rule is defined
shortly).  The location where the object will be stored is also made
available in the <code>crntObj</code> cell, so that method closures can
refer to it (see rule above).</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">"envStackFrame"</span> <span class="token string">"("</span> <span class="token keyword">Id</span> <span class="token string">","</span> Map <span class="token string">")"</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> new Class<span class="token punctuation">:</span><span class="token keyword">Id</span><span class="token punctuation">(</span>Vs<span class="token punctuation">:</span>Vals<span class="token punctuation">)</span> <span class="token operator">~&gt;</span> K
           <span class="token operator">=&gt;</span> create<span class="token punctuation">(</span>Class<span class="token punctuation">)</span> <span class="token operator">~&gt;</span> storeObj <span class="token operator">~&gt;</span> Class<span class="token punctuation">(</span>Vs<span class="token punctuation">)</span><span class="token punctuation">;</span> return this<span class="token punctuation">;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env</span><span class="token punctuation">&gt;</span></span> Env <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>Map <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nextLoc</span><span class="token punctuation">&gt;</span></span> L<span class="token punctuation">:</span><span class="token keyword">Int</span> <span class="token operator">=&gt;</span> L <span class="token operator">+</span><span class="token keyword">Int</span> <span class="token number">1</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nextLoc</span><span class="token punctuation">&gt;</span></span>
     <span class="token comment">//&lt;br/&gt; // TODO(KORE): support latex annotations #1799</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>control</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xstack</span><span class="token punctuation">&gt;</span></span> XS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xstack</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>crntObj</span><span class="token punctuation">&gt;</span></span> Obj
                   <span class="token operator">=&gt;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>crntClass</span><span class="token punctuation">&gt;</span></span> Object <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>crntClass</span><span class="token punctuation">&gt;</span></span>
                      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>envStack</span><span class="token punctuation">&gt;</span></span> ListItem<span class="token punctuation">(</span>envStackFrame<span class="token punctuation">(</span>Object<span class="token punctuation">,</span> <span class="token punctuation">.</span>Map<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>envStack</span><span class="token punctuation">&gt;</span></span>
                      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">&gt;</span></span> L <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>crntObj</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>fstack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span>List <span class="token operator">=&gt;</span> ListItem<span class="token punctuation">(</span>fstackFrame<span class="token punctuation">(</span>Env<span class="token punctuation">,</span> K<span class="token punctuation">,</span> XS<span class="token punctuation">,</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>crntObj</span><span class="token punctuation">&gt;</span></span> Obj <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>crntObj</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>fstack</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>control</span><span class="token punctuation">&gt;</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>The creation of a new object (the memory allocation part only) is
a recursive process, requiring to first create an object for the
superclass.  A memory object representation is a layered structure:
for each class on the path from the instance class to the root of the
hierarchy there is a layer including the memory allocated for the
members (both fields and methods) of that class.</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> create<span class="token punctuation">(</span><span class="token keyword">Id</span><span class="token punctuation">)</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> create<span class="token punctuation">(</span>Class<span class="token punctuation">:</span><span class="token keyword">Id</span><span class="token punctuation">)</span>
           <span class="token operator">=&gt;</span> create<span class="token punctuation">(</span>Class1<span class="token punctuation">)</span> <span class="token operator">~&gt;</span> setCrntClass<span class="token punctuation">(</span>Class<span class="token punctuation">)</span> <span class="token operator">~&gt;</span> S <span class="token operator">~&gt;</span> addEnvLayer <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>className</span><span class="token punctuation">&gt;</span></span> Class <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>className</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>baseClass</span><span class="token punctuation">&gt;</span></span> Class1<span class="token punctuation">:</span><span class="token keyword">Id</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>baseClass</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>declarations</span><span class="token punctuation">&gt;</span></span> S <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>declarations</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> create<span class="token punctuation">(</span>Object<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>The next operation sets the current class of the current object.
This is necessary to be done at each layer, because the current class
of the object is enclosed as part of the method closures (see the
semantics of method declarations above).</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> setCrntClass<span class="token punctuation">(</span><span class="token keyword">Id</span><span class="token punctuation">)</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> setCrntClass<span class="token punctuation">(</span>C<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>crntClass</span><span class="token punctuation">&gt;</span></span> _ <span class="token operator">=&gt;</span> C <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>crntClass</span><span class="token punctuation">&gt;</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>The next operation adds a new tagged environment layer to the
current object and gets ready for the next layer by clearing the
environment (note that <code>create</code> expects the environment to be
empty).</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">"addEnvLayer"</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> addEnvLayer <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env</span><span class="token punctuation">&gt;</span></span> Env <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>Map <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>crntClass</span><span class="token punctuation">&gt;</span></span> Class<span class="token punctuation">:</span><span class="token keyword">Id</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>crntClass</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>envStack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span>List <span class="token operator">=&gt;</span> ListItem<span class="token punctuation">(</span>envStackFrame<span class="token punctuation">(</span>Class<span class="token punctuation">,</span> Env<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>envStack</span><span class="token punctuation">&gt;</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>The following operation stores the created object at the location
reserved by <code>new</code>.  Note that the location reserved by
<code>new</code> was temporarily stored in the <code>crntObj</code> cell
precisely for this purpose.  Now that the newly created object is
stored at its location and that all method closures are aware of it,
the location is unnecessary and thus we delete it from the
<code>crntObj</code> cell.</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">"storeObj"</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> storeObj <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>crntObj</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>crntClass</span><span class="token punctuation">&gt;</span></span> CC <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>crntClass</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>envStack</span><span class="token punctuation">&gt;</span></span> ES <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>envStack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">&gt;</span></span> L<span class="token punctuation">:</span><span class="token keyword">Int</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">&gt;</span></span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>Bag<span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>crntObj</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>store</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span>Map <span class="token operator">=&gt;</span> L <span class="token operator">|</span><span class="token operator">-</span>&gt; objectClosure<span class="token punctuation">(</span>CC<span class="token punctuation">,</span> ES<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>store</span><span class="token punctuation">&gt;</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="self-reference">Self reference</h2>
<p>The semantics of <code>this</code> is straightforward: evaluate to the
current object.</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> this <span class="token operator">=&gt;</span> objectClosure<span class="token punctuation">(</span>CC<span class="token punctuation">,</span> ES<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>crntObj</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>crntClass</span><span class="token punctuation">&gt;</span></span> CC <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>crntClass</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>envStack</span><span class="token punctuation">&gt;</span></span> ES <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>envStack</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>crntObj</span><span class="token punctuation">&gt;</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="object-member-access">Object member access</h2>
<p>We can access an object member (field or method) either explicitly,
using the construct <code>e.x</code>, or implicitly, using only the member
name <code>x</code> directly.  The borrowed semantics of SIMPLE will
already lookup a sole name in the local environment.  The first rule
below reduces implicit member access to explicit access when the name
cannot be found in the local environment.  There are two cases to
analyze for explicit object member access, depending upon whether the
object is a proper object or it is just a redirection to the parent
class via the construct <code>super</code>.  In the first case, we
evaluate the object expression and lookup the member starting with the
current class (static scoping).  Note the use of the conditional
evaluation context.  In the second case, we just lookup the member
starting with the superclass of the current class.  In both cases,
the <code>lookupMember</code> task eventually yields a <code>lookup(L)</code>
task for some appropriate location <code>L</code>, which will be further
solved with the corresponding rule borrowed from SIMPLE.  Note that the
current object is not altered by <code>super</code>, so future method
invocations see the entire object, as needed for dynamic method dispatch.</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> X<span class="token punctuation">:</span><span class="token keyword">Id</span> <span class="token operator">=&gt;</span> this <span class="token punctuation">.</span> X <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env</span><span class="token punctuation">&gt;</span></span> Env<span class="token punctuation">:</span>Map <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> notBool<span class="token punctuation">(</span>X in keys<span class="token punctuation">(</span>Env<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">context</span> HOLE<span class="token punctuation">.</span>_<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">Id</span> <span class="token keyword">requires</span> <span class="token punctuation">(</span>HOLE <span class="token operator">=</span><span class="token operator">/</span><span class="token operator">=</span>K super<span class="token punctuation">)</span>

<span class="token comment">// TODO: explain how Assoc matching has been replaced with two rules here.</span>
<span class="token comment">// Maybe also improve it a bit.</span>

<span class="token comment">/*  rule objectClosure(&lt;crntClass&gt; Class:Id &lt;/crntClass&gt;
                     &lt;envStack&gt;... envStackFrame(Class,EnvC) EStack &lt;/envStack&gt;)
       . X:Id
    =&gt; lookupMember(envStackFrame(Class,EnvC) EStack, X) */</span>

  <span class="token keyword">rule</span> objectClosure<span class="token punctuation">(</span>Class<span class="token punctuation">:</span><span class="token keyword">Id</span><span class="token punctuation">,</span> ListItem<span class="token punctuation">(</span>envStackFrame<span class="token punctuation">(</span>Class<span class="token punctuation">,</span>Env<span class="token punctuation">)</span><span class="token punctuation">)</span> EStack<span class="token punctuation">)</span>
       <span class="token punctuation">.</span> X<span class="token punctuation">:</span><span class="token keyword">Id</span>
    <span class="token operator">=&gt;</span> lookupMember<span class="token punctuation">(</span>ListItem<span class="token punctuation">(</span>envStackFrame<span class="token punctuation">(</span>Class<span class="token punctuation">,</span>Env<span class="token punctuation">)</span><span class="token punctuation">)</span> EStack<span class="token punctuation">,</span> X<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> objectClosure<span class="token punctuation">(</span>Class<span class="token punctuation">:</span><span class="token keyword">Id</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>ListItem<span class="token punctuation">(</span>envStackFrame<span class="token punctuation">(</span>Class'<span class="token punctuation">:</span><span class="token keyword">Id</span><span class="token punctuation">,</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>List<span class="token punctuation">)</span> _<span class="token punctuation">)</span>
       <span class="token punctuation">.</span> _X<span class="token punctuation">:</span><span class="token keyword">Id</span>
    <span class="token keyword">requires</span> Class <span class="token operator">=</span><span class="token operator">/</span><span class="token operator">=</span>K Class'

<span class="token comment">/*  rule &lt;k&gt; super . X =&gt; lookupMember(EStack, X) ...&lt;/k&gt;
       &lt;crntClass&gt; Class &lt;/crntClass&gt;
       &lt;envStack&gt;... envStackFrame(Class,EnvC) EStack &lt;/envStack&gt; */</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> super <span class="token punctuation">.</span> X <span class="token operator">=&gt;</span> lookupMember<span class="token punctuation">(</span>EStack<span class="token punctuation">,</span> X<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>crntClass</span><span class="token punctuation">&gt;</span></span> Class<span class="token punctuation">:</span><span class="token keyword">Id</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>crntClass</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>envStack</span><span class="token punctuation">&gt;</span></span> ListItem<span class="token punctuation">(</span>envStackFrame<span class="token punctuation">(</span>Class<span class="token punctuation">,</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span> EStack <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>envStack</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> super <span class="token punctuation">.</span> _X <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>crntClass</span><span class="token punctuation">&gt;</span></span> Class <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>crntClass</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>envStack</span><span class="token punctuation">&gt;</span></span> ListItem<span class="token punctuation">(</span>envStackFrame<span class="token punctuation">(</span>Class'<span class="token punctuation">:</span><span class="token keyword">Id</span><span class="token punctuation">,</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>List <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>envStack</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> Class <span class="token operator">=</span><span class="token operator">/</span><span class="token operator">=</span>K Class'
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="method-invocation">Method invocation</h2>
<p>Unlike in SIMPLE, in KOOL application was declared strict only in its
second argument.  That is because we want to ensure dynamic method
dispatch when the first argument is a method access.  As a
consequence, we need to consider all the cases of interest for the
first argument and to explicitly say what to do in each case.  In all
cases except for method access in a proper object (i.e., not
<code>super</code>), we want the same behavior for the first argument as
if it was not in a method invocation position.  When it is a member
access (the third rule below), we look it up starting with the
instance class of the corresponding object.  This ensures dynamic
dispatch for methods; it actually dynamically dispatches field
accesses, too, which is correct in KOOL, because one can assign method
closures to fields and the field appeared in a method invocation
context.  The last context declaration below says that method
applications or array accesses are also allowed as first argument to
applications; that is because methods are allowed to return methods
and arrays are allowed to hold methods in KOOL, since it is
higher-order.  If that is the case, then we want to evaluate the
method call or the array access.</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span>X<span class="token punctuation">:</span><span class="token keyword">Id</span> <span class="token operator">=&gt;</span> V<span class="token punctuation">)</span><span class="token punctuation">(</span>_<span class="token punctuation">:</span>Exps<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> X <span class="token operator">|</span><span class="token operator">-</span>&gt; L <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>store</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> L <span class="token operator">|</span><span class="token operator">-</span>&gt; V<span class="token punctuation">:</span>Val <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>store</span><span class="token punctuation">&gt;</span></span>  <span class="token punctuation">[</span>group<span class="token punctuation">(</span>lookup<span class="token punctuation">)</span><span class="token punctuation">]</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span>X<span class="token punctuation">:</span><span class="token keyword">Id</span> <span class="token operator">=&gt;</span> this <span class="token punctuation">.</span> X<span class="token punctuation">)</span><span class="token punctuation">(</span>_<span class="token punctuation">:</span>Exps<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env</span><span class="token punctuation">&gt;</span></span> Env <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> notBool<span class="token punctuation">(</span>X in keys<span class="token punctuation">(</span>Env<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">context</span> HOLE<span class="token punctuation">.</span>_<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">Id</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token keyword">requires</span> HOLE <span class="token operator">=</span><span class="token operator">/</span><span class="token operator">=</span>K super

  <span class="token keyword">rule</span> <span class="token punctuation">(</span>objectClosure<span class="token punctuation">(</span>_<span class="token punctuation">,</span> EStack<span class="token punctuation">)</span> <span class="token punctuation">.</span> X
    <span class="token operator">=&gt;</span> lookupMember<span class="token punctuation">(</span>EStack<span class="token punctuation">,</span> X<span class="token punctuation">:</span><span class="token keyword">Id</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_<span class="token punctuation">:</span>Exps<span class="token punctuation">)</span>

<span class="token comment">/*  rule &lt;k&gt; (super . X
            =&gt; lookupMember(EStack,X))(_:Exps)...&lt;/k&gt;
       &lt;crntClass&gt; Class &lt;/crntClass&gt;
       &lt;envStack&gt;... envStackFrame(Class,_) EStack &lt;/envStack&gt; */</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span>super <span class="token punctuation">.</span> X
            <span class="token operator">=&gt;</span> lookupMember<span class="token punctuation">(</span>EStack<span class="token punctuation">,</span>X<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_<span class="token punctuation">:</span>Exps<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>crntClass</span><span class="token punctuation">&gt;</span></span> Class <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>crntClass</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>envStack</span><span class="token punctuation">&gt;</span></span> ListItem<span class="token punctuation">(</span>envStackFrame<span class="token punctuation">(</span>Class<span class="token punctuation">,</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span> EStack <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>envStack</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span>super <span class="token punctuation">.</span> _X<span class="token punctuation">)</span><span class="token punctuation">(</span>_<span class="token punctuation">:</span>Exps<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>crntClass</span><span class="token punctuation">&gt;</span></span> Class <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>crntClass</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>envStack</span><span class="token punctuation">&gt;</span></span> ListItem<span class="token punctuation">(</span>envStackFrame<span class="token punctuation">(</span>Class'<span class="token punctuation">:</span><span class="token keyword">Id</span><span class="token punctuation">,</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>List <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>envStack</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> Class <span class="token operator">=</span><span class="token operator">/</span><span class="token operator">=</span>K Class'

  <span class="token comment">// TODO(KORE): fix getKLabel #1801</span>
  <span class="token keyword">rule</span> <span class="token punctuation">(</span>A<span class="token punctuation">:</span>Exp<span class="token punctuation">(</span>B<span class="token punctuation">:</span>Exps<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>C<span class="token punctuation">:</span>Exps<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> A<span class="token punctuation">(</span>B<span class="token punctuation">)</span> <span class="token operator">~&gt;</span> #freezerFunCall<span class="token punctuation">(</span>C<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> <span class="token punctuation">(</span>A<span class="token punctuation">:</span>Exp<span class="token punctuation">[</span>B<span class="token punctuation">:</span>Exps<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>C<span class="token punctuation">:</span>Exps<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> A<span class="token punctuation">[</span>B<span class="token punctuation">]</span> <span class="token operator">~&gt;</span> #freezerFunCall<span class="token punctuation">(</span>C<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> V<span class="token punctuation">:</span>Val <span class="token operator">~&gt;</span> #freezerFunCall<span class="token punctuation">(</span>C<span class="token punctuation">:</span>Exps<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> V<span class="token punctuation">(</span>C<span class="token punctuation">)</span>
  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">"#freezerFunCall"</span> <span class="token string">"("</span> K <span class="token string">")"</span>
  <span class="token comment">/*
  context HOLE(_:Exps)
    requires getKLabel(HOLE) ==K #klabel(`_(_)`) orBool getKLabel(HOLE) ==K #klabel(`_[_]`)
  */</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Eventually, each of the rules above produces a <code>lookup(L)</code>
task as a replacement for the method.  When that happens, we just
lookup the value at location <code>L</code>:</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span>lookup<span class="token punctuation">(</span>L<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> V<span class="token punctuation">)</span><span class="token punctuation">(</span>_<span class="token punctuation">:</span>Exps<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>store</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> L <span class="token operator">|</span><span class="token operator">-</span>&gt; V<span class="token punctuation">:</span>Val <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>store</span><span class="token punctuation">&gt;</span></span>
    <span class="token punctuation">[</span>group<span class="token punctuation">(</span>lookup<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>The value <code>V</code> looked up above is expected to be a method closure,
in which case the semantics of method application given above will
apply.  Otherwise, the execution will get stuck.</p>
<h2 id="instance-of">Instance Of</h2>
<p>It searches the object environment for a layer corresponding to the
desired class.  It returns <code>true</code> iff it can find the class,
otherwise it returns <code>false</code>; it only gets stuck when its first
argument does not evaluate to an object.</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">rule</span> objectClosure<span class="token punctuation">(</span>_<span class="token punctuation">,</span> ListItem<span class="token punctuation">(</span>envStackFrame<span class="token punctuation">(</span>C<span class="token punctuation">,</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span> _<span class="token punctuation">)</span>
       instanceOf C <span class="token operator">=&gt;</span> <span class="token boolean">true</span>

  <span class="token keyword">rule</span> objectClosure<span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token punctuation">(</span>ListItem<span class="token punctuation">(</span>envStackFrame<span class="token punctuation">(</span>C<span class="token punctuation">,</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>List<span class="token punctuation">)</span> _<span class="token punctuation">)</span>
       instanceOf C<span class="token string">'  requires C =/=K C'</span>
<span class="token comment">//TODO: remove the sort cast ::Id of C above, when sort inference bug fixed</span>

  <span class="token keyword">rule</span> objectClosure<span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token punctuation">.</span>List<span class="token punctuation">)</span> instanceOf _ <span class="token operator">=&gt;</span> <span class="token boolean">false</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="cast">Cast</h2>
<p>In untyped KOOL, we prefer to not check the validity of casting.  In
other words, any cast is allowed on any object, simply changing the
current class of the object to the desired class.  The execution will
get stuck later if one attempts to access a field which is not
available.  Moreover, the execution may complete successfully even
in the presence of invalid casts, provided that each accessed member
during the current execution is, or happens to be, available.</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">rule</span> <span class="token punctuation">(</span>C<span class="token punctuation">)</span> objectClosure<span class="token punctuation">(</span>_ <span class="token punctuation">,</span> EnvStack<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> objectClosure<span class="token punctuation">(</span>C <span class="token punctuation">,</span>EnvStack<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="kool-specific-auxiliary-declarations-and-operations">KOOL-specific auxiliary declarations and operations</h2>
<p>Here we define all the auxiliary constructs used in the above
KOOL-specific semantics (those used in the SIMPLE fragment
have already been defined in a corresponding section above).</p>
<h2 id="objects-as-lvalues">Objects as lvalues</h2>
<p>The current machinery borrowed with the semantics of SIMPLE allows us
to enrich the set of lvalues, this way allowing new means to assign
values to locations.  In KOOL, we want object member names to be
lvalues, so that we can assign values to them using the already
existing machinery.  The first rule below ensures that the object is
always explicit, the evaluation context enforces the object to be
evaluated, and finally the second rule initiates the lookup for the
member's location based on the current class of the object.</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> lvalue<span class="token punctuation">(</span>X<span class="token punctuation">:</span><span class="token keyword">Id</span> <span class="token operator">=&gt;</span> this <span class="token punctuation">.</span> X<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env</span><span class="token punctuation">&gt;</span></span> Env <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> notBool<span class="token punctuation">(</span>X in keys<span class="token punctuation">(</span>Env<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">context</span> lvalue<span class="token punctuation">(</span><span class="token punctuation">(</span>HOLE <span class="token punctuation">.</span> _<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">:</span>Exp<span class="token punctuation">)</span>

<span class="token comment">/*  rule lvalue(objectClosure(&lt;crntClass&gt; C &lt;/crntClass&gt;
                            &lt;envStack&gt;... envStackFrame(C,EnvC) EStack &lt;/envStack&gt;)
              . X
              =&gt; lookupMember(&lt;envStack&gt; envStackFrame(C,EnvC) EStack &lt;/envStack&gt;,
                              X))  */</span>
  <span class="token keyword">rule</span> lvalue<span class="token punctuation">(</span>objectClosure<span class="token punctuation">(</span>Class<span class="token punctuation">,</span> ListItem<span class="token punctuation">(</span>envStackFrame<span class="token punctuation">(</span>Class<span class="token punctuation">,</span>Env<span class="token punctuation">)</span><span class="token punctuation">)</span> EStack<span class="token punctuation">)</span>
              <span class="token punctuation">.</span> X
              <span class="token operator">=&gt;</span> lookupMember<span class="token punctuation">(</span>ListItem<span class="token punctuation">(</span>envStackFrame<span class="token punctuation">(</span>Class<span class="token punctuation">,</span>Env<span class="token punctuation">)</span><span class="token punctuation">)</span> EStack<span class="token punctuation">,</span>
                              X<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">rule</span> lvalue<span class="token punctuation">(</span>objectClosure<span class="token punctuation">(</span>Class<span class="token punctuation">,</span> <span class="token punctuation">(</span>ListItem<span class="token punctuation">(</span>envStackFrame<span class="token punctuation">(</span>Class'<span class="token punctuation">:</span><span class="token keyword">Id</span><span class="token punctuation">,</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>List<span class="token punctuation">)</span> _<span class="token punctuation">)</span>
              <span class="token punctuation">.</span> _X<span class="token punctuation">)</span>
    <span class="token keyword">requires</span> Class <span class="token operator">=</span><span class="token operator">/</span><span class="token operator">=</span>K Class'
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="lookup-member">Lookup member</h2>
<p>It searches for the given member in the given environment stack,
starting with the most concrete class and going up in the hierarchy.</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token comment">// TODO(KORE): clarify sort inferences #1803</span>
  <span class="token keyword">syntax</span> Exp <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> lookupMember<span class="token punctuation">(</span>List<span class="token punctuation">,</span> <span class="token keyword">Id</span><span class="token punctuation">)</span>  <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
  <span class="token comment">/*
  syntax KItem ::= lookupMember(EnvStackCell,Id)  [function]
  */</span>

<span class="token comment">//  rule lookupMember(&lt;envStack&gt; envStackFrame(_, &lt;env&gt;... X|-&gt;L ...&lt;/env&gt;) ...&lt;/envStack&gt;, X)</span>
<span class="token comment">//    =&gt; lookup(L)</span>
  <span class="token keyword">rule</span> lookupMember<span class="token punctuation">(</span>ListItem<span class="token punctuation">(</span>envStackFrame<span class="token punctuation">(</span>_<span class="token punctuation">,</span> X<span class="token operator">|</span><span class="token operator">-</span>&gt;L _<span class="token punctuation">)</span><span class="token punctuation">)</span> _<span class="token punctuation">,</span> X<span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> lookup<span class="token punctuation">(</span>L<span class="token punctuation">)</span>

<span class="token comment">//  rule lookupMember(&lt;envStack&gt; envStackFrame(_, &lt;env&gt; Env &lt;/env&gt;) =&gt; .List ...&lt;/envStack&gt;, X)</span>
<span class="token comment">//    requires notBool(X in keys(Env))</span>
  <span class="token keyword">rule</span> lookupMember<span class="token punctuation">(</span>ListItem<span class="token punctuation">(</span>envStackFrame<span class="token punctuation">(</span>_<span class="token punctuation">,</span> Env<span class="token punctuation">)</span><span class="token punctuation">)</span> Rest<span class="token punctuation">,</span> X<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
       lookupMember<span class="token punctuation">(</span>Rest<span class="token punctuation">,</span> X<span class="token punctuation">)</span>
    <span class="token keyword">requires</span> notBool<span class="token punctuation">(</span>X in keys<span class="token punctuation">(</span>Env<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">//TODO: beautify the above</span>

<span class="token keyword">endmodule</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Go to <a href="../../2_typed/1_dynamic/kool-typed-dynamic/">Lesson 2, KOOL typed dynamic</a>.</p>
</body></html></div>
        </main>

        <!-- Page ToC -->
        <div class="col-12 col-md-3 col-xl-2 py-md-3 bd-sidebar page-toc mb-3">
          
<div>
<details style="padding:0.25rem 0;;padding-left: 0px;">
            <summary class="bd-toc-link-wrapper">
              <a href="#kool-%E2%80%94-untyped" class="bd-toc-link">KOOL — Untyped</a>
              </summary>
            <div>
              <div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#abstract"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Abstract
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#syntax"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Syntax
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#semantics"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Semantics
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#configuration"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Configuration
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#unchanged-semantics-from-untyped-simple"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Unchanged Semantics from untyped SIMPLE
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#unchanged-auxiliary-operations-from-untyped-simple"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Unchanged auxiliary operations from untyped SIMPLE
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#changes-to-the-existing-untyped-simple-semantics"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Changes to the existing untyped SIMPLE semantics
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#program-initialization"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Program initialization
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#object-and-method-closures"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Object and method closures
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#method-application"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Method application
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#spawn"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Spawn
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#semantics-of-the-new-kool-constructs"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Semantics of the new KOOL constructs
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#class-declaration"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Class declaration
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#method-declaration"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Method declaration
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#new"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                New
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#self-reference"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Self reference
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#object-member-access"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Object member access
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#method-invocation"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Method invocation
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#instance-of"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Instance Of
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#cast"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Cast
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#kool-specific-auxiliary-declarations-and-operations"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                KOOL-specific auxiliary declarations and operations
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#objects-as-lvalues"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Objects as lvalues
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#lookup-member"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Lookup member
              </a></div>
            </div>
          </details>
        
</div>

        </div>
        <div class="btn btn-rv-blue page-toc-toggle-btn"></div>
        <!-- End Page ToC -->
      </div>
    </div>
<!-- The footer is now controlled by the k-web-theme git submodule -->
<footer id="rvsite-footer" class="app-footer text-md-left text-center">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-md-4 mb-md-0 mb-4">
        <a href="https://runtimeverification.com/" target="_blank">
          <picture>
            <source
              srcset="
                https://runtimeverification.com/assets/img/rv-logo-dark.png
              "
              media="(prefers-color-scheme: dark)"
            />
            <img
              class="logo-dark"
              src="https://runtimeverification.com/assets/img/rv-logo.png"
              alt="Runtime Verification logo"
              style="height: 32px"
            /> </picture
        ></a>
        <p class="mt-2 text-md-left copyright">
          <a href="https://maps.app.goo.gl/8YhKozfmZtgzQBsH7" target="_blank"
            >202 S Broadway Ave #31, Urbana, IL</a
          >
        </p>
      </div>
      <div class="col-md-4 text-md-center mb-md-0 mb-4"></div>
      <div class="col-md-4 mb-md-0 mb-4 pl-0 text-md-right">
        <p class="copyright">2026 © all rights reserved</p>
        <span class="copyright"
          ><a href="https://runtimeverification.com/privacy-policy"
            >privacy policy</a
          >
          |
          <a href="https://runtimeverification.com/terms-of-use"
            >terms of use</a
          ></span
        >
      </div>
    </div>
  </div>
</footer>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/Typist/1.2/typist.min.js"></script>
    <script src="../../../../../../../../assets/js/index.js"></script>
    <script>
      $(function () {
        // Render youtube video
        const anchorElements = document.querySelectorAll(".markdown-preview a");
        for (let i = anchorElements.length - 1; i >= 0; i--) {
          if (anchorElements.length - 1 - i > 3) {
            break;
          }
          const anchorElement = anchorElements[i];
          const href = anchorElement.getAttribute("href");
          if (href.match(/^https?:\/\/youtu.be\//)) {
            const match = href.match(/^https?:\/\/youtu.be\/(.+?)$/);
            if (match && match[1]) {
              const youtubeId = match[1];
              const $iframe = $(`
<div style="text-align:center;">
  <iframe
    width="560"
    height="315"
    src="https://www.youtube.com/embed/${youtubeId}"
    frameborder="0"
    allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
    allowfullscreen
    style="max-width: 100%;"
  ></iframe>
  <p>The video is out of date</p>
</div>
`);
              $(anchorElement).replaceWith($iframe[0]);
            }
          }
        }
      });
    </script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-9LBGDMRG32"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-9LBGDMRG32");
    </script>
  </body>
</html>
