<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<project basedir="." default="all.stratego" name="K3Java Build requriements">
	<!-- This is an automatic way of compiling K3.
	To be able to call this script, you will first have to install the appropriate version of
	the stratego-sdf bundle found here: http://strategoxt.org/Stratego/StrategoDownload
	Don't forget to set up the propper execution rights for those programs.
	-->

	<target name="all.stratego" depends="basic.stratego, k3" />

	<target name="basic.stratego">
		<dependset>
			<srcfileset file="../parsers/Basic/trans/*.str" />
			<srcfileset file="../parsers/Basic/include/Basic.str" />
			<srcfileset file="../parsers/Basic/include/Basic.tbl" />
			<targetfileset dir="src/org/kframework/parser/basic/lib/">
				<include name="*.java" />
				<include name="Basic.tbl" />
				<exclude name="xml_string_escape_from_string_0_0.java" />
				<exclude name="clear_console_0_0.java" />
				<exclude name="get_layout_0_0.java" />
			</targetfileset>
		</dependset>
		<available file="src/org/kframework/parser/basic/lib/BasicMain.java" property="basic.stratego.available" />
		<antcall target="basic.stratego.helper" />
	</target>
	<target name="basic.stratego.helper" unless="basic.stratego.available">
		<delete file="../parsers/Basic/trans/BasicMain.rtree" />
		<delete file="../parsers/Basic/trans/BasicMain.dep" />
		<delete dir="../parsers/Basic/trans/BasicMain" />
		<java failonerror="true" dir="../parsers/Basic/trans/" jar="${basedir}/../../dist/bin/java/strategoxt.jar" fork="true">
			<arg line="-i xmlify.str -o BasicMain -la stratego-sglr --lib -I .. -p org.kframework.parser.basic.lib --clean" />
		</java>
		<delete>
			<fileset dir="src/org/kframework/parser/basic/lib">
				<include name="*.java" />
				<include name="Basic.tbl" />
				<exclude name="xml_string_escape_from_string_0_0.java" />
				<exclude name="clear_console_0_0.java" />
				<exclude name="get_layout_0_0.java" />
			</fileset>
		</delete>
		<copy todir="src/org/kframework/parser/basic/lib/">
			<fileset dir="../parsers/Basic/trans/BasicMain">
				<include name="*" />
			</fileset>
		</copy>
		<delete file="../parsers/Basic/trans/BasicMain.rtree" />
		<delete file="../parsers/Basic/trans/BasicMain.dep" />
		<delete dir="../parsers/Basic/trans/BasicMain" />
	</target>

	<target name="k3">
		<dependset>
			<srcfileset file="../K3Disamb/trans/*.str" />
			<srcfileset file="../K3Disamb/include/K3Disamb.str" />
			<targetfileset dir="src/org/kframework/parser/concrete/lib">
				<include name="*.java" />
				<exclude name="string_trim_last_one_0_0.java" />
				<exclude name="string_unescape_sort_0_0.java" />
				<exclude name="annolocation_0_0.java" />
				<exclude name="annolocationremove_0_0.java" />
				<exclude name="clear_console_0_0.java" />
				<exclude name="mergeamb_0_0.java" />
				<exclude name="xml_string_escape_from_string_0_0.java" />
			</targetfileset>
		</dependset>
		<available file="src/org/kframework/parser/concrete/lib/K3Str.java" property="k3.available" />
		<copy todir="lib/resources/sdf" file="../K3Disamb/syntax/Common.sdf" />
		<copy todir="lib/resources/sdf" file="../K3Disamb/syntax/K3Disamb.sdf" />
		<copy todir="lib/resources/sdf" file="../K3Disamb/syntax/KBuiltinsBasic.sdf" />
		<copy todir="lib/resources/sdf" file="../K3Disamb/syntax/KTechnique.sdf" />
		<antcall target="k3.helper" />
	</target>
	<target name="k3.helper" unless="k3.available">
		<delete file="../K3Disamb/trans/K3Str.rtree" />
		<delete file="../K3Disamb/trans/K3Str.dep" />
		<delete dir="../K3Disamb/trans/K3Str" />
		<java failonerror="true" dir="../K3Disamb/trans/" jar="${basedir}/../../dist/bin/java/strategoxt.jar" fork="true">
			<arg line="-i starter.str -o K3Str -la stratego-sglr --lib -I .. -p org.kframework.parser.concrete.lib --clean" />
		</java>
		<delete>
			<fileset dir="src/org/kframework/parser/concrete/lib">
				<include name="*.java" />
				<exclude name="string_trim_last_one_0_0.java" />
				<exclude name="string_unescape_sort_0_0.java" />
				<exclude name="annolocation_0_0.java" />
				<exclude name="annolocationremove_0_0.java" />
				<exclude name="clear_console_0_0.java" />
				<exclude name="mergeamb_0_0.java" />
				<exclude name="xml_string_escape_from_string_0_0.java" />
			</fileset>
		</delete>
		<copy todir="src/org/kframework/parser/concrete/lib/">
			<fileset dir="../K3Disamb/trans/K3Str">
				<include name="*" />
			</fileset>
		</copy>

		<delete file="../K3Disamb/trans/K3Str.rtree" />
		<delete file="../K3Disamb/trans/K3Str.dep" />
		<delete dir="../K3Disamb/trans/K3Str" />
	</target>
</project>
