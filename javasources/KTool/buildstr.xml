<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<project basedir="." default="all.stratego2java" name="K3Java Build requriements">
	<!-- This is an automatic way of compiling K3.
	To be able to call this script, you will first have to install the appropriate version of
	the stratego-sdf bundle found here: http://strategoxt.org/Stratego/StrategoDownload
	Don't forget to set up the propper execution rights for those programs.
	-->

	<target name="all.stratego2java" depends="basic.stratego2java, concrete.stratego2java" />

	<target name="basic.stratego2java">
		<dependset>
			<srcfileset file="../parsers/Basic/trans/*.str" />
			<srcfileset file="../parsers/Basic/include/Basic.str" />
			<srcfileset file="../parsers/Basic/include/Basic.tbl" />
			<targetfileset dir="src/org/kframework/parser/basic/lib/">
				<include name="*.java" />
				<include name="Basic.tbl" />
				<exclude name="xml_string_escape_from_string_0_0.java" />
				<exclude name="clear_console_0_0.java" />
				<exclude name="get_layout_0_0.java" />
			</targetfileset>
		</dependset>
		<available file="src/org/kframework/parser/basic/lib/BasicMain.java" property="basic.stratego2java.available" />
		<antcall target="basic.stratego2java.helper" />
	</target>
	<target name="basic.stratego2java.helper" unless="basic.stratego2java.available">
		<delete file="../parsers/Basic/trans/BasicMain.rtree" />
		<delete file="../parsers/Basic/trans/BasicMain.dep" />
		<delete dir="../parsers/Basic/trans/BasicMain" />
		<java failonerror="true" dir="../parsers/Basic/trans/" jar="${basedir}/../../dist/lib/java/strategoxt.jar" fork="true">
			<arg line="-i xmlify.str -o BasicMain -la stratego-sglr --lib -I .. -p org.kframework.parser.basic.lib --clean" />
		</java>
		<delete>
			<fileset dir="src/org/kframework/parser/basic/lib">
				<include name="*.java" />
				<include name="Basic.tbl" />
				<exclude name="xml_string_escape_from_string_0_0.java" />
				<exclude name="clear_console_0_0.java" />
				<exclude name="get_layout_0_0.java" />
			</fileset>
		</delete>
		<copy todir="src/org/kframework/parser/basic/lib/">
			<fileset dir="../parsers/Basic/trans/BasicMain">
				<include name="*" />
			</fileset>
		</copy>
		<delete file="../parsers/Basic/trans/BasicMain.rtree" />
		<delete file="../parsers/Basic/trans/BasicMain.dep" />
		<delete dir="../parsers/Basic/trans/BasicMain" />
	</target>

	<target name="concrete.stratego2java">
		<dependset>
			<srcfileset file="../parsers/Concrete/trans/*.str" />
			<srcfileset file="../parsers/Concrete/include/Concrete.str" />
			<targetfileset dir="src/org/kframework/parser/concrete/lib">
				<include name="*.java" />
				<exclude name="string_trim_last_one_0_0.java" />
				<exclude name="string_unescape_sort_0_0.java" />
				<exclude name="annolocation_0_0.java" />
				<exclude name="annolocationremove_0_0.java" />
				<exclude name="clear_console_0_0.java" />
				<exclude name="mergeamb_0_0.java" />
				<exclude name="xml_string_escape_from_string_0_0.java" />
			</targetfileset>
		</dependset>
		<available file="src/org/kframework/parser/concrete/lib/ConcreteMain.java" property="concrete.stratego2java.available" />
		<copy todir="lib/resources/sdf" file="../parsers/Concrete/syntax/Common.sdf" />
		<copy todir="lib/resources/sdf" file="../parsers/Concrete/syntax/Concrete.sdf" />
		<copy todir="lib/resources/sdf" file="../parsers/Concrete/syntax/KBuiltinsBasic.sdf" />
		<copy todir="lib/resources/sdf" file="../parsers/Concrete/syntax/KTechnique.sdf" />
		<copy todir="lib/resources/sdf" file="../parsers/Concrete/syntax/Variables.sdf" />
		<antcall target="concrete.stratego2java.helper" />
	</target>
	<target name="concrete.stratego2java.helper" unless="concrete.stratego2java.available">
		<delete file="../parsers/Concrete/trans/ConcreteMain.rtree" />
		<delete file="../parsers/Concrete/trans/ConcreteMain.dep" />
		<delete dir="../parsers/Concrete/trans/ConcreteMain" />
		<java failonerror="true" dir="../parsers/Concrete/trans/" jar="${basedir}/../../dist/lib/java/strategoxt.jar" fork="true">
			<arg line="-i starter.str -o ConcreteMain -la stratego-sglr --lib -I .. -p org.kframework.parser.concrete.lib --clean" />
		</java>
		<delete>
			<fileset dir="src/org/kframework/parser/concrete/lib">
				<include name="*.java" />
				<exclude name="string_trim_last_one_0_0.java" />
				<exclude name="string_unescape_sort_0_0.java" />
				<exclude name="annolocation_0_0.java" />
				<exclude name="annolocationremove_0_0.java" />
				<exclude name="clear_console_0_0.java" />
				<exclude name="mergeamb_0_0.java" />
				<exclude name="xml_string_escape_from_string_0_0.java" />
			</fileset>
		</delete>
		<copy todir="src/org/kframework/parser/concrete/lib/">
			<fileset dir="../parsers/Concrete/trans/ConcreteMain">
				<include name="*" />
			</fileset>
		</copy>

		<delete file="../parsers/Concrete/trans/ConcreteMain.rtree" />
		<delete file="../parsers/Concrete/trans/ConcreteMain.dep" />
		<delete dir="../parsers/Concrete/trans/ConcreteMain" />
	</target>
</project>
