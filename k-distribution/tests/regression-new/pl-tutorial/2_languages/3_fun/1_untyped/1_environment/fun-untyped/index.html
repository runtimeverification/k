<!DOCTYPE html>
<html lang="en">
  <head>
<meta charset="utf-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
/>
<meta
  name="description"
  content="Design and implement your programming language and software analysis tools with mathematical rigor."
/>
<meta name="keywords" content="runtime, verification, rv, k" />
<meta name="author" content="K | Runtime Verification Inc" />
<meta name="robots" content="index, follow" />
<link rel="canonical" href="https://kframework.org/k-distribution/tests/regression-new/pl-tutorial/2_languages/3_fun/1_untyped/1_environment/fun-untyped/" />

<!--favicon icon-->
<link rel="icon" type="image/png" href="../../../../../../../../../assets/img/favicon.ico" />

<title>FUN — Untyped — Environment | Runtime Verification Inc</title>

<!-- <base href="/k/" /> -->

<!--web fonts-->
<link
  href="https://fonts.googleapis.com/css?family=Nunito:300,400,600,700,800"
  rel="stylesheet"
/>
<link
  href="https://fonts.googleapis.com/css?family=Lora:400i"
  rel="stylesheet"
/>

<link
  href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css"
  rel="stylesheet"
/>

<link href="../../../../../../../../../assets/css/index.css" rel="stylesheet" />

<!--[if (gt IE 9) |!(IE)]><!-->
<!--<link rel="stylesheet" href="/assets/vendor/custom-nav/css/effects/fade-menu.css"/>-->
<!-- <link rel="stylesheet" href="../../../../../../../../../assets/k/vl-nav/css/effects/slide-menu.css" /> -->
<!--<![endif]-->

  </head>

  <body>
<header
  class="navbar navbar-expand navbar-dark flex-column flex-md-row bd-navbar"
>
  <a class="logo-link" href="../../../../../../../../../index.html">
    <picture>
      <source
        srcset="../../../../../../../../../assets/img/k-logo-dark.png"
        media="(prefers-color-scheme: dark)"
      />
      <img src="../../../../../../../../../assets/img/k-logo.png" alt="K" style="height: 48px" />
    </picture>
    Semantic Framework
  </a>
  <ul class="navbar-nav ml-md-auto">
    <li class="nav-item dropdown">
      <a
        class="nav-link dropdown-toggle"
        href="#"
        id="navbarDropdown"
        role="button"
        data-toggle="dropdown"
        aria-haspopup="true"
        aria-expanded="false"
      >
        <i class="fas fa-book"></i>
      </a>
      <div class="dropdown-menu" aria-labelledby="navbarDropdown">
        <a class="dropdown-item" href="../../../../../../../../../exports/K.pdf">pdf</a>
        <a class="dropdown-item" href="../../../../../../../../../exports/K.epub">epub</a>
        <a class="dropdown-item" href="../../../../../../../../../exports/K.mobi">mobi</a>
        <a class="dropdown-item" href="../../../../../../../../../exports/K.html">html</a>
      </div>
    </li>
    <li class="nav-item">
      <a
        class="nav-link pl-2 pr-1 mx-1 py-3 my-n2"
        href="https://github.com/runtimeverification/k"
        target="_blank"
        rel="noopener"
        aria-label="GitHub"
      >
        <i class="fab fa-github"></i>
      </a>
    </li>
  </ul>
  <a
    class="btn btn-rv-blue d-none d-lg-inline-block mb-3 mb-md-0 ml-md-3"
    href="https://github.com/runtimeverification/k/releases/latest"
    >Download</a
  >
</header>
<style>
  .dropdown:hover .dropdown-menu {
    display: block;
    margin-top: 0; /* remove the gap so it doesn't close */
  }
</style>


    <div class="container-fluid">
      <div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 bd-sidebar mb-3">
  <form
    role="search"
    class="bd-search d-flex align-items-center justify-content-between"
  >
    <input
      type="search"
      class="form-control"
      placeholder="Search..."
      aria-label="Search for..."
      autocomplete="false"
      id="search-box"
    />
    <button
      class="btn bd-search-docs-toggle d-md-none p-0 ml-3 collapsed"
      type="button"
      aria-label="Toggle docs navigation"
      style="font-size: 1.4rem"
    >
      <i class="fas fa-bars"></i>
    </button>
  </form>
  <nav class="collapse bd-links" aria-label="Main navigation">
    <div class="sidebar-toc pl-2"><div>
<div style="padding:0.25rem 0;;padding-left: 8px;"><a href="../../../../../../../../../">Homepage</a></div>
<div style="padding:0.25rem 0;;padding-left: 8px;"><a href="https://github.com/runtimeverification/k/releases/latest">Install K</a></div>
<div style="padding:0.25rem 0;;padding-left: 8px;"><a href="https://kframework.org/pyk">Pyk Documentation</a></div>
<details style="padding:0.25rem 0;;padding-left: 8px;"><summary><a href="../../../../../../../../../k-distribution/k-tutorial/">K Tutorial</a></summary><div>
<details style="padding:0.25rem 0;;padding-left: 16px;"><summary><a href="../../../../../../../../../k-distribution/k-tutorial/1_basic/">Section 1: Basic K Concepts</a></summary><div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/1_basic/01_installing/">Lesson 1.1: Setting up a K Environment</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/1_basic/02_basics/">Lesson 1.2: Basics of Functional K</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/1_basic/03_parsing/">Lesson 1.3: BNF Syntax and Parser Generation</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/1_basic/04_disambiguation/">Lesson 1.4: Disambiguating Parses</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/1_basic/05_modules/">Lesson 1.5: Modules, Imports, and Requires</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/1_basic/06_ints_and_bools/">Lesson 1.6: Integers and Booleans</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/1_basic/07_side_conditions/">Lesson 1.7: Side Conditions and Rule Priority</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/1_basic/08_literate_programming/">Lesson 1.8: Literate Programming with Markdown</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/1_basic/09_unparsing/">Lesson 1.9: Unparsing and the format and color attributes</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/1_basic/10_strings/">Lesson 1.10: Strings</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/1_basic/11_casts/">Lesson 1.11: Casting Terms</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/1_basic/12_syntactic_lists/">Lesson 1.12: Syntactic Lists</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/1_basic/13_rewrite_rules/">Lesson 1.13: Basics of K Rewriting</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/1_basic/14_evaluation_order/">Lesson 1.14: Defining Evaluation Order</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/1_basic/15_configurations/">Lesson 1.15: Configuration Declarations and Cell Nesting</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/1_basic/16_collections/">Lesson 1.16: Maps, Semantic Lists, and Sets</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/1_basic/17_cell_multiplicity/">Lesson 1.17: Cell Multiplicity and Cell Collections</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/1_basic/18_equality_and_conditionals/">Lesson 1.18: Term Equality and the Ternary Operator</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/1_basic/19_debugging/">Lesson 1.19: Debugging with GDB or LLDB</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/1_basic/20_backends/">Lesson 1.20: K Backends and the Haskell Backend</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/1_basic/21_symbolic_execution/">Lesson 1.21: Unification and Symbolic Execution</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/1_basic/22_proofs/">Lesson 1.22: K Deductive Verification</a></div>
</div></details>
<details style="padding:0.25rem 0;;padding-left: 16px;"><summary><a href="../../../../../../../../../k-distribution/k-tutorial/2_intermediate/">Section 2: Intermediate K Concepts</a></summary><div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/2_intermediate/01_macros/">Lesson 2.1: Macros, Aliases, and Anywhere Rules</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/2_intermediate/02_fresh_constants/">Lesson 2.2: Fresh Constants</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/2_intermediate/03_klabels/">Lesson 2.3: KLabels and Abstract Syntax</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/2_intermediate/04_overloading/">Lesson 2.4: Overloaded Symbols</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/2_intermediate/05_matching_logic/">Lesson 2.5: Matching Logic Connectives and #Or Patterns</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/2_intermediate/06_function_context/">Lesson 2.6: Function Context</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/2_intermediate/07_record_productions/">Lesson 2.7: Record Productions and Named Nonterminals</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/2_intermediate/08_fun_and_let/">Lesson 2.8: #fun and #let</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/2_intermediate/09_as/">Lesson 2.9: #as Patterns</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/2_intermediate/10_matching_operator/">Lesson 2.10: The Matching Operators, :=K and :/=K</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/2_intermediate/11_evaluation_order/">Lesson 2.11: Uncommon Evaluation Order Concepts</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/2_intermediate/12_floats_and_machine_ints/">Lesson 2.12: IEEE 754 Floating Point and Fixed Width Integers</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/2_intermediate/13_substitution/">Lesson 2.13: Alpha-renaming-aware Substitution</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/2_intermediate/14_io/">Lesson 2.14: File I/O</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/2_intermediate/15_string_buffers_and_bytes/">Lesson 2.15: String Buffers and Byte Sequences</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/2_intermediate/16_kore/">Lesson 2.16: The Intermediate Language of K, KORE</a></div>
<div style="padding:0.25rem 0;;padding-left: 24px;"><a href="../../../../../../../../../k-distribution/k-tutorial/2_intermediate/17_debugging_proofs/">Lesson 2.17: Debugging Proofs using the Haskell Backend REPL</a></div>
</div></details>
</div></details>
<div style="padding:0.25rem 0;;padding-left: 8px;"><a href="../../../../../../../../../docs/user_manual/">K User Manual</a></div>
<div style="padding:0.25rem 0;;padding-left: 8px;"><a href="../../../../../../../../../docs/cheat_sheet/">K Cheat Sheet</a></div>
<div style="padding:0.25rem 0;;padding-left: 8px;"><a href="../../../../../../../../../docs/ktools/">K Tool Reference</a></div>
<details style="padding:0.25rem 0;;padding-left: 8px;"><summary><a href="../../../../../../../../../k-distribution/include/kframework/">K Builtins</a></summary><div>
<div style="padding:0.25rem 0;;padding-left: 16px;"><a href="../../../../../../../../../k-distribution/include/kframework/builtin/domains/">domains</a></div>
<div style="padding:0.25rem 0;;padding-left: 16px;"><a href="../../../../../../../../../k-distribution/include/kframework/builtin/kast/">kast</a></div>
<div style="padding:0.25rem 0;;padding-left: 16px;"><a href="../../../../../../../../../k-distribution/include/kframework/builtin/prelude/">prelude</a></div>
<div style="padding:0.25rem 0;;padding-left: 16px;"><a href="../../../../../../../../../k-distribution/include/kframework/builtin/ffi/">ffi</a></div>
<div style="padding:0.25rem 0;;padding-left: 16px;"><a href="../../../../../../../../../k-distribution/include/kframework/builtin/json/">json</a></div>
<div style="padding:0.25rem 0;;padding-left: 16px;"><a href="../../../../../../../../../k-distribution/include/kframework/builtin/rat/">rat</a></div>
<div style="padding:0.25rem 0;;padding-left: 16px;"><a href="../../../../../../../../../k-distribution/include/kframework/builtin/substitution/">substitution</a></div>
<div style="padding:0.25rem 0;;padding-left: 16px;"><a href="https://github.com/runtimeverification/k/blob/master/k-distribution/include/kframework/builtin/unification.k">unification</a></div>
</div></details>
<details style="padding:0.25rem 0;;padding-left: 8px;"><summary><a href="../../../../../../../../../k-distribution/pl-tutorial/">K PL Tutorial</a></summary><div>
<div style="padding:0.25rem 0;;padding-left: 16px;"><a href="../../../../../../../../../overview/">K Overview</a></div>
<details style="padding:0.25rem 0;;padding-left: 16px;"><summary><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/">Learning K</a></summary><div>
<details style="padding:0.25rem 0;;padding-left: 24px;"><summary><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/1_lambda/">Part 1: Defining LAMBDA</a></summary><div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/1_lambda/lesson_1/">Lesson 1, LAMBDA: Syntax Modules and Basic K Commands</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/1_lambda/lesson_2/">Lesson 2, LAMBDA: Module Importing, Rules, Variables</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/1_lambda/lesson_3/">Lesson 3, LAMBDA: Evaluation Strategies using Strictness</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/1_lambda/lesson_4/">Lesson 4, LAMBDA: Generating Documentation; Latex Attributes</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/1_lambda/lesson_5/">Lesson 5, LAMBDA: Adding Builtins; Side Conditions</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/1_lambda/lesson_6/">Lesson 6, LAMBDA: Selective Strictness; Anonymous Variables</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/1_lambda/lesson_7/">Lesson 7, LAMBDA: Derived Constructs; Extending Predefined Syntax</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/1_lambda/lesson_8/">Lesson 8, LAMBDA: Multiple Binding Constructs</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/1_lambda/lesson_9/">Lesson 9, LAMBDA: A Complete and Commented Definition</a></div>
</div></details>
<details style="padding:0.25rem 0;;padding-left: 24px;"><summary><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/2_imp/">Part 2: Defining IMP</a></summary><div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/2_imp/lesson_1/">Lesson 1, IMP: Defining a More Complex Syntax</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/2_imp/lesson_2/">Lesson 2, IMP: Defining a Configuration</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/2_imp/lesson_3/">Lesson 3, IMP: Computations, Results, Strictness; Rules Involving Cells</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/2_imp/lesson_4/">Lesson 4, IMP: Configuration Abstraction, Part 1; Types of Rules</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/2_imp/lesson_5/">Lesson 5, IMP: Completing and Documenting IMP</a></div>
</div></details>
<details style="padding:0.25rem 0;;padding-left: 24px;"><summary><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/3_lambda++/">Part 3: Defining LAMBDA++</a></summary><div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/3_lambda++/lesson_1/">Lesson 1, LAMBDA++: Abrupt Changes of Control</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/3_lambda++/lesson_2/">Lesson 2, LAMBDA++: Semantic (Non-Syntactic) Computation Items</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/3_lambda++/lesson_3/">Lesson 3, LAMBDA++: Reusing Existing Semantics</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/3_lambda++/lesson_4/">Lesson 4, LAMBDA++: Do Not Reuse Blindly!</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/3_lambda++/lesson_5/">Lesson 5, LAMBDA++: More Semantic Computation Items</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/3_lambda++/lesson_6/">Lesson 6, LAMBDA++: Wrapping Up and Documenting LAMBDA++ (environment-based)</a></div>
</div></details>
<details style="padding:0.25rem 0;;padding-left: 24px;"><summary><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/4_imp++/">Part 4: Defining IMP++</a></summary><div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/4_imp++/lesson_1/">Lesson 1, IMP++: Extending/Changing an Existing Language Syntax</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/4_imp++/lesson_2/">Lesson 2, IMP++: Configuration Refinement; Freshness</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/4_imp++/lesson_3/">Lesson 3, IMP++: Tagging; Superheat/Supercool Kompilation Options</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/4_imp++/lesson_4/">Lesson 4, IMP++: Semantic Lists; Input/Output Streaming</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/4_imp++/lesson_5/">Lesson 5, IMP++: Deleting, Saving and Restoring Cell Contents</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/4_imp++/lesson_6/">Lesson 6, IMP++: Adding/Deleting Cells Dynamically; Configuration Abstraction, Part 2</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/4_imp++/lesson_7/">Lesson 7, IMP++: Everything Changes: Syntax, Configuration, Semantics</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/4_imp++/lesson_8/">Lesson 8, IMP++: Wrapping up Larger Languages</a></div>
</div></details>
<details style="padding:0.25rem 0;;padding-left: 24px;"><summary><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/5_types/">Part 5: Defining Type Systems</a></summary><div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/5_types/lesson_1/">Lesson 1, Type Systems: Imperative, Environment-Based Type Systems</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/5_types/lesson_2/">Lesson 2, Type Systems: Substitution-Based Higher-Order Type Systems</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/5_types/lesson_3/">Lesson 3, Type Systems: Environment-Based Higher-Order Type Systems</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/5_types/lesson_4/">Lesson 4, Type Systems: A Naive Substitution-Based Type Inferencer</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/5_types/lesson_5/">Lesson 5, Type Systems: A Naive Environment-Based Type Inferencer</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/5_types/lesson_6/">Lesson 6, Type Systems: Parallel Type Checkers/Inferencers</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/5_types/lesson_7/">Lesson 7, Type Systems: A Naive Substitution-based Polymorphic Type Inferencer</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/5_types/lesson_8/">Lesson 8, Type Systems: A Naive Environment-based Polymorphic Type Inferencer</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/1_k/5_types/lesson_9/">Lesson 9, Type Systems: Let-Polymorphic Type Inferencer (Damas-Hindley-Milner)</a></div>
</div></details>
</div></details>
<details style="padding:0.25rem 0;;padding-left: 16px;"><summary><a href="../../../../../../../../../k-distribution/pl-tutorial/2_languages/">Learning Language Design and Semantics using K</a></summary><div>
<details style="padding:0.25rem 0;;padding-left: 24px;"><summary><a href="../../../../../../../../../k-distribution/pl-tutorial/2_languages/1_simple/1_untyped/simple-untyped/">Part 7: SIMPLE: Designing Imperative Programming Languages</a></summary><div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/2_languages/1_simple/1_untyped/simple-untyped/">Lesson 1, SIMPLE untyped</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/2_languages/1_simple/2_typed/1_static/simple-typed-static/">Lesson 2, SIMPLE typed static</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/2_languages/1_simple/2_typed/2_dynamic/simple-typed-dynamic/">Lesson 3, SIMPLE typed dynamic</a></div>
</div></details>
<details style="padding:0.25rem 0;;padding-left: 24px;"><summary><a href="../../../../../../../../../k-distribution/pl-tutorial/2_languages/2_kool/1_untyped/kool-untyped/">Part 8: KOOL: Designing Object-Oriented Programming Languages</a></summary><div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/2_languages/2_kool/1_untyped/kool-untyped/">Lesson 1, KOOL untyped</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/2_languages/2_kool/2_typed/1_dynamic/kool-typed-dynamic/">Lesson 2, KOOL typed dynamic</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/2_languages/2_kool/2_typed/2_static/kool-typed-static/">Lesson 3, KOOL typed static</a></div>
</div></details>
<details style="padding:0.25rem 0;;padding-left: 24px;"><summary><a href="../../../../../../../../../k-distribution/pl-tutorial/2_languages/3_fun/1_untyped/1_environment/fun-untyped/">Part 9: FUN: Designing Functional Programming Languages</a></summary><div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/2_languages/3_fun/1_untyped/1_environment/fun-untyped/">Lesson 1, FUN untyped, Environment-Based</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/2_languages/3_fun/1_untyped/2_substitution/fun-untyped/">Lesson 2, FUN untyped, Substitution-Based</a></div>
<div style="padding:0.25rem 0;;padding-left: 32px;">Lesson 3, FUN polymorphic type inferencer</div>
</div></details>
<details style="padding:0.25rem 0;;padding-left: 24px;"><summary><a href="../../../../../../../../../k-distribution/pl-tutorial/2_languages/4_logik/basic/logik/">Part 10: LOGIK: Designing Logic Programming Languages</a></summary><div>
<div style="padding:0.25rem 0;;padding-left: 32px;"><a href="../../../../../../../../../k-distribution/pl-tutorial/2_languages/4_logik/basic/logik/">Lesson 1, LOGIK</a></div>
</div></details>
</div></details>
</div></details>
<div style="padding:0.25rem 0;;padding-left: 8px;"><a href="../../../../../../../../../projects/">Projects using K</a></div>
</div></div>
  </nav>
</div>

        <main
          class="col-12 col-md-6 col-xl-8 py-md-3 pl-md-5 bd-content"
          role="main"
        >
          <div class="introduction markdown-preview"><html><head></head><body><h1 id="fun-%E2%80%94-untyped-%E2%80%94-environment">FUN — Untyped — Environment</h1>
<p>Author: Grigore Roșu (grosu@illinois.edu)<br>
Organization: University of Illinois at Urbana-Champaign</p>
<p>Author: Traian Florin Șerbănuță (traian.serbanuta@unibuc.ro)<br>
Organization: University of Bucharest</p>
<h2 id="abstract">Abstract</h2>
<p>This is the <strong>K</strong> semantic definition of the untyped FUN language.
FUN is a pedagogical and research language that captures the essence
of the functional programming paradigm, extended with several features
often encountered in functional programming languages.
Like many functional languages, FUN is an expression language, that
is, everything, including the main program, is an expression.
Functions can be declared anywhere and are first class values in the
language.
FUN is call-by-value here, but it has been extended (as student
homework assignments) with other parameter-passing styles.
To make it more interesting and to highlight some of <strong>K</strong>'s strengths,
FUN includes the following features:</p>
<ul>
<li>
<p>The basic builtin data-types of integers, booleans and strings.</p>
</li>
<li>
<p>Builtin lists, which can hold any elements, including other lists.
Lists are enclosed in square brackets and their elements are
comma-separated; e.g., <code>[1,2,3]</code>.</p>
</li>
<li>
<p>User-defined data-types, by means of constructor terms.
Constructor names start with a capital letter (while any other
identifier in the language starts with a lowercase letter), and they
can be followed by an arbitrary number of comma-separated arguments
enclosed in parentheses; parentheses are not needed when the
constructor takes no arguments.
For example, <code>Pair(5,7)</code> is a constructor term holding two
numbers, <code>Cons(1,Cons(2,Cons(3,Nil)))</code> is a list-like
constructor term holding 3 elements, and
<code>Tree(Tree(Leaf(1), Leaf(2)), Leaf(3))</code> is a tree-like
constructor term holding 3 elements.
In the untyped version of the FUN language, no type checking or
inference is performed to ensure that the data constructors are used
correctly.
The execution will simply get stuck when they are misused.
Moreover, since no type checking is performed, the data-types are not
even declared in the untyped version of FUN.</p>
</li>
<li>
<p>Functions and <code>let</code>/<code>letrec</code> binders can take
multiple space-separated arguments, but these are desugared to
ones that only take one argument, by currying.  For example, the
expressions</p>
<pre class="line-numbers language-line-numbers" data-start="1" style="counter-reset: linenumber 0;"><code>fun x y -&gt; x y
let x y = y in x
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>are desugared, respectively, into the following expressions:</p>
<pre class="line-numbers language-line-numbers" data-start="1" style="counter-reset: linenumber 0;"><code>fun x -&gt; fun y -&gt; x y
let x = fun y -&gt; y in x
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li>
<p>Functions can be defined using pattern matching over the
available data-types.  For example, the program</p>
<pre class="line-numbers language-line-numbers" data-start="1" style="counter-reset: linenumber 0;"><code>letrec max = fun [h] -&gt; h
             |   [h|t] -&gt; let x = max t
                          in  if h &gt; x then h else x
in max [1, 3, 5, 2, 4, 0, -1, -5]
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>defines a function <code>max</code> that calculates the maximum element of
a non-empty list, and the function</p>
<pre class="line-numbers language-line-numbers" data-start="1" style="counter-reset: linenumber 0;"><code>letrec ack = fun Pair(0,n) -&gt; n + 1
             |   Pair(m,0) -&gt; ack Pair(m - 1, 1)
             |   Pair(m,n) -&gt; ack Pair(m - 1, ack Pair(m, n - 1))
in ack Pair(2,3)
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>calculates the Ackermann function applied to a particular pair of numbers.
Patterns can be nested.  Patterns can currently only be used in function
definitions, and not directly in <code>let</code>/<code>letrec</code> binders.
For example, this is not allowed:</p>
<pre class="line-numbers language-line-numbers" data-start="1" style="counter-reset: linenumber 0;"><code>letrec Pai(x,y) = Pair(1,2) in x+y
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>But this is allowed:</p>
<pre class="line-numbers language-line-numbers" data-start="1" style="counter-reset: linenumber 0;"><code>let f Pair(x,y) = x+y in f Pair(1,2)
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>because it is first reduced to</p>
<pre class="line-numbers language-line-numbers" data-start="1" style="counter-reset: linenumber 0;"><code>let f = fun Pair(x,y) -&gt; x+y in f Pair(1,2)
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>by uncurrying of the <code>let</code> binder, and pattern matching is
allowed in function arguments.</p>
</li>
<li>
<p>We include a <code>callcc</code> construct, for two reasons: first,
several functional languages support this construct; second, some
semantic frameworks have difficulties defining it.  Not <strong>K</strong>.</p>
</li>
<li>
<p>Finally, we include mutables by means of referencing an
expression, getting the reference of a variable, dereferencing and
assignment.  We include these for the same reasons as above: there are
languages which have them, and they are not easy to define in some
semantic frameworks.</p>
</li>
</ul>
<p>Like in many other languages, some of FUN's constructs can be
desugared into a smaller set of basic constructs.  We do that as usual,
using macros, and then we only give semantics to the core constructs.</p>
<p><strong>Note:</strong><br>
We recommend the reader to first consult the dynamic semantics of the
LAMBDA++ language in the first part of the K Tutorial.
To keep the comments below small and focused, we will not re-explain
functional or <strong>K</strong> features that have already been explained in there.</p>
<h2 id="syntax">Syntax</h2>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k"><span class="token comment">//require "modules/pattern-matching.k"</span>

<span class="token keyword">module</span> FUN<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>COMMON
  <span class="token keyword">imports</span> DOMAINS<span class="token operator">-</span>SYNTAX
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>FUN is an expression language.  The constructs below fall into
several categories: names, arithmetic constructs, conventional
functional constructs, patterns and pattern matching, data constructs,
lists, references, and call-with-current-continuation (callcc).
The arithmetic constructs are standard; they are present in almost all
our <strong>K</strong> language definitions.  The meaning of FUN's constructs are
discussed in more depth when we define their semantics in the next
module.</p>
<h2 id="the-syntactic-constructs">The Syntactic Constructs</h2>
<p>We start with the syntactic definition of FUN names.
We have several categories of names: ones to be used for functions and
variables, others to be used for data constructors, others for types and
others for type variables.  We will introduce them as needed, starting
with the former category.  We prefer the names of variables and functions
to start with lower case letters.  We take the freedom to tacitly introduce
syntactic lists/sequences for each nonterminal for which we need them:</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> Name                                      <span class="token punctuation">[</span><span class="token class-name">token</span><span class="token punctuation">]</span>
  <span class="token keyword">syntax</span> Names <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> List<span class="token punctuation">{</span>Name<span class="token punctuation">,</span><span class="token string">","</span><span class="token punctuation">}</span>                  <span class="token punctuation">[</span>overload<span class="token punctuation">(</span>exps<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>Expression constructs will be defined throughtout the syntax module.
Below are the very basic ones, namely the builtins, the names, and the
parentheses used as brackets for grouping.  Lists of expressions are
declared strict, so all expressions in the list get evaluated whenever
the list is on a position which can be evaluated:</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> Exp <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token keyword">Int</span> <span class="token operator">|</span> <span class="token keyword">Bool</span> <span class="token operator">|</span> <span class="token keyword">String</span> <span class="token operator">|</span> Name
               <span class="token operator">|</span> <span class="token string">"("</span> Exp <span class="token string">")"</span>                       <span class="token punctuation">[</span><span class="token class-name">bracket</span><span class="token punctuation">]</span>
  <span class="token keyword">syntax</span> Exps  <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> List<span class="token punctuation">{</span>Exp<span class="token punctuation">,</span><span class="token string">","</span><span class="token punctuation">}</span>                   <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> overload<span class="token punctuation">(</span>exps<span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token keyword">syntax</span> Val
  <span class="token keyword">syntax</span> Exp <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Val
  <span class="token keyword">syntax</span> Exps <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Vals
  <span class="token keyword">syntax</span> Vals <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> List<span class="token punctuation">{</span>Val<span class="token punctuation">,</span><span class="token string">","</span><span class="token punctuation">}</span>                    <span class="token punctuation">[</span>overload<span class="token punctuation">(</span>exps<span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token keyword">syntax</span> Bottom
  <span class="token keyword">syntax</span> Bottoms <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> List<span class="token punctuation">{</span>Bottom<span class="token punctuation">,</span><span class="token string">","</span><span class="token punctuation">}</span>              <span class="token punctuation">[</span>overload<span class="token punctuation">(</span>exps<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>We next define the syntax of arithmetic constructs, together with
their relative priorities and left-/non-associativities.  We also
tag all these rules as members of a new group, "arith", so we can more easily
define global syntax priorities later (at the end of the syntax module).</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> Exp <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token class-name">left</span><span class="token punctuation">:</span>
                 Exp <span class="token string">"*"</span> Exp                       <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> group<span class="token punctuation">(</span>arith<span class="token punctuation">)</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">"/"</span> Exp                       <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> group<span class="token punctuation">(</span>arith<span class="token punctuation">)</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">"%"</span> Exp                       <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> group<span class="token punctuation">(</span>arith<span class="token punctuation">)</span><span class="token punctuation">]</span>
               &gt; <span class="token class-name">left</span><span class="token punctuation">:</span>
                 Exp <span class="token string">"+"</span> Exp                       <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> <span class="token class-name">left</span><span class="token punctuation">,</span> group<span class="token punctuation">(</span>arith<span class="token punctuation">)</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">"^"</span> Exp                       <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> <span class="token class-name">left</span><span class="token punctuation">,</span> group<span class="token punctuation">(</span>arith<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token comment">// left attribute should not be necessary; currently a parsing bug</span>
               <span class="token operator">|</span> Exp <span class="token string">"-"</span> Exp                       <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> <span class="token class-name">prefer</span><span class="token punctuation">,</span> group<span class="token punctuation">(</span>arith<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token comment">// the "prefer" attribute above is to not parse x-1 as x(-1)</span>
<span class="token comment">// Due to some parsing problems, we currently cannot add unary minus:</span>
               <span class="token operator">|</span> <span class="token string">"-"</span> Exp                           <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> group<span class="token punctuation">(</span>arith<span class="token punctuation">)</span><span class="token punctuation">]</span>
               &gt; <span class="token class-name">non-assoc</span><span class="token punctuation">:</span>
                 Exp <span class="token string">"&lt;"</span> Exp                       <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> group<span class="token punctuation">(</span>arith<span class="token punctuation">)</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">"&lt;="</span> Exp                      <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> group<span class="token punctuation">(</span>arith<span class="token punctuation">)</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">"&gt;"</span> Exp                       <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> group<span class="token punctuation">(</span>arith<span class="token punctuation">)</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">"&gt;="</span> Exp                      <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> group<span class="token punctuation">(</span>arith<span class="token punctuation">)</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">"=="</span> Exp                      <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> group<span class="token punctuation">(</span>arith<span class="token punctuation">)</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">"!="</span> Exp                      <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> group<span class="token punctuation">(</span>arith<span class="token punctuation">)</span><span class="token punctuation">]</span>
               &gt; <span class="token string">"!"</span> Exp                           <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> group<span class="token punctuation">(</span>arith<span class="token punctuation">)</span><span class="token punctuation">]</span>
               &gt; Exp <span class="token string">"&amp;&amp;"</span> Exp                      <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">left</span><span class="token punctuation">,</span> group<span class="token punctuation">(</span>arith<span class="token punctuation">)</span><span class="token punctuation">]</span>
               &gt; Exp <span class="token string">"||"</span> Exp                      <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">left</span><span class="token punctuation">,</span> group<span class="token punctuation">(</span>arith<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>The conditional construct has the expected evaluation strategy,
stating that only the first argument is evaluate:</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> Exp <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">"if"</span> Exp <span class="token string">"then"</span> Exp <span class="token string">"else"</span> Exp    <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>FUN's builtin lists are formed by enclosing comma-separated
sequences of expressions (i.e., terms of sort <code>Exps</code>) in square
brackets.  The list constructor <code>cons</code> adds a new element to the
top of the list, <code>head</code> and <code>tail</code> get the first element
and the tail sublist of a list if they exist, respectively, and get
stuck otherwise, and <code>null??</code> tests whether a list is empty or
not; syntactically, these are just expression constants.
In function patterns, we are also going to allow patterns following the
usual head/tail notation; for example, the pattern <code>[x_1,...,x_n|t]</code>
binds <code>x_1</code>, ..., <code>x_n</code> to the first elements of the matched list,
and <code>t</code> to the list formed with the remaining elements.  We define list
patterns as ordinary expression constructs, although we will make sure that
we do not give them semantics if they appear in any other place then in a
function case pattern.</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> Exp <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">"["</span> Exps <span class="token string">"]"</span>                             <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> <span class="token class-name">klabel</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> <span class="token string">"head"</span> <span class="token punctuation">[</span><span class="token class-name">macro</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token string">"tail"</span> <span class="token punctuation">[</span><span class="token class-name">macro</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token string">"null?"</span> <span class="token punctuation">[</span><span class="token class-name">macro</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> <span class="token string">"["</span> Exps <span class="token string">"|"</span> Exp <span class="token string">"]"</span>
  <span class="token keyword">syntax</span> Val <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">"["</span> Vals <span class="token string">"]"</span>                             <span class="token punctuation">[</span><span class="token class-name">klabel</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token keyword">syntax</span> Cons <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">"cons"</span>
  <span class="token keyword">syntax</span> Val <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Cons
  <span class="token keyword">syntax</span> Val <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Cons Val                                 <span class="token punctuation">[</span><span class="token class-name">klabel</span><span class="token punctuation">(</span>apply<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Data constructors start with capital letters and they may or may
not have arguments.  We need to use the attribute "prefer" to make
sure that, e.g., <code>Cons(a)</code> parses as constructor <code>Cons</code> with
argument <code>a</code>, and not as the expression <code>Cons</code> (because
constructor names are also expressions) regarded as a function applied
to the expression <code>a</code>.  Also, note that the constructor is strict
in its second argument, because we want to evaluate its arguments but
not the constuctor name itsef.</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> ConstructorName                         <span class="token punctuation">[</span><span class="token class-name">token</span><span class="token punctuation">]</span>
  <span class="token keyword">syntax</span> Exp <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> ConstructorName
               <span class="token operator">|</span> ConstructorName <span class="token string">"("</span> Exps <span class="token string">")"</span>    <span class="token punctuation">[</span><span class="token class-name">prefer</span><span class="token punctuation">,</span> <span class="token class-name">strict</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">klabel</span><span class="token punctuation">(</span>constructor<span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token keyword">syntax</span> Val <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> ConstructorName <span class="token string">"("</span> Vals <span class="token string">")"</span>    <span class="token punctuation">[</span><span class="token class-name">klabel</span><span class="token punctuation">(</span>constructor<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>A function is essentially a <code>|</code>-separated ordered
sequence of cases, each case of the form <code>pattern -&gt; expression</code>,
preceded by the language construct <code>fun</code>.  Patterns will be defined
shortly, both for the builtin lists and for user-defined constructors.
Recall that the syntax we define in <strong>K</strong> is not meant to serve as a
ultimate parser for the defined language, but rather as a convenient
notation for <strong>K</strong> abstract syntax trees, which we prefer when we write
the semantic rules.  It is therefore often the case that we define a
more ``generous'' syntax than we want to allow programs to use.
We do it here, too.  Specifically, the syntax of <code>Cases</code>
below allows any expressions to appear as pattern.  This syntactic
relaxation permits many wrong programs to be parsed, but that is not a
problem because we are not going to give semantics to wrong combinations,
so those programs will get stuck; moreover, our type inferencer will reject
those programs anyway.  Function application is just concatenation of
expressions, without worrying about type correctness.  Again, the type
system will reject type-incorrect programs.</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> Exp <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">"fun"</span> Cases
               <span class="token operator">|</span> Exp Exp                              <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> <span class="token class-name">left</span><span class="token punctuation">,</span> <span class="token class-name">klabel</span><span class="token punctuation">(</span>apply<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token comment">// NOTE: We would like eventually to also have Exp "(" Exps ")</span>
  <span class="token keyword">syntax</span> Case  <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Exp <span class="token string">"-&gt;"</span> Exp
  <span class="token keyword">syntax</span> Cases <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> List<span class="token punctuation">{</span>Case<span class="token punctuation">,</span> <span class="token string">"|"</span><span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>The <code>let</code> and <code>letrec</code> binders have the usual syntax
and functional meaning.  We allow multiple <code>and</code>-separated bindings.
Like for the function cases above, we allow a more generous syntax for
the left-hand sides of bindings, noting that the semantics will get stuck
on incorrect bindings and that the type system will reject those programs.</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> Exp <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">"let"</span> Bindings <span class="token string">"in"</span> Exp
               <span class="token operator">|</span> <span class="token string">"letrec"</span> Bindings <span class="token string">"in"</span> Exp                 <span class="token punctuation">[</span><span class="token class-name">prefer</span><span class="token punctuation">]</span>
<span class="token comment">// The "prefer" attribute for letrec currently needed due to tool bug,</span>
<span class="token comment">// to make sure that "letrec" is not parsed as "let rec".</span>
  <span class="token keyword">syntax</span> Binding  <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Exp <span class="token string">"="</span> Exp
  <span class="token keyword">syntax</span> Bindings <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> List<span class="token punctuation">{</span>Binding<span class="token punctuation">,</span><span class="token string">"and"</span><span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>References are first class values in FUN.  The construct <code>ref</code>
takes an expression, evaluates it, and then it stores the resulting value
at a fresh location in the store and returns that reference.  Syntactically,
<code>ref</code> is just an expression constant.  The construct <code>&amp;</code>
takes a name as argument and evaluates to a reference, namely the store
reference where the variable passed as argument stores its value; this
construct is a bit controversial and is further discussed in the
environment-based semantics of the FUN language, where we desugar
<code>ref</code> to it.  The construct <code>@</code> takes a reference
and evaluates to the value stored there.  The construct <code>:=</code> takes
two expressions, the first expected to evaluate to a reference; the value
of its second argument will be stored at the location to which the first
points (the old value is thus lost).  Finally, since expression evaluation
now has side effects, it makes sense to also add a sequential composition
construct, which is sequentially strict.  This evaluates to the value of
its second argument; the value of the first argument is lost (which has
therefore been evaluated only for its side effects.</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> Exp <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">"ref"</span>                             <span class="token punctuation">[</span><span class="token class-name">macro</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> <span class="token string">"&amp;"</span> Name
               <span class="token operator">|</span> <span class="token string">"@"</span> Exp                                     <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">":="</span> Exp                                <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">";"</span> Exp                       <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">right</span><span class="token punctuation">]</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Call-with-current-continuation, named <code>callcc</code> in FUN, is a
powerful control operator that originated in the Scheme programming
language, but it now exists in many other functional languages.  It works
by evaluating its argument, expected to evaluate to a function, and by
passing the current continuation, or evaluation context (or computation,
in <strong>K</strong> terminology), as a special value to it.  When/If this special value
is invoked, the current context is discarded and replaced with the one
held by the special value and the computation continues from there.
It is like taking a snapshot of the execution context at some moment
in time and then, when desired, being able to get back in time to that
point.  If you like games, it is like saving the game now (so you can
work on your homework!) and then continuing the game tomorrow or whenever
you wish.  To issustrate the strength of <code>callcc</code>, we also
allow exceptions in FUN by means of a conventional <code>try-catch</code>
construct, which will desugar to <code>callcc</code>.  We also need to
introduce the special expression contant <code>throw</code>, but we need to
use it as a function argument name in the desugaring macro, so we define
it as a name instead of as an expression constant:</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> Exp <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">"try"</span> Exp <span class="token string">"catch"</span> <span class="token string">"("</span> Name <span class="token string">")"</span> Exp <span class="token punctuation">[</span><span class="token class-name">macro</span><span class="token punctuation">]</span>
  <span class="token keyword">syntax</span> Val <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">"callcc"</span>
  <span class="token keyword">syntax</span> Name <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">"throw"</span> <span class="token punctuation">[</span><span class="token class-name">token</span><span class="token punctuation">]</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>Finally, FUN also allows polymorphic datatype declarations.  These
will be useful when we define the type system later on.</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> Exp <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">"datatype"</span> Type <span class="token string">"="</span> TypeCases Exp <span class="token punctuation">[</span><span class="token class-name">macro</span><span class="token punctuation">]</span>
<span class="token comment">// NOTE: In a future version of K, we want the datatype declaration</span>
<span class="token comment">// to be a construct by itself, but that is not possible currently</span>
<span class="token comment">// because K's parser wronly identifies the __ operation allowing</span>
<span class="token comment">// a declaration to appear in front of an expression with the function</span>
<span class="token comment">// application construct, giving ambiguous parsing errors.</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>We next need to define the syntax of types and type cases that appear
in datatype declarations.</p>
<p>Like in many functional languages, type parameters/variables in
user-defined types are quoted identifiers.</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> TypeVar                        <span class="token punctuation">[</span><span class="token class-name">token</span><span class="token punctuation">]</span>
  <span class="token keyword">syntax</span> TypeVars <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> List<span class="token punctuation">{</span>TypeVar<span class="token punctuation">,</span><span class="token string">","</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>overload<span class="token punctuation">(</span>types<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>Types can be basic types, function types, or user-defined
parametric types.  In the dynamic semantics we are going to simply ignore
all the type declations, so here the syntax of types below is only useful
for generating the desired parser.  To avoid syntactic ambiguities with
the arrow construct for function cases, we use the symbol <code>--&gt;</code> as
a constructor for function types:</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> TypeName <span class="token punctuation">[</span><span class="token class-name">token</span><span class="token punctuation">]</span>
  <span class="token keyword">syntax</span> Type <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">"int"</span> <span class="token operator">|</span> <span class="token string">"bool"</span> <span class="token operator">|</span> <span class="token string">"string"</span>
                <span class="token operator">|</span> Type <span class="token string">"--&gt;"</span> Type                            <span class="token punctuation">[</span><span class="token class-name">right</span><span class="token punctuation">]</span>
                <span class="token operator">|</span> <span class="token string">"("</span> Type <span class="token string">")"</span>                             <span class="token punctuation">[</span><span class="token class-name">bracket</span><span class="token punctuation">]</span>
                <span class="token operator">|</span> TypeVar
                <span class="token operator">|</span> TypeName             <span class="token punctuation">[</span><span class="token class-name">symbol</span><span class="token punctuation">(</span>TypeName<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">avoid</span><span class="token punctuation">]</span>
                <span class="token operator">|</span> Type TypeName   <span class="token punctuation">[</span><span class="token class-name">symbol</span><span class="token punctuation">(</span>Type<span class="token operator">-</span>TypeName<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">macro</span><span class="token punctuation">]</span>
                <span class="token operator">|</span> <span class="token string">"("</span> Types <span class="token string">")"</span> TypeName                    <span class="token punctuation">[</span><span class="token class-name">prefer</span><span class="token punctuation">]</span>
  <span class="token keyword">syntax</span> Types <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> List<span class="token punctuation">{</span>Type<span class="token punctuation">,</span><span class="token string">","</span><span class="token punctuation">}</span> <span class="token punctuation">[</span>overload<span class="token punctuation">(</span>types<span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token keyword">syntax</span> Types <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> TypeVars

  <span class="token keyword">syntax</span> TypeCase <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> ConstructorName
                    <span class="token operator">|</span> ConstructorName <span class="token string">"("</span> Types <span class="token string">")"</span>
  <span class="token keyword">syntax</span> TypeCases <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> List<span class="token punctuation">{</span>TypeCase<span class="token punctuation">,</span><span class="token string">"|"</span><span class="token punctuation">}</span>     <span class="token punctuation">[</span><span class="token class-name">symbol</span><span class="token punctuation">(</span>_<span class="token operator">|</span>TypeCase_<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="additional-priorities">Additional Priorities</h2>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax priority</span> @__FUN<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>COMMON
                &gt; apply
                &gt; arith
                &gt; _<span class="token punctuation">:</span><span class="token operator">=</span>__FUN<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>COMMON
                &gt; let_in__FUN<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>COMMON
                  letrec_in__FUN<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>COMMON
                  if_then_else__FUN<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>COMMON
                &gt; _<span class="token punctuation">;</span>__FUN<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>COMMON
                &gt; fun__FUN<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>COMMON
                &gt; datatype_<span class="token operator">=</span>___FUN<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>COMMON
<span class="token keyword">endmodule</span>

<span class="token keyword">module</span> FUN<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>MACROS
  <span class="token keyword">imports</span> FUN<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>COMMON
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="desugaring-macros">Desugaring macros</h2>
<p>We desugar the list non-constructor operations to functions matching
over list patterns.  In order to do that we need some new variables; for
those, we follow the same convention like in the <strong>K</strong> tutorial, where we
added them as new identifier constructs starting with the character <code>$</code>,
so we can easily recognize them when we debug or trace the semantics.</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> Name <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">"$h"</span> <span class="token punctuation">[</span><span class="token class-name">token</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token string">"$t"</span> <span class="token punctuation">[</span><span class="token class-name">token</span><span class="token punctuation">]</span>
  <span class="token keyword">rule</span> head <span class="token operator">=&gt;</span> fun <span class="token punctuation">[</span>$h<span class="token operator">|</span>$t<span class="token punctuation">]</span> <span class="token operator">-</span>&gt; $h
  <span class="token keyword">rule</span> tail <span class="token operator">=&gt;</span> fun <span class="token punctuation">[</span>$h<span class="token operator">|</span>$t<span class="token punctuation">]</span> <span class="token operator">-</span>&gt; $t
  <span class="token keyword">rule</span> null<span class="token operator">?</span> <span class="token operator">=&gt;</span> fun <span class="token punctuation">[</span><span class="token punctuation">.</span>Exps<span class="token punctuation">]</span> <span class="token operator">-</span>&gt; <span class="token boolean">true</span> <span class="token operator">|</span> <span class="token punctuation">[</span>$h<span class="token operator">|</span>$t<span class="token punctuation">]</span> <span class="token operator">-</span>&gt; <span class="token boolean">false</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>Multiple-head list patterns desugar into successive one-head patterns:</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">rule</span> <span class="token punctuation">[</span>E1<span class="token punctuation">,</span>E2<span class="token punctuation">,</span>Es<span class="token punctuation">:</span>Exps<span class="token operator">|</span>T<span class="token punctuation">]</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>E1<span class="token operator">|</span><span class="token punctuation">[</span>E2<span class="token punctuation">,</span>Es<span class="token operator">|</span>T<span class="token punctuation">]</span><span class="token punctuation">]</span>                   <span class="token punctuation">[</span>anywhere<span class="token punctuation">]</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Uncurrying of multiple arguments in functions and binders:</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">rule</span> P1 P2 <span class="token operator">-</span>&gt; E <span class="token operator">=&gt;</span> P1 <span class="token operator">-</span>&gt; fun P2 <span class="token operator">-</span>&gt; E                       <span class="token punctuation">[</span>anywhere<span class="token punctuation">]</span>
  <span class="token keyword">rule</span> F P <span class="token operator">=</span> E <span class="token operator">=&gt;</span> F <span class="token operator">=</span> fun P <span class="token operator">-</span>&gt; E                             <span class="token punctuation">[</span>anywhere<span class="token punctuation">]</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>We desugar the <code>try-catch</code> construct into callcc:</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> Name <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">"$k"</span> <span class="token punctuation">[</span><span class="token class-name">token</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token string">"$v"</span> <span class="token punctuation">[</span><span class="token class-name">token</span><span class="token punctuation">]</span>
  <span class="token keyword">rule</span> try E catch<span class="token punctuation">(</span>X<span class="token punctuation">)</span> E'
    <span class="token operator">=&gt;</span> callcc <span class="token punctuation">(</span>fun $k <span class="token operator">-</span>&gt; <span class="token punctuation">(</span>fun throw <span class="token operator">-</span>&gt; E<span class="token punctuation">)</span><span class="token punctuation">(</span>fun X <span class="token operator">-</span>&gt; $k E'<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>For uniformity, we reduce all types to their general form:</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">rule</span> `Type<span class="token operator">-</span>TypeName`<span class="token punctuation">(</span>T<span class="token punctuation">:</span>Type<span class="token punctuation">,</span> Tn<span class="token punctuation">:</span>TypeName<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span> Tn
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>The dynamic semantics ignores all the type declarations:</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">rule</span> datatype _T <span class="token operator">=</span> _TCs E <span class="token operator">=&gt;</span> E

<span class="token keyword">endmodule</span>


<span class="token keyword">module</span> FUN<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>SYNTAX
  <span class="token keyword">imports</span> FUN<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>COMMON
  <span class="token keyword">imports</span> BUILTIN<span class="token operator">-</span>ID<span class="token operator">-</span>TOKENS

  <span class="token keyword">syntax</span> Name <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> r<span class="token string">"[a-z][_a-zA-Z0-9]*"</span>           <span class="token punctuation">[</span><span class="token class-name">token</span><span class="token punctuation">,</span> prec<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
                <span class="token operator">|</span> #LowerId                        <span class="token punctuation">[</span><span class="token class-name">token</span><span class="token punctuation">]</span>
  <span class="token keyword">syntax</span> ConstructorName <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #UpperId             <span class="token punctuation">[</span><span class="token class-name">token</span><span class="token punctuation">]</span>
  <span class="token keyword">syntax</span> TypeVar  <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> r<span class="token string">"['][a-z][_a-zA-Z0-9]*"</span>    <span class="token punctuation">[</span><span class="token class-name">token</span><span class="token punctuation">]</span>
  <span class="token keyword">syntax</span> TypeName <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Name                        <span class="token punctuation">[</span><span class="token class-name">token</span><span class="token punctuation">]</span>
<span class="token keyword">endmodule</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="semantics">Semantics</h2>
<p>The semantics below is environment-based.  A substitution-based
definition of FUN is also available, but that drops the <code>&amp;</code>
construct as explained above.</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k"><span class="token keyword">module</span> FUN<span class="token operator">-</span>UNTYPED
  <span class="token keyword">imports</span> FUN<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>COMMON
  <span class="token keyword">imports</span> FUN<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>MACROS
  <span class="token keyword">imports</span> DOMAINS
  <span class="token comment">//imports PATTERN-MATCHING</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="configuration">Configuration</h2>
<p>The <code>k</code>, <code>env</code>, and <code>store</code> cells are standard
(see, for example, the definition of LAMBDA++ or IMP++ in the first
part of the <strong>K</strong> tutorial).</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">configuration</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>T</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>yellow<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>green<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> $PGM<span class="token punctuation">:</span>Exp <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>violet<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span>Map <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env</span><span class="token punctuation">&gt;</span></span>
                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>store</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>white<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span>Map <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>store</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>T</span><span class="token punctuation">&gt;</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="values-and-results">Values and results</h2>
<p>We only define integers, Booleans and strings as values here, but will
add more values later.</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> Val <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token keyword">Int</span> <span class="token operator">|</span> <span class="token keyword">Bool</span> <span class="token operator">|</span> <span class="token keyword">String</span>
  <span class="token keyword">syntax</span> Val <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Bottom
  <span class="token keyword">syntax</span> Vals <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Bottoms
  <span class="token keyword">syntax</span> KResult <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Val
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="lookup">Lookup</h2>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> X<span class="token punctuation">:</span>Name <span class="token operator">=&gt;</span> V <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> X <span class="token operator">|</span><span class="token operator">-</span>&gt; L <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>store</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> L <span class="token operator">|</span><span class="token operator">-</span>&gt; V <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>store</span><span class="token punctuation">&gt;</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="arithmetic-expressions">Arithmetic expressions</h2>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">rule</span> I1 <span class="token operator">*</span> I2 <span class="token operator">=&gt;</span> I1 <span class="token operator">*</span><span class="token keyword">Int</span> I2
  <span class="token keyword">rule</span> I1 <span class="token operator">/</span> I2 <span class="token operator">=&gt;</span> I1 <span class="token operator">/</span><span class="token keyword">Int</span> I2 <span class="token keyword">requires</span> I2 <span class="token operator">=</span><span class="token operator">/</span><span class="token operator">=</span>K <span class="token number">0</span>
  <span class="token keyword">rule</span> I1 <span class="token operator">%</span> I2 <span class="token operator">=&gt;</span> I1 <span class="token operator">%</span><span class="token keyword">Int</span> I2 <span class="token keyword">requires</span> I2 <span class="token operator">=</span><span class="token operator">/</span><span class="token operator">=</span>K <span class="token number">0</span>
  <span class="token keyword">rule</span> I1 <span class="token operator">+</span> I2 <span class="token operator">=&gt;</span> I1 <span class="token operator">+</span><span class="token keyword">Int</span> I2
  <span class="token keyword">rule</span> S1 <span class="token operator">^</span> S2 <span class="token operator">=&gt;</span> S1 <span class="token operator">+</span><span class="token keyword">String</span> S2
  <span class="token keyword">rule</span> I1 <span class="token operator">-</span> I2 <span class="token operator">=&gt;</span> I1 <span class="token operator">-</span><span class="token keyword">Int</span> I2
  <span class="token keyword">rule</span> <span class="token operator">-</span> I <span class="token operator">=&gt;</span> <span class="token number">0</span> <span class="token operator">-</span><span class="token keyword">Int</span> I
  <span class="token keyword">rule</span> I1 &lt; I2 <span class="token operator">=&gt;</span> I1 &lt;<span class="token keyword">Int</span> I2
  <span class="token keyword">rule</span> I1 <span class="token operator">&lt;=</span> I2 <span class="token operator">=&gt;</span> I1 <span class="token operator">&lt;=</span><span class="token keyword">Int</span> I2
  <span class="token keyword">rule</span> I1 &gt; I2 <span class="token operator">=&gt;</span> I1 &gt;<span class="token keyword">Int</span> I2
  <span class="token keyword">rule</span> I1 <span class="token operator">&gt;=</span> I2 <span class="token operator">=&gt;</span> I1 <span class="token operator">&gt;=</span><span class="token keyword">Int</span> I2
  <span class="token keyword">rule</span> V1<span class="token punctuation">:</span>Val <span class="token operator">==</span> V2<span class="token punctuation">:</span>Val <span class="token operator">=&gt;</span> V1 <span class="token operator">==</span>K V2
  <span class="token keyword">rule</span> V1<span class="token punctuation">:</span>Val <span class="token operator">!=</span> V2<span class="token punctuation">:</span>Val <span class="token operator">=&gt;</span> V1 <span class="token operator">=</span><span class="token operator">/</span><span class="token operator">=</span>K V2
  <span class="token keyword">rule</span> <span class="token operator">!</span> T <span class="token operator">=&gt;</span> notBool<span class="token punctuation">(</span>T<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> <span class="token boolean">true</span>  <span class="token operator">&amp;&amp;</span> E <span class="token operator">=&gt;</span> E
  <span class="token keyword">rule</span> <span class="token boolean">false</span> <span class="token operator">&amp;&amp;</span> _ <span class="token operator">=&gt;</span> <span class="token boolean">false</span>
  <span class="token keyword">rule</span> <span class="token boolean">true</span>  <span class="token operator">||</span> _ <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> <span class="token boolean">false</span> <span class="token operator">||</span> E <span class="token operator">=&gt;</span> E
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="conditional">Conditional</h2>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">rule</span> if  <span class="token boolean">true</span> then E else _ <span class="token operator">=&gt;</span> E
  <span class="token keyword">rule</span> if <span class="token boolean">false</span> then _ else E <span class="token operator">=&gt;</span> E
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="lists">Lists</h2>
<p>We have already declared the syntactic list of expressions strict, so
we can assume that all the elements that appear in a FUN list are
evaluated.  The only thing left to do is to state that a list of
values is a value itself, that is, that the list square-bracket
construct is indeed a constructor, and to give the semantics of
<code>cons</code>.  Since <code>cons</code> is a builtin function and is
expected to take two arguments, we have to also state that
<code>cons</code> itself is a value (specifically, a function/closure
value, but we do not need that level of detail here), and also that
<code>cons</code> applied to a value is a value (specifically, it would be
a function/closure value that expects the second, list argument):</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">rule</span> cons V<span class="token punctuation">:</span>Val <span class="token punctuation">[</span>Vs<span class="token punctuation">:</span>Vals<span class="token punctuation">]</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>V<span class="token punctuation">,</span>Vs<span class="token punctuation">]</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="data-constructors">Data Constructors</h2>
<p>Constructors take values as arguments and produce other values:</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> Val <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> ConstructorName
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="functions-and-closures">Functions and Closures</h2>
<p>Like in the environment-based semantics of LAMBDA++ in the first part
of the <strong>K</strong> tutorial, functions evaluate to closures.  A closure includes
the current environment besides the function contents; the environment
will be used at execution time to lookup all the variables that appear
free in the function body (we want static scoping in FUN).</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> Val <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> closure<span class="token punctuation">(</span>Map<span class="token punctuation">,</span>Cases<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> fun Cases <span class="token operator">=&gt;</span> closure<span class="token punctuation">(</span>Rho<span class="token punctuation">,</span>Cases<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env</span><span class="token punctuation">&gt;</span></span> Rho <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env</span><span class="token punctuation">&gt;</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><strong>Note:</strong> The reader may want to get familiar with
how the pre-defined pattern matching works before proceeding.
The best way to do that is to consult
<code>k/include/modules/pattern-matching.k</code>.</p>
<!--- To set up the pattern matching mechanism we need to specify what K
terms act as variables (for pattern matching, substitution, etc.).
This is currently done my subsorting those terms to the builtin
`Variable` sort.  In our case, we only want to allow the
`Name` identifiers to act as variables for pattern matching;
note that the `ConstructorName` identifiers are `not`
variables (they construct data values):

  syntax KVariable ::= Name
--->
<p>We distinguish two cases when the closure is applied.
If the first pattern matches, then we pick the first case: switch to
the closed environment, get the matching map and bind all its
variables, and finally evaluate the function body of the first case,
making sure that the environment is properly recovered afterwards.
If the first pattern does not match, then we drop it and thus move on
to the next one.</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">rule</span> <span class="token punctuation">(</span><span class="token punctuation">.</span>K <span class="token operator">=&gt;</span> getMatching<span class="token punctuation">(</span>P<span class="token punctuation">,</span> V<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">~&gt;</span> closure<span class="token punctuation">(</span>_<span class="token punctuation">,</span> P<span class="token operator">-</span>&gt;_ <span class="token operator">|</span> _<span class="token punctuation">)</span> V<span class="token punctuation">:</span>Val
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> matchResult<span class="token punctuation">(</span>M<span class="token punctuation">:</span>Map<span class="token punctuation">)</span> <span class="token operator">~&gt;</span> closure<span class="token punctuation">(</span>Rho<span class="token punctuation">,</span> _<span class="token operator">-</span>&gt;E <span class="token operator">|</span> _<span class="token punctuation">)</span> _
           <span class="token operator">=&gt;</span> bindMap<span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token operator">~&gt;</span> E <span class="token operator">~&gt;</span> setEnv<span class="token punctuation">(</span>Rho'<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env</span><span class="token punctuation">&gt;</span></span> Rho' <span class="token operator">=&gt;</span> Rho <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token punctuation">(</span>matchFailure <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K<span class="token punctuation">)</span> <span class="token operator">~&gt;</span> closure<span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token punctuation">(</span>_<span class="token operator">-</span>&gt;_ <span class="token operator">|</span> Cs<span class="token punctuation">:</span>Cases <span class="token operator">=&gt;</span> Cs<span class="token punctuation">)</span><span class="token punctuation">)</span> _
<span class="token comment">//  rule &lt;k&gt; closure(Rho, P-&gt;E | _) V:Val</span>
<span class="token comment">//           =&gt; bindMap(getMatching(P,V)) ~&gt; E ~&gt; setEnv(Rho') ...&lt;/k&gt;</span>
<span class="token comment">//       &lt;env&gt; Rho' =&gt; Rho &lt;/env&gt;  requires isMatching(P,V)</span>
<span class="token comment">//  rule closure(_, (P-&gt;_ | Cs:Cases =&gt; Cs)) V:Val  requires notBool isMatching(P,V)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="let-and-letrec">Let and Letrec</h2>
<p>To highlight the similarities and differences between <code>let</code> and
<code>letrec</code>, we prefer to give them direct semantics instead of
to desugar them like in LAMBDA.  See the formal definitions of
<code>bindTo</code>, <code>bind</code>, and <code>assignTo</code> at the end of
this module.  Informally, <code>bindTo(Xs, Es)</code> first
evaluates the expressions <code>Es</code> in <code>Exps</code> in the current
environment (i.e., it is strict in its second argument), then it binds
the variables in <code>Xs</code> in <code>Names</code> to new locations and adds
those bindings to the environment, and finally writes the values
previously obtained after evaluating the expressions <code>Es</code> to those
new locations; <code>bind(Xs)</code> does only the bindings of
<code>Xs</code> to new locations and adds those bindings to the environment;
and <code>assignTo(Xs,Es)</code> evaluates the expressions
<code>Es</code> in the current environment and then it writes the resulting
values to the locations to which the variables <code>Xs</code> are already
bound to in the environment.</p>
<p>Therefore, <code>let Xs = Es in E</code> first
evaluates <code>Es</code> in the current environment, then adds new
bindings for <code>Xs</code> to fresh locations in the environment, then
writes the values of <code>Es</code> to those locations, and finally
evaluates <code>E</code> in the new environment, making sure that the
environment is properly recovered after the evaluation of <code>E</code>.
On the other hand, <code>letrec</code> does the same things but in a
different order: it first adds new bindings for <code>Xs</code> to fresh
locations in the environment, then it evaluates <code>Es</code> in the new
environment, then it writes the resulting values to their
corresponding locations, and finally it evaluates <code>E</code> and
recovers the environment.  The crucial difference is that the
expressions <code>Es</code> now see the locations of the variables <code>Xs</code>
in the environment, so if they are functions, which is typically the
case with <code>letrec</code>, their closures will encapsulate in their
environments the bindings of all the bound variables, including
themselves (thus, we may have a closure value stored at location
<code>L</code>, whose environment contains a binding of the form
<code>F ↦ L</code>; this way, the closure can invoke
itself).</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> let Bs in E
        <span class="token operator">=&gt;</span> bindTo<span class="token punctuation">(</span>names<span class="token punctuation">(</span>Bs<span class="token punctuation">)</span><span class="token punctuation">,</span>exps<span class="token punctuation">(</span>Bs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">~&gt;</span> E <span class="token operator">~&gt;</span> setEnv<span class="token punctuation">(</span>Rho<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env</span><span class="token punctuation">&gt;</span></span> Rho <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> letrec Bs in E
        <span class="token operator">=&gt;</span> bind<span class="token punctuation">(</span>names<span class="token punctuation">(</span>Bs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">~&gt;</span>assignTo<span class="token punctuation">(</span>names<span class="token punctuation">(</span>Bs<span class="token punctuation">)</span><span class="token punctuation">,</span>exps<span class="token punctuation">(</span>Bs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">~&gt;</span>E<span class="token operator">~&gt;</span>setEnv<span class="token punctuation">(</span>Rho<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env</span><span class="token punctuation">&gt;</span></span> Rho <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env</span><span class="token punctuation">&gt;</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Recall that our syntax allows <code>let</code> and <code>letrec</code> to
take any expression in place of its binding.  This allows us to use
the already existing function application construct to bind names to
functions, such as, e.g., <code>let x y = y in ...</code>.
The desugaring macro in the syntax module uncurries such declarations,
and then the semantic rules above only work when the remaining
bindings are identifiers, so the semantics will get stuck on programs
that misuse the <code>let</code> and <code>letrec</code> binders.</p>
<h2 id="references">References</h2>
<p>The semantics of references is self-explanatory, except maybe for the
desugaring rule of <code>ref</code>, which is further discussed.  Note
that <code>&amp;X</code> grabs the location of <code>X</code> from the environment.
Sequential composition, which is needed only to accumulate the
side effects due to assignments, was strict in the first argument.
Once evaluated, its first argument is simply discarded:</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> Name <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">"$x"</span> <span class="token punctuation">[</span><span class="token class-name">token</span><span class="token punctuation">]</span>
  <span class="token keyword">rule</span> ref <span class="token operator">=&gt;</span> fun $x <span class="token operator">-</span>&gt; <span class="token operator">&amp;</span> $x
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token operator">&amp;</span> X <span class="token operator">=&gt;</span> L <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> X <span class="token operator">|</span><span class="token operator">-</span>&gt; L <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> @ L<span class="token punctuation">:</span><span class="token keyword">Int</span> <span class="token operator">=&gt;</span> V<span class="token punctuation">:</span>Val <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>store</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> L <span class="token operator">|</span><span class="token operator">-</span>&gt; V <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>store</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> L<span class="token punctuation">:</span><span class="token keyword">Int</span> <span class="token punctuation">:</span><span class="token operator">=</span> V<span class="token punctuation">:</span>Val <span class="token operator">=&gt;</span> V <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>store</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> L <span class="token operator">|</span><span class="token operator">-</span>&gt; <span class="token punctuation">(</span>_<span class="token operator">=&gt;</span>V<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>store</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> _V<span class="token punctuation">:</span>Val<span class="token punctuation">;</span> E <span class="token operator">=&gt;</span> E
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>The desugaring rule of <code>ref</code> (first rule above) works
because <code>&amp;</code> takes a variable and returns its location (like in C).
Note that some ``pure'' functional programming researchers strongly dislike
the <code>&amp;</code> construct, but favor <code>ref</code>.  We refrain from having
a personal opinion on this issue here, but support <code>&amp;</code> in the
environment-based definition of FUN because it is, technically speaking,
more powerful than <code>ref</code>.  From a language design perspective, it
would be equally easy to drop <code>&amp;</code> and instead give a direct
semantics to <code>ref</code>.  In fact, this is precisely what we do in the
substitution-based definition of FUN, because there appears to be no way
to give a substitution-based definition to the <code>&amp;</code> construct.</p>
<h2 id="callcc">Callcc</h2>
<p>As we know it from the LAMBDA++ tutorial, call-with-current-continuation
is quite easy to define in <strong>K</strong>.  We first need to define a special
value wrapping an execution context, that is, an environment saying
where the variables should be looked up, and a computation structure
saying what is left to execute (in a substitution-based definition,
this special value would be even simpler, as it would only need to
wrap the computation structure---see, for example, the
substitution-based semantics of LAMBDA++ in the the first part of the
<strong>K</strong> tutorial, or the substitution-based definition of FUN).  Then
<code>callcc</code> creates such a value containing the current
environment and the current remaining computation, and passes it to
its argument function.  When/If invoked, the special value replaces
the current execution context with its own and continues the execution
normally.</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> Val <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> cc<span class="token punctuation">(</span>Map<span class="token punctuation">,</span>K<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span>callcc V<span class="token punctuation">:</span>Val <span class="token operator">=&gt;</span> V cc<span class="token punctuation">(</span>Rho<span class="token punctuation">,</span>K<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">~&gt;</span> K <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env</span><span class="token punctuation">&gt;</span></span> Rho <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> cc<span class="token punctuation">(</span>Rho<span class="token punctuation">,</span>K<span class="token punctuation">)</span> V<span class="token punctuation">:</span>Val <span class="token operator">~&gt;</span> _ <span class="token operator">=&gt;</span> V <span class="token operator">~&gt;</span> K <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env</span><span class="token punctuation">&gt;</span></span> _ <span class="token operator">=&gt;</span> Rho <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env</span><span class="token punctuation">&gt;</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="auxiliary-operations">Auxiliary operations</h2>
<h2 id="environment-recovery">Environment recovery</h2>
<p>The environment recovery operation is the same as for the LAMBDA++
language in the <strong>K</strong> tutorial and many other languages provided with the
<strong>K</strong> distribution.  The first ``anywhere'' rule below shows an elegant
way to achieve the benefits of tail recursion in <strong>K</strong>.</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> setEnv<span class="token punctuation">(</span>Map<span class="token punctuation">)</span>  <span class="token comment">// TODO: get rid of env</span>
  <span class="token comment">//rule (setEnv(_) =&gt; .) ~&gt; setEnv(_)  [anywhere]</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> _<span class="token punctuation">:</span>Val <span class="token operator">~&gt;</span> <span class="token punctuation">(</span>setEnv<span class="token punctuation">(</span>Rho<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env</span><span class="token punctuation">&gt;</span></span> _ <span class="token operator">=&gt;</span> Rho <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env</span><span class="token punctuation">&gt;</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="bindto%2C-bind-and-assignto"><code>bindTo</code>, <code>bind</code> and <code>assignTo</code></h2>
<p>The meaning of these operations has already been explained when we
discussed the <code>let</code> and <code>letrec</code> language constructs
above.</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> bindTo<span class="token punctuation">(</span>Names<span class="token punctuation">,</span>Exps<span class="token punctuation">)</span>         <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
                 <span class="token operator">|</span> bindMap<span class="token punctuation">(</span>Map<span class="token punctuation">)</span>
                 <span class="token operator">|</span> bind<span class="token punctuation">(</span>Names<span class="token punctuation">)</span>

  <span class="token keyword">rule</span> <span class="token punctuation">(</span><span class="token punctuation">.</span>K <span class="token operator">=&gt;</span> getMatchingAux<span class="token punctuation">(</span>Xs<span class="token punctuation">,</span>Vs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">~&gt;</span> bindTo<span class="token punctuation">(</span>Xs<span class="token punctuation">:</span>Names<span class="token punctuation">,</span>Vs<span class="token punctuation">:</span>Vals<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> matchResult<span class="token punctuation">(</span>M<span class="token punctuation">:</span>Map<span class="token punctuation">)</span> <span class="token operator">~&gt;</span> bindTo<span class="token punctuation">(</span>_<span class="token punctuation">:</span>Names<span class="token punctuation">,</span> _<span class="token punctuation">:</span>Vals<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> bindMap<span class="token punctuation">(</span>M<span class="token punctuation">)</span>

  <span class="token keyword">rule</span> bindMap<span class="token punctuation">(</span><span class="token punctuation">.</span>Map<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> bindMap<span class="token punctuation">(</span><span class="token punctuation">(</span>X<span class="token punctuation">:</span>Name <span class="token operator">|</span><span class="token operator">-</span>&gt; V<span class="token punctuation">:</span>Val <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>Map<span class="token punctuation">)</span> _<span class="token punctuation">:</span>Map<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env</span><span class="token punctuation">&gt;</span></span> Rho <span class="token operator">=&gt;</span> Rho<span class="token punctuation">[</span>X &lt;<span class="token operator">-</span> <span class="token operator">!</span>L<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">]</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>store</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span>Map <span class="token operator">=&gt;</span> <span class="token operator">!</span>L <span class="token operator">|</span><span class="token operator">-</span>&gt; V <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>store</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> bind<span class="token punctuation">(</span><span class="token punctuation">.</span>Names<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> bind<span class="token punctuation">(</span>X<span class="token punctuation">:</span>Name<span class="token punctuation">,</span>Xs <span class="token operator">=&gt;</span> Xs<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env</span><span class="token punctuation">&gt;</span></span> Rho <span class="token operator">=&gt;</span> Rho<span class="token punctuation">[</span>X &lt;<span class="token operator">-</span> <span class="token operator">!</span>_L<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">]</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> assignTo<span class="token punctuation">(</span>Names<span class="token punctuation">,</span>Exps<span class="token punctuation">)</span>  <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> assignTo<span class="token punctuation">(</span><span class="token punctuation">.</span>Names<span class="token punctuation">,</span><span class="token punctuation">.</span>Vals<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> assignTo<span class="token punctuation">(</span><span class="token punctuation">(</span>X<span class="token punctuation">:</span>Name<span class="token punctuation">,</span>Xs <span class="token operator">=&gt;</span> Xs<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>V<span class="token punctuation">:</span>Val<span class="token punctuation">,</span>Vs<span class="token punctuation">:</span>Vals <span class="token operator">=&gt;</span> Vs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>env</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> X <span class="token operator">|</span><span class="token operator">-</span>&gt; L <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>env</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>store</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span>Map <span class="token operator">=&gt;</span> L <span class="token operator">|</span><span class="token operator">-</span>&gt; V <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>store</span><span class="token punctuation">&gt;</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="getters">Getters</h2>
<p>The following auxiliary operations extract the list of identifiers
and of expressions in a binding, respectively.</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">syntax</span> Names <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> names<span class="token punctuation">(</span>Bindings<span class="token punctuation">)</span>  <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
  <span class="token keyword">rule</span> names<span class="token punctuation">(</span><span class="token punctuation">.</span>Bindings<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>Names
  <span class="token keyword">rule</span> names<span class="token punctuation">(</span>X<span class="token punctuation">:</span>Name<span class="token operator">=</span>_ and Bs<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>X<span class="token punctuation">,</span>names<span class="token punctuation">(</span>Bs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">:</span>Names

  <span class="token keyword">syntax</span> Exps <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> exps<span class="token punctuation">(</span>Bindings<span class="token punctuation">)</span>  <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
  <span class="token keyword">rule</span> exps<span class="token punctuation">(</span><span class="token punctuation">.</span>Bindings<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>Exps
  <span class="token keyword">rule</span> exps<span class="token punctuation">(</span>_<span class="token punctuation">:</span>Name<span class="token operator">=</span>E and Bs<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> E<span class="token punctuation">,</span>exps<span class="token punctuation">(</span>Bs<span class="token punctuation">)</span>

  <span class="token comment">/* Extra kore stuff */</span>
  <span class="token keyword">syntax</span> KResult <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Vals
  <span class="token keyword">syntax</span> Exps <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Names
  <span class="token keyword">syntax</span> Names <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Bottoms

  <span class="token comment">/* Matching */</span>
  <span class="token keyword">syntax</span> MatchResult <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> getMatching<span class="token punctuation">(</span>Exp<span class="token punctuation">,</span> Val<span class="token punctuation">)</span>                      <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
                       <span class="token operator">|</span> getMatchingAux<span class="token punctuation">(</span>Exps<span class="token punctuation">,</span> Vals<span class="token punctuation">)</span>                 <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
                       <span class="token operator">|</span> mergeMatching<span class="token punctuation">(</span>MatchResult<span class="token punctuation">,</span> MatchResult<span class="token punctuation">)</span>    <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
                       <span class="token operator">|</span> matchResult<span class="token punctuation">(</span>Map<span class="token punctuation">)</span>
                       <span class="token operator">|</span> <span class="token string">"matchFailure"</span>

  <span class="token keyword">rule</span> getMatching<span class="token punctuation">(</span>C<span class="token punctuation">:</span>ConstructorName<span class="token punctuation">(</span>Es<span class="token punctuation">:</span>Exps<span class="token punctuation">)</span><span class="token punctuation">,</span> C<span class="token punctuation">(</span>Vs<span class="token punctuation">:</span>Vals<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> getMatchingAux<span class="token punctuation">(</span>Es<span class="token punctuation">,</span> Vs<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> getMatching<span class="token punctuation">(</span><span class="token punctuation">[</span>Es<span class="token punctuation">:</span>Exps<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>Vs<span class="token punctuation">:</span>Vals<span class="token punctuation">]</span><span class="token punctuation">)</span>                   <span class="token operator">=&gt;</span> getMatchingAux<span class="token punctuation">(</span>Es<span class="token punctuation">,</span> Vs<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> getMatching<span class="token punctuation">(</span>C<span class="token punctuation">:</span>ConstructorName<span class="token punctuation">,</span> C<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> matchResult<span class="token punctuation">(</span><span class="token punctuation">.</span>Map<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> getMatching<span class="token punctuation">(</span>B<span class="token punctuation">:</span><span class="token keyword">Bool</span><span class="token punctuation">,</span> B<span class="token punctuation">)</span>            <span class="token operator">=&gt;</span> matchResult<span class="token punctuation">(</span><span class="token punctuation">.</span>Map<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> getMatching<span class="token punctuation">(</span>I<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">,</span> I<span class="token punctuation">)</span>             <span class="token operator">=&gt;</span> matchResult<span class="token punctuation">(</span><span class="token punctuation">.</span>Map<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> getMatching<span class="token punctuation">(</span>S<span class="token punctuation">:</span><span class="token keyword">String</span><span class="token punctuation">,</span> S<span class="token punctuation">)</span>          <span class="token operator">=&gt;</span> matchResult<span class="token punctuation">(</span><span class="token punctuation">.</span>Map<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> getMatching<span class="token punctuation">(</span>N<span class="token punctuation">:</span>Name<span class="token punctuation">,</span> V<span class="token punctuation">:</span>Val<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> matchResult<span class="token punctuation">(</span>N <span class="token operator">|</span><span class="token operator">-</span>&gt; V<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> getMatching<span class="token punctuation">(</span>_<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> matchFailure        <span class="token punctuation">[</span>owise<span class="token punctuation">]</span>

  <span class="token keyword">rule</span> getMatchingAux<span class="token punctuation">(</span><span class="token punctuation">(</span>E<span class="token punctuation">:</span>Exp<span class="token punctuation">,</span> Es<span class="token punctuation">:</span>Exps<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>V<span class="token punctuation">:</span>Val<span class="token punctuation">,</span> Vs<span class="token punctuation">:</span>Vals<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> mergeMatching<span class="token punctuation">(</span>getMatching<span class="token punctuation">(</span>E<span class="token punctuation">,</span> V<span class="token punctuation">)</span><span class="token punctuation">,</span> getMatchingAux<span class="token punctuation">(</span>Es<span class="token punctuation">,</span> Vs<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">rule</span> getMatchingAux<span class="token punctuation">(</span><span class="token punctuation">.</span>Exps<span class="token punctuation">,</span> <span class="token punctuation">.</span>Vals<span class="token punctuation">)</span>                       <span class="token operator">=&gt;</span> matchResult<span class="token punctuation">(</span><span class="token punctuation">.</span>Map<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> getMatchingAux<span class="token punctuation">(</span>_<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> matchFailure     <span class="token punctuation">[</span>owise<span class="token punctuation">]</span>

  <span class="token keyword">rule</span> mergeMatching<span class="token punctuation">(</span>matchResult<span class="token punctuation">(</span>M1<span class="token punctuation">:</span>Map<span class="token punctuation">)</span><span class="token punctuation">,</span> matchResult<span class="token punctuation">(</span>M2<span class="token punctuation">:</span>Map<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> matchResult<span class="token punctuation">(</span>M1 M2<span class="token punctuation">)</span>
    <span class="token keyword">requires</span> intersectSet<span class="token punctuation">(</span>keys<span class="token punctuation">(</span>M1<span class="token punctuation">)</span><span class="token punctuation">,</span> keys<span class="token punctuation">(</span>M2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span>K <span class="token punctuation">.</span>Set
  <span class="token comment">//rule mergeMatching(_, _) =&gt; matchFailure      [owsie]</span>
  <span class="token keyword">rule</span> mergeMatching<span class="token punctuation">(</span>matchResult<span class="token punctuation">(</span>_<span class="token punctuation">:</span>Map<span class="token punctuation">)</span><span class="token punctuation">,</span> matchFailure<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> matchFailure
  <span class="token keyword">rule</span> mergeMatching<span class="token punctuation">(</span>matchFailure<span class="token punctuation">,</span> matchResult<span class="token punctuation">(</span>_<span class="token punctuation">:</span>Map<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> matchFailure
  <span class="token keyword">rule</span> mergeMatching<span class="token punctuation">(</span>matchFailure<span class="token punctuation">,</span> matchFailure<span class="token punctuation">)</span>       <span class="token operator">=&gt;</span> matchFailure
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Besides the generic decomposition rules for patterns and values,
we also want to allow <code>[head|tail]</code> matching for lists, so we add
the following custom pattern decomposition rule:</p>
<pre style="position: relative; padding-top: 32px; counter-reset: linenumber 0;" class="line-numbers language-line-numbers" data-start="1"><div class="code-block-selectors">k</div><code class="language-k">  <span class="token keyword">rule</span> getMatching<span class="token punctuation">(</span><span class="token punctuation">[</span>H<span class="token punctuation">:</span>Exp <span class="token operator">|</span> T<span class="token punctuation">:</span>Exp<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>V<span class="token punctuation">:</span>Val<span class="token punctuation">,</span> Vs<span class="token punctuation">:</span>Vals<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> getMatchingAux<span class="token punctuation">(</span><span class="token punctuation">(</span>H<span class="token punctuation">,</span> T<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>V<span class="token punctuation">,</span> <span class="token punctuation">[</span>Vs<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">endmodule</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>Go to <a href="../../2_substitution/fun-untyped/">Lesson 2, FUN untyped, Substitution-Based</a>.</p>
</body></html></div>
        </main>

        <!-- Page ToC -->
        <div class="col-12 col-md-3 col-xl-2 py-md-3 bd-sidebar page-toc mb-3">
          
<div>
<details style="padding:0.25rem 0;;padding-left: 0px;">
            <summary class="bd-toc-link-wrapper">
              <a href="#fun-%E2%80%94-untyped-%E2%80%94-environment" class="bd-toc-link">FUN — Untyped — Environment</a>
              </summary>
            <div>
              <div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#abstract"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Abstract
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#syntax"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Syntax
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#the-syntactic-constructs"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                The Syntactic Constructs
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#additional-priorities"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Additional Priorities
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#desugaring-macros"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Desugaring macros
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#semantics"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Semantics
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#configuration"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Configuration
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#values-and-results"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Values and results
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#lookup"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Lookup
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#arithmetic-expressions"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Arithmetic expressions
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#conditional"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Conditional
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#lists"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Lists
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#data-constructors"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Data Constructors
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#functions-and-closures"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Functions and Closures
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#let-and-letrec"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Let and Letrec
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#references"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                References
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#callcc"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Callcc
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#auxiliary-operations"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Auxiliary operations
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#environment-recovery"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Environment recovery
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#bindto%2C-bind-and-assignto"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                <code>bindTo</code>, <code>bind</code> and <code>assignTo</code>
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#getters"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Getters
              </a></div>
            </div>
          </details>
        
</div>

        </div>
        <div class="btn btn-rv-blue page-toc-toggle-btn"></div>
        <!-- End Page ToC -->
      </div>
    </div>
<!-- The footer is now controlled by the k-web-theme git submodule -->
<footer id="rvsite-footer" class="app-footer text-md-left text-center">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-md-4 mb-md-0 mb-4">
        <a href="https://runtimeverification.com/" target="_blank">
          <picture>
            <source
              srcset="
                https://runtimeverification.com/assets/img/rv-logo-dark.png
              "
              media="(prefers-color-scheme: dark)"
            />
            <img
              class="logo-dark"
              src="https://runtimeverification.com/assets/img/rv-logo.png"
              alt="Runtime Verification logo"
              style="height: 32px"
            /> </picture
        ></a>
        <p class="mt-2 text-md-left copyright">
          <a href="https://maps.app.goo.gl/8YhKozfmZtgzQBsH7" target="_blank"
            >202 S Broadway Ave #31, Urbana, IL</a
          >
        </p>
      </div>
      <div class="col-md-4 text-md-center mb-md-0 mb-4"></div>
      <div class="col-md-4 mb-md-0 mb-4 pl-0 text-md-right">
        <p class="copyright">2025 © all rights reserved</p>
        <span class="copyright"
          ><a href="https://runtimeverification.com/privacy-policy"
            >privacy policy</a
          >
          |
          <a href="https://runtimeverification.com/terms-of-use"
            >terms of use</a
          ></span
        >
      </div>
    </div>
  </div>
</footer>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/Typist/1.2/typist.min.js"></script>
    <script src="../../../../../../../../../assets/js/index.js"></script>
    <script>
      $(function () {
        // Render youtube video
        const anchorElements = document.querySelectorAll(".markdown-preview a");
        for (let i = anchorElements.length - 1; i >= 0; i--) {
          if (anchorElements.length - 1 - i > 3) {
            break;
          }
          const anchorElement = anchorElements[i];
          const href = anchorElement.getAttribute("href");
          if (href.match(/^https?:\/\/youtu.be\//)) {
            const match = href.match(/^https?:\/\/youtu.be\/(.+?)$/);
            if (match && match[1]) {
              const youtubeId = match[1];
              const $iframe = $(`
<div style="text-align:center;">
  <iframe
    width="560"
    height="315"
    src="https://www.youtube.com/embed/${youtubeId}"
    frameborder="0"
    allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
    allowfullscreen
    style="max-width: 100%;"
  ></iframe>
  <p>The video is out of date</p>
</div>
`);
              $(anchorElement).replaceWith($iframe[0]);
            }
          }
        }
      });
    </script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-9LBGDMRG32"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-9LBGDMRG32");
    </script>
  </body>
</html>
